<html>

<head>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
  <link as="style"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    onload="this.rel='stylesheet'" rel="stylesheet" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <title>LURE AD CENTER</title>
  <link href="images/favicon.jpg" rel="icon" type="image/jpeg" />
  <link href="images/favicon.jpg" rel="shortcut icon" type="image/jpeg" />
  <script src="https://cdn.tailwindcss.com"></script>

</head>

<body class="bg-white text-slate-900">

  <!-- è¼‰å…¥å½ˆçª— -->
  <style>
    @keyframes lure-pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.08);
        opacity: 0.85;
      }
    }

    @keyframes lure-spin-ring {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes lure-dot {

      0%,
      80%,
      100% {
        transform: scale(0.6);
        opacity: 0.3;
      }

      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes lure-shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }

    #loadingModal {
      backdrop-filter: blur(4px);
      background: rgba(15, 23, 42, 0.65);
    }

    .lure-card {
      background: rgba(255, 255, 255, 0.97);
      border-radius: 20px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.2);
      padding: 40px 36px 32px;
      max-width: 380px;
      width: calc(100% - 32px);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .lure-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #6366f1, #8b5cf6, #3b82f6);
      background-size: 200% 100%;
      animation: lure-shimmer 2s linear infinite;
    }

    .lure-icon-wrap {
      position: relative;
      width: 72px;
      height: 72px;
      margin: 0 auto 24px;
    }

    .lure-icon-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 3px solid transparent;
      border-top-color: #3b82f6;
      border-right-color: #6366f1;
      animation: lure-spin-ring 1.2s linear infinite;
    }

    .lure-icon-inner {
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      background: linear-gradient(135deg, #dbeafe, #ede9fe);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: lure-pulse 2s ease-in-out infinite;
      font-size: 22px;
    }

    .lure-title {
      font-size: 17px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 6px;
      letter-spacing: -0.3px;
    }

    .lure-subtitle {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 24px;
      min-height: 18px;
      transition: opacity 0.3s;
    }

    .lure-bar-track {
      width: 100%;
      height: 6px;
      background: #e2e8f0;
      border-radius: 99px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .lure-bar-fill {
      height: 100%;
      border-radius: 99px;
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      background-size: 200% 100%;
      animation: lure-shimmer 1.5s linear infinite;
      transition: width 0.4s cubic-bezier(.4, 0, .2, 1);
      width: 0%;
    }

    .lure-pct {
      font-size: 12px;
      font-weight: 600;
      color: #3b82f6;
      letter-spacing: 0.5px;
    }

    .lure-dots {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 20px;
    }

    .lure-dots span {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #3b82f6;
      animation: lure-dot 1.4s ease-in-out infinite;
    }

    .lure-dots span:nth-child(2) {
      animation-delay: 0.2s;
      background: #6366f1;
    }

    .lure-dots span:nth-child(3) {
      animation-delay: 0.4s;
      background: #8b5cf6;
    }
  </style>
  <div id="loadingModal" class="fixed inset-0 flex items-center justify-center z-[60] hidden">
    <div class="lure-card">
      <div class="lure-icon-wrap">
        <div class="lure-icon-ring"></div>
        <div class="lure-icon-inner">ğŸ“Š</div>
      </div>
      <div class="lure-title">LURE AD CENTER</div>
      <p id="loadingText" class="lure-subtitle">æ­£åœ¨è¼‰å…¥å·¥ä½œè¡¨è³‡æ–™</p>
      <div class="lure-bar-track">
        <div id="loadingProgress" class="lure-bar-fill"></div>
      </div>
      <div class="lure-pct" id="loadingProgressText">0%</div>
      <div class="lure-dots">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>




  <!-- æ¯åˆ—é¡è‰²è¨­å®šå½ˆçª— -->
  <div id="rowColorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] hidden">
    <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full mx-2 sm:mx-4 shadow-xl mt-16 sm:mt-0">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">è¨­å®šé¡è‰²é–¾å€¼</h3>
        <button onclick="closeRowColorModal()" class="text-gray-400 hover:text-gray-600 p-1">
          <span class="material-symbols-outlined text-xl">close</span>
        </button>
      </div>

      <div class="mb-4">
        <p class="text-sm text-gray-600 mb-3" id="rowColorModalTitle">ç‚ºæ­¤åˆ—è¨­å®šå°ˆå±¬çš„é¡è‰²é–¾å€¼</p>

        <div class="bg-gray-50 rounded-lg p-3">
          <div class="flex items-center justify-between mb-3">
            <h5 class="text-sm font-medium text-gray-700" id="rowColorTypeTitle">ç§è¨Šæˆæœ¬æ¨™ç¤º</h5>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="rowColorEnabled"
                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="text-sm text-gray-600">å•Ÿç”¨</span>
            </label>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">ç¶ è‰² (å°æ–¼)</label>
              <input type="number" id="rowColorGreen"
                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                step="0.1">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">ç´…è‰² (å¤§æ–¼)</label>
              <input type="number" id="rowColorRed"
                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                step="0.1">
            </div>
          </div>
          <div class="mt-2 text-xs text-gray-500">
            <span class="inline-block w-3 h-3 bg-green-100 border border-green-300 rounded mr-1"></span>ç¶ è‰²ï¼šå°æ–¼è¨­å®šå€¼
            <span class="inline-block w-3 h-3 bg-orange-100 border border-orange-300 rounded mx-2"></span>æ©˜è‰²ï¼šä»‹æ–¼ä¸­é–“
            <span class="inline-block w-3 h-3 bg-red-100 border border-red-300 rounded mr-1"></span>ç´…è‰²ï¼šå¤§æ–¼è¨­å®šå€¼
          </div>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200">
        <button onclick="closeRowColorModal()"
          class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors order-2 sm:order-1">
          å–æ¶ˆ
        </button>
        <button onclick="saveRowColorSettings()"
          class="px-4 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors order-1 sm:order-2">
          å„²å­˜è¨­å®š
        </button>
      </div>
    </div>
  </div>

  <!-- è¨­å®šå½ˆçª— -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
    <div
      class="bg-white rounded-lg p-3 sm:p-6 max-w-6xl w-full mx-2 sm:mx-4 shadow-xl max-h-[90vh] sm:max-h-[80vh] overflow-hidden flex flex-col mt-16 sm:mt-0">
      <div class="flex items-center justify-between mb-3 sm:mb-6">
        <h3 class="text-base sm:text-xl font-semibold text-gray-900">ç³»çµ±è¨­å®š</h3>
        <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 p-1">
          <span class="material-symbols-outlined text-lg sm:text-2xl">close</span>
        </button>
      </div>

      <!-- æ‰‹æ©Ÿç‰ˆï¼šå‚ç›´ä½ˆå±€ -->
      <div class="flex-1 flex flex-col sm:flex-row gap-3 sm:gap-4 min-h-0">
        <!-- æ‰‹æ©Ÿç‰ˆæ¨™ç±¤é ï¼šæ°´å¹³æ’åˆ— -->
        <div class="sm:w-48 sm:flex-shrink-0">
          <nav class="flex sm:flex-col gap-1 sm:space-y-1 sm:gap-0">
            <button onclick="switchSettingsTab('sheets')" id="sheets-tab"
              class="flex-1 sm:w-full text-left px-2 sm:px-3 py-2 text-xs sm:text-sm font-medium rounded-md bg-blue-100 text-blue-700 border-b-2 sm:border-b-0 sm:border-r-2 border-blue-600">
              <div class="flex items-center justify-center sm:justify-start gap-1 sm:gap-2">
                <span class="material-symbols-outlined text-sm">table_chart</span>
                <span class="hidden sm:inline">å·¥ä½œè¡¨é…ç½®</span>
                <span class="sm:hidden">å·¥ä½œè¡¨</span>
              </div>
            </button>
            <button onclick="switchSettingsTab('colors')" id="colors-tab"
              class="flex-1 sm:w-full text-left px-2 sm:px-3 py-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-50">
              <div class="flex items-center justify-center sm:justify-start gap-1 sm:gap-2">
                <span class="material-symbols-outlined text-sm">palette</span>
                <span class="hidden sm:inline">é¡è‰²æ¨™ç¤º</span>
                <span class="sm:hidden">é¡è‰²</span>
              </div>
            </button>
          </nav>
        </div>

        <!-- å³å´å…§å®¹å€åŸŸ -->
        <div class="flex-1 flex flex-col min-h-0">
          <!-- å·¥ä½œè¡¨é…ç½®å…§å®¹ -->
          <div id="sheets-content" class="flex-1 flex flex-col min-h-0">
            <div
              class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0 mb-3 sm:mb-4 flex-shrink-0">
              <h4 class="text-sm sm:text-lg font-medium text-gray-800">å·¥ä½œè¡¨é…ç½®</h4>
              <button onclick="addNewSheet()"
                class="flex items-center justify-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors">
                <span class="material-symbols-outlined text-sm">add</span>
                <span class="hidden sm:inline">æ–°å¢å·¥ä½œè¡¨</span>
                <span class="sm:hidden">æ–°å¢</span>
              </button>
            </div>

            <div id="sheetConfigList" class="flex-1 overflow-y-auto space-y-2 sm:space-y-3 pr-1 sm:pr-2"
              style="max-height: calc(100vh - 280px);">
              <!-- å·¥ä½œè¡¨é…ç½®é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>
          </div>

          <!-- é¡è‰²æ¨™ç¤ºè¨­å®šå…§å®¹ -->
          <div id="colors-content" class="flex-1 flex flex-col min-h-0 hidden">
            <h4 class="text-sm sm:text-lg font-medium text-gray-800 mb-3 sm:mb-4 flex-shrink-0">é¡è‰²æ¨™ç¤ºè¨­å®š</h4>

            <div class="flex-1 overflow-y-auto pr-1 sm:pr-2" style="max-height: calc(100vh - 280px);">
              <!-- ç§è¨Šæˆæœ¬è¨­å®š -->
              <div class="bg-gray-50 rounded-lg p-3 sm:p-4 mb-3 sm:mb-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0 mb-3">
                  <h5 class="text-xs sm:text-sm font-medium text-gray-700">ç§è¨Šæˆæœ¬æ¨™ç¤º</h5>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" id="enableMessageCostColor"
                      class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="text-xs sm:text-sm text-gray-600">å•Ÿç”¨</span>
                  </label>
                </div>
                <div class="grid grid-cols-2 gap-2 sm:gap-3">
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">ç¶ è‰² (å°æ–¼)</label>
                    <input type="number" id="messageCostGreen"
                      class="w-full px-2 py-1.5 sm:py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                      placeholder="0" step="0.1">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">ç´…è‰² (å¤§æ–¼)</label>
                    <input type="number" id="messageCostRed"
                      class="w-full px-2 py-1.5 sm:py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                      placeholder="100" step="0.1">
                  </div>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                  <span class="inline-block w-3 h-3 bg-green-100 border border-green-300 rounded mr-1"></span>ç¶ è‰²ï¼šå°æ–¼è¨­å®šå€¼
                  <span
                    class="inline-block w-3 h-3 bg-orange-100 border border-orange-300 rounded mx-1 sm:mx-2"></span>æ©˜è‰²ï¼šä»‹æ–¼ä¸­é–“
                  <span class="inline-block w-3 h-3 bg-red-100 border border-red-300 rounded mr-1"></span>ç´…è‰²ï¼šå¤§æ–¼è¨­å®šå€¼
                </div>
              </div>

              <!-- é»æ“Šæˆæœ¬è¨­å®š -->
              <div class="bg-gray-50 rounded-lg p-3 sm:p-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0 mb-3">
                  <h5 class="text-xs sm:text-sm font-medium text-gray-700">é»æ“Šæˆæœ¬æ¨™ç¤º</h5>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" id="enableClickCostColor"
                      class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="text-xs sm:text-sm text-gray-600">å•Ÿç”¨</span>
                  </label>
                </div>
                <div class="grid grid-cols-2 gap-2 sm:gap-3">
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">ç¶ è‰² (å°æ–¼)</label>
                    <input type="number" id="clickCostGreen"
                      class="w-full px-2 py-1.5 sm:py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                      placeholder="0" step="0.1">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">ç´…è‰² (å¤§æ–¼)</label>
                    <input type="number" id="clickCostRed"
                      class="w-full px-2 py-1.5 sm:py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                      placeholder="10" step="0.1">
                  </div>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                  <span class="inline-block w-3 h-3 bg-green-100 border border-green-300 rounded mr-1"></span>ç¶ è‰²ï¼šå°æ–¼è¨­å®šå€¼
                  <span
                    class="inline-block w-3 h-3 bg-orange-100 border border-orange-300 rounded mx-1 sm:mx-2"></span>æ©˜è‰²ï¼šä»‹æ–¼ä¸­é–“
                  <span class="inline-block w-3 h-3 bg-red-100 border border-red-300 rounded mr-1"></span>ç´…è‰²ï¼šå¤§æ–¼è¨­å®šå€¼
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-3 pt-3 sm:pt-4 border-t border-gray-200 mt-3 sm:mt-4">
        <button onclick="closeSettingsModal()"
          class="px-3 sm:px-4 py-2 text-xs sm:text-sm text-gray-600 hover:text-gray-800 transition-colors order-2 sm:order-1">
          å–æ¶ˆ
        </button>
        <button onclick="saveSheetConfig()"
          class="px-3 sm:px-4 py-2 text-xs sm:text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors order-1 sm:order-2">
          å„²å­˜è¨­å®š
        </button>
      </div>
    </div>
  </div>

  <div class="relative flex h-auto min-h-screen w-full flex-col bg-white group/design-root overflow-x-hidden"
    style='font-family: Inter, "Noto Sans", sans-serif;'>
    <div class="layout-container flex h-full grow flex-col">
      <header
        class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-solid border-slate-200 px-4 sm:px-6 lg:px-10 py-3 bg-white">
        <div class="flex items-center gap-2 sm:gap-4 lg:gap-8">
          <div class="flex items-center gap-2 sm:gap-4 text-slate-900">
            <h2 class="text-slate-900 text-lg sm:text-xl font-bold leading-tight tracking-[-0.015em]">LURE AD CENTER
            </h2>
          </div>
        </div>
        <div class="flex items-center gap-2 sm:gap-4">
          <div class="text-xs text-slate-500 font-mono hidden sm:block" id="version-display">v20250915170325</div>
          <button id="refresh-btn" onclick="refreshData()"
            class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-md transition-colors"
            title="é‡æ–°è¼‰å…¥è³‡æ–™">
            <span id="refresh-icon" class="material-symbols-outlined text-base sm:text-lg">refresh</span>
          </button>
          <button onclick="openSettingsModal()"
            class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-md transition-colors"
            title="è¨­å®š">
            <span class="material-symbols-outlined text-base sm:text-lg">settings</span>
          </button>
        </div>
      </header>
      <main class="flex flex-1 justify-center py-8 px-4 sm:px-6 lg:px-8 pt-24">
        <div class="layout-content-container flex flex-col w-full max-w-7xl">
          <div class="flex flex-col gap-4">
            <div class="flex flex-col lg:flex-row gap-4 lg:gap-6">
              <div class="w-full lg:w-80 lg:shrink-0 space-y-4 lg:sticky lg:top-24 lg:self-start">
                <!-- ç¸½è¨ˆå¡ç‰‡ -->
                <div class="rounded-md border border-slate-200 bg-slate-50">
                  <div class="px-3 py-2 border-b border-slate-200">
                    <p class="text-slate-700 text-xs font-medium">ç¸½è¨ˆ</p>
                  </div>
                  <div class="px-3 py-2">
                    <div class="grid grid-cols-2 lg:block lg:space-y-3 gap-3 text-xs">
                      <div class="flex items-center lg:flex-row">
                        <div class="text-slate-500 w-16 lg:w-20 text-xs lg:text-xs">å¸³è™Ÿæ•¸é‡</div>
                        <div class="text-base lg:text-lg font-bold text-gray-800" id="total-accounts">-</div>
                      </div>
                      <div class="flex items-center lg:flex-row">
                        <div class="text-slate-500 w-16 lg:w-20 text-xs lg:text-xs">ç¸½èŠ±è²»</div>
                        <div class="text-base lg:text-lg font-bold text-gray-800" id="all-total-spend">-</div>
                      </div>
                      <div class="flex items-center lg:flex-row">
                        <div class="text-slate-500 w-16 lg:w-20 text-xs lg:text-xs">%</div>
                        <div class="text-base lg:text-lg font-bold text-gray-800" id="all-total-percentage">-</div>
                      </div>
                      <div class="flex items-center lg:flex-row">
                        <div class="text-slate-500 w-16 lg:w-20 text-xs lg:text-xs">ç¸½èŠ±è²»+%</div>
                        <div class="text-base lg:text-lg font-bold text-gray-800" id="all-total-spend-plus">-</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- å»£å‘Šå¸³è™Ÿå¡ç‰‡ -->
                <div class="rounded-md border border-slate-200 bg-white">
                  <div class="px-3 py-2 bg-slate-50 border-b border-slate-200">
                    <p class="text-slate-700 text-xs font-medium">å»£å‘Šå¸³è™Ÿ</p>
                    <div class="grid grid-cols-4 gap-1 sm:gap-2 mt-1 text-xs text-slate-500">
                      <span class="truncate">åç¨±</span>
                      <span class="text-right">æ•¸é‡</span>
                      <span class="text-right">èŠ±è²»</span>
                      <span class="text-right">èŠ±è²»+%</span>
                    </div>
                  </div>
                  <nav id="sheet-tabs"
                    class="flex flex-col divide-y divide-slate-200 max-h-[40vh] sm:max-h-none overflow-y-auto"
                    aria-label="Sheets"></nav>
                </div>
              </div>
              <div class="flex-1">
                <div id="status" class="mb-3 text-sm text-slate-500">è¼‰å…¥ä¸­...</div>

                <!-- å„€è¡¨æ¿çµ±è¨ˆ -->
                <div class="mb-6 bg-white rounded-lg border border-gray-200 p-3 sm:p-4">
                  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4">
                    <div class="text-center">
                      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="total-spend">-</div>
                      <div class="text-xs sm:text-sm text-gray-500">ç¸½èŠ±è²»</div>
                    </div>
                    <div class="text-center">
                      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="total-spend-plus">-</div>
                      <div class="text-xs sm:text-sm text-gray-500">ç¸½èŠ±è²»+%</div>
                    </div>
                    <div class="text-center">
                      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="avg-clicks">-</div>
                      <div class="text-xs sm:text-sm text-gray-500">å¹³å‡é»æ“Šæ¬¡æ•¸</div>
                    </div>
                    <div class="text-center">
                      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="avg-cpc">-</div>
                      <div class="text-xs sm:text-sm text-gray-500">å¹³å‡é»æ“Šæˆæœ¬</div>
                    </div>
                    <div class="text-center">
                      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="avg-messages">-</div>
                      <div class="text-xs sm:text-sm text-gray-500">å¹³å‡ç§è¨Šæ•¸</div>
                    </div>
                    <div class="text-center">
                      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="avg-message-cost">-</div>
                      <div class="text-xs sm:text-sm text-gray-500">å¹³å‡ç§è¨Šæˆæœ¬</div>
                    </div>
                  </div>
                </div>

                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-3">
                  <label class="relative flex-col min-w-0 flex-1 sm:min-w-40 sm:max-w-64">
                    <div class="flex w-full flex-1 items-stretch rounded-md h-8 sm:h-8">
                      <div
                        class="text-slate-400 flex border-none bg-slate-100 items-center justify-center pl-2 rounded-l-md border-r-0">
                        <span class="material-symbols-outlined text-sm">search</span>
                      </div>
                      <input id="search-input"
                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-md text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 border-none bg-slate-100 h-full placeholder:text-slate-400 px-3 rounded-l-none border-l-0 pl-2 text-xs font-normal leading-normal"
                        placeholder="æœå°‹æ´»å‹•åç¨±" value="" />
                    </div>
                  </label>
                  <div class="flex items-center justify-between sm:justify-end gap-3">
                    <div id="table-info" class="text-xs text-slate-500 italic font-light flex-1 sm:flex-none"></div>
                    <button id="download-btn" onclick="downloadTableData()"
                      class="flex items-center gap-1 px-3 py-1.5 text-xs bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors whitespace-nowrap">
                      <span class="material-symbols-outlined text-sm">download</span>
                      <span class="hidden sm:inline">ä¸‹è¼‰è³‡æ–™</span>
                      <span class="sm:hidden">ä¸‹è¼‰</span>
                    </button>
                  </div>
                </div>
                <div class="overflow-x-auto rounded-md border border-slate-200 bg-white">
                  <table id="main-table" class="w-full text-left min-w-[800px]"></table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      <script>


        (function () {
          // Google Sheets åŸºç¤é€£çµå’Œå¸¸è¦‹çš„å·¥ä½œè¡¨ GID
          const SHEETS_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSImKWK9cURUKloCFw3mr759Id_QfTSHmd1_8DJrihHr8bichEC3ZeoYaHrxmLkLaPSfCkPsLnoka4c/pub?output=csv';

          // æ‰€æœ‰å·¥ä½œè¡¨çš„ GID é…ç½®
          const ADDITIONAL_SHEET_GIDS = [
            { name: 'å¸å¼•åŠ›', gid: '1731918377' },
            { name: 'å¯°å®‡', gid: '186693734' },
            { name: 'è—è’‚è”»', gid: '678515244' },
            { name: 'æ–°æŠ€', gid: '1515508175' },
            { name: 'ç¸½éƒ¨', gid: '2076528666' },
            { name: 'æ–°åŸå€', gid: '1314685146' },
            { name: 'ç¬¬ä¸€äº‹æ¥­éƒ¨', gid: '2003263441' },
            { name: 'ç¬¬äºŒäº‹æ¥­éƒ¨', gid: '169051770' },
            { name: 'ç¬¬ä¸‰äº‹æ¥­éƒ¨', gid: '1585941268' },
            { name: 'ç¬¬å››äº‹æ¥­éƒ¨', gid: '1841114498' },
            { name: 'å…¶ä»–å€éƒ¨', gid: '2032331650' },
            { name: 'é¡å€', gid: '605760610' },
            { name: 'å¤§é‡Œå€', gid: '321162073' },
            { name: 'é€¢ç”²å€', gid: '2039681828' },
            { name: 'åŸºéš†å€', gid: '1871669787' }
          ];

          const tabsContainer = document.getElementById('sheet-tabs');
          const statusEl = document.getElementById('status');
          const tableInfoEl = document.getElementById('table-info');
          const mainTable = document.getElementById('main-table');
          const searchInput = document.getElementById('search-input');

          // å„€è¡¨æ¿å…ƒç´ 
          const totalSpendEl = document.getElementById('total-spend');
          const totalSpendPlusEl = document.getElementById('total-spend-plus');
          const avgClicksEl = document.getElementById('avg-clicks');
          const avgCpcEl = document.getElementById('avg-cpc');
          const avgMessagesEl = document.getElementById('avg-messages');
          const avgMessageCostEl = document.getElementById('avg-message-cost');

          // ç¸½è¨ˆå¡ç‰‡å…ƒç´ 
          const totalAccountsEl = document.getElementById('total-accounts');
          const allTotalSpendEl = document.getElementById('all-total-spend');
          const allTotalPercentageEl = document.getElementById('all-total-percentage');
          const allTotalSpendPlusEl = document.getElementById('all-total-spend-plus');

          let workbookCache = null;
          let originalData = [];

          // å„²å­˜ç™¾åˆ†æ¯”æ•¸æ“šçš„ç‰©ä»¶ï¼Œçµæ§‹ï¼š{ sheetName: { rowId: percentage } }
          let percentageStorage = {};

          // å„²å­˜æš±ç¨±æ•¸æ“šçš„ç‰©ä»¶ï¼Œçµæ§‹ï¼š{ sheetName: { originalName: nickname } }
          let nicknameStorage = {};

          // å„²å­˜é¡è‰²é–¾å€¼è¨­å®šï¼ˆå…¨åŸŸé è¨­å€¼ï¼‰
          let colorThresholds = {
            messageCost: {
              enabled: false,
              green: 0,
              red: 100
            },
            clickCost: {
              enabled: false,
              green: 0,
              red: 10
            }
          };

          // å„²å­˜æ¯åˆ—çš„é¡è‰²é–¾å€¼è¨­å®šï¼Œçµæ§‹ï¼š{ sheetName: { rowId: { messageCost: {...}, clickCost: {...} } } }
          let rowColorThresholds = {};

          function setStatus(message, isError) {
            if (!statusEl) return;
            statusEl.textContent = message || '';
            statusEl.className = 'mb-3 text-sm ' + (isError ? 'text-red-600' : 'text-slate-500');
          }

          // è¼‰å…¥é€²åº¦ç›¸é—œå‡½å¼
          function showLoadingModal() {
            const modal = document.getElementById('loadingModal');
            if (modal) {
              modal.classList.remove('hidden');
            }
          }

          function hideLoadingModal() {
            const modal = document.getElementById('loadingModal');
            if (modal) {
              modal.classList.add('hidden');
            }
          }

          function updateLoadingProgress(percentage, text) {
            const progressBar = document.getElementById('loadingProgress');
            const progressText = document.getElementById('loadingProgressText');
            const loadingText = document.getElementById('loadingText');

            if (progressBar) {
              progressBar.style.width = percentage + '%';
            }
            if (progressText) {
              progressText.textContent = Math.round(percentage) + '%';
            }
            if (loadingText && text) {
              loadingText.textContent = text;
            }
          }

          function escapeHtml(value) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(value == null ? '' : value).replace(/[&<>"']/g, (m) => map[m]);
          }

          function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];

            for (let line of lines) {
              if (line.trim() === '') continue;

              const row = [];
              let inQuotes = false;
              let currentField = '';

              for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                  if (inQuotes && nextChar === '"') {
                    // è™•ç†é›™å¼•è™Ÿè½‰ç¾©
                    currentField += '"';
                    i++; // è·³éä¸‹ä¸€å€‹å¼•è™Ÿ
                  } else {
                    // åˆ‡æ›å¼•è™Ÿç‹€æ…‹
                    inQuotes = !inQuotes;
                  }
                } else if (char === ',' && !inQuotes) {
                  // æ¬„ä½åˆ†éš”ç¬¦
                  row.push(currentField.trim());
                  currentField = '';
                } else {
                  currentField += char;
                }
              }

              // æ·»åŠ æœ€å¾Œä¸€å€‹æ¬„ä½
              row.push(currentField.trim());
              result.push(row);
            }

            return result;
          }

          async function fetchSheetCSV(gid = null) {
            const url = gid ? `${SHEETS_BASE_URL}&gid=${gid}` : SHEETS_BASE_URL;
            try {
              const resp = await fetch(url, { mode: 'cors' });
              if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
              return await resp.text();
            } catch (e) {
              console.warn(`ç„¡æ³•è¼‰å…¥å·¥ä½œè¡¨ (gid=${gid}):`, e.message);
              return null;
            }
          }

          function isValidValue(value) {
            // æª¢æŸ¥å€¼æ˜¯å¦ç‚ºæœ‰æ•ˆçš„éç©ºæ•¸å€¼
            if (!value || value === '' || value === '-' || value === 'null' || value === 'undefined') {
              return false;
            }
            // ç§»é™¤é€—è™Ÿå’Œè²¨å¹£ç¬¦è™Ÿå¾Œæª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å­—
            const cleaned = String(value).replace(/[,$]/g, '');
            const num = parseFloat(cleaned);
            return !isNaN(num) && num >= 0; // å…è¨± 0 å€¼ï¼Œä½†ä¸å…è¨±è² æ•¸
          }

          function updateDashboard() {
            // ç›´æ¥å¾è¡¨æ ¼ DOM ä¸­è®€å–æ•¸æ“šé€²è¡Œè¨ˆç®—
            const tableRows = mainTable.querySelectorAll('tbody tr');

            if (!tableRows || tableRows.length === 0) {
              // é‡ç½®å„€è¡¨æ¿
              if (totalSpendEl) totalSpendEl.textContent = '-';
              if (totalSpendPlusEl) totalSpendPlusEl.textContent = '-';
              if (avgClicksEl) avgClicksEl.textContent = '-';
              if (avgCpcEl) avgCpcEl.textContent = '-';
              if (avgMessagesEl) avgMessagesEl.textContent = '-';
              if (avgMessageCostEl) avgMessageCostEl.textContent = '-';
              return;
            }

            // æ‰¾åˆ°è¡¨é ­ä¸­å„æ¬„ä½çš„ä½ç½®
            const headerCells = mainTable.querySelectorAll('thead th');
            let spendIndex = -1, clicksIndex = -1, messagesIndex = -1, messageCostIndex = -1;

            headerCells.forEach((th, index) => {
              const headerText = th.textContent.trim();
              if (headerText.includes('èŠ±è²»é‡‘é¡')) spendIndex = index;
              if (headerText.includes('é€£çµé»æ“Šæ¬¡æ•¸')) clicksIndex = index;
              if (headerText.includes('ç§è¨Šæ•¸') && !headerText.includes('æˆæœ¬')) messagesIndex = index;
              if (headerText.includes('ç§è¨Šæˆæœ¬')) messageCostIndex = index;
            });

            let totalSpend = 0;
            let totalSpendPlus = 0;  // ç¸½èŠ±è²»+%
            let totalClicks = 0;
            let totalMessages = 0;
            let totalMessageCost = 0;

            // åˆ†åˆ¥è¨ˆç®—å„æ¬„ä½çš„æœ‰æ•ˆè¡Œæ•¸
            let validSpendRows = 0;
            let validClicksRows = 0;
            let validMessagesRows = 0;
            let validMessageCostRows = 0;

            // éæ­·æ¯ä¸€è¡Œæ•¸æ“š
            tableRows.forEach(row => {
              const cells = row.querySelectorAll('td');
              if (cells.length === 0) return;

              // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ•¸æ“šè¡Œï¼ˆç¬¬ä¸€æ¬„ä¸ç‚ºç©ºï¼‰
              const firstCell = cells[0]?.textContent.trim();
              if (!firstCell) return;

              // è¨ˆç®—ç¸½èŠ±è²»ï¼ˆåªè¨ˆç®—æœ‰å€¼çš„è¡Œï¼‰
              if (spendIndex >= 0 && cells[spendIndex]) {
                const spendText = cells[spendIndex].textContent.trim();
                if (isValidValue(spendText)) {
                  const spend = parseFloat(spendText.replace(/[,$]/g, ''));
                  if (!isNaN(spend) && spend >= 0) {
                    totalSpend += spend;
                    validSpendRows++;
                  }
                }
              }

              // ç›´æ¥å¾è¡¨æ ¼ä¸­è®€å–ã€Œé‡‘é¡+%ã€æ¬„ä½çš„å€¼é€²è¡Œåˆè¨ˆ
              const calculatedAmountCell = row.querySelector('.calculated-amount');
              if (calculatedAmountCell) {
                const calculatedText = calculatedAmountCell.textContent.trim();
                if (calculatedText && calculatedText !== '-') {
                  // å¦‚æœæœ‰è¨ˆç®—å¾Œçš„é‡‘é¡ï¼Œä½¿ç”¨è©²å€¼
                  const calculatedAmount = parseFloat(calculatedText.replace(/[,$]/g, '')) || 0;
                  if (!isNaN(calculatedAmount) && calculatedAmount > 0) {
                    totalSpendPlus += calculatedAmount;
                  }
                } else {
                  // å¦‚æœã€Œé‡‘é¡+%ã€é¡¯ç¤º "-"ï¼Œå‰‡ä½¿ç”¨åŸå§‹èŠ±è²»é‡‘é¡
                  if (spendIndex >= 0 && cells[spendIndex]) {
                    const spendText = cells[spendIndex].textContent.trim();
                    if (isValidValue(spendText)) {
                      const spend = parseFloat(spendText.replace(/[,$]/g, ''));
                      if (!isNaN(spend) && spend >= 0) {
                        totalSpendPlus += spend;
                      }
                    }
                  }
                }
              }

              // è¨ˆç®—ç¸½é»æ“Šæ¬¡æ•¸ï¼ˆåªè¨ˆç®—æœ‰å€¼çš„è¡Œï¼‰
              if (clicksIndex >= 0 && cells[clicksIndex]) {
                const clicksText = cells[clicksIndex].textContent.trim();
                if (isValidValue(clicksText)) {
                  const clicks = parseFloat(clicksText.replace(/[,$]/g, ''));
                  if (!isNaN(clicks) && clicks >= 0) {
                    totalClicks += clicks;
                    validClicksRows++;
                  }
                }
              }

              // è¨ˆç®—ç¸½ç§è¨Šæ•¸ï¼ˆåªè¨ˆç®—æœ‰å€¼çš„è¡Œï¼‰
              if (messagesIndex >= 0 && cells[messagesIndex]) {
                const messagesText = cells[messagesIndex].textContent.trim();
                if (isValidValue(messagesText)) {
                  const messages = parseFloat(messagesText.replace(/[,$]/g, ''));
                  if (!isNaN(messages) && messages >= 0) {
                    totalMessages += messages;
                    validMessagesRows++;
                  }
                }
              }

              // è¨ˆç®—ç¸½ç§è¨Šæˆæœ¬ï¼ˆåªè¨ˆç®—æœ‰å€¼çš„è¡Œï¼‰
              if (messageCostIndex >= 0 && cells[messageCostIndex]) {
                const messageCostText = cells[messageCostIndex].textContent.trim();
                if (isValidValue(messageCostText)) {
                  const messageCost = parseFloat(messageCostText.replace(/[,$]/g, ''));
                  if (!isNaN(messageCost) && messageCost >= 0) {
                    totalMessageCost += messageCost;
                    validMessageCostRows++;
                  }
                }
              }
            });

            // æ›´æ–°å„€è¡¨æ¿
            if (totalSpendEl) {
              totalSpendEl.textContent = totalSpend > 0 ? totalSpend.toLocaleString() : '-';
            }

            if (totalSpendPlusEl) {
              totalSpendPlusEl.textContent = totalSpendPlus > 0 ? totalSpendPlus.toLocaleString() : '-';
            }

            if (avgClicksEl) {
              const avgClicks = validClicksRows > 0 ? Math.round(totalClicks / validClicksRows) : 0;
              avgClicksEl.textContent = avgClicks > 0 ? avgClicks.toLocaleString() : '-';
            }

            if (avgCpcEl) {
              // è¨ˆç®—å¹³å‡é»æ“Šæˆæœ¬ï¼šç›´æ¥å¾æ¯è¡Œçš„é»æ“Šæˆæœ¬æ¬„ä½è¨ˆç®—å¹³å‡å€¼
              let totalCpc = 0;
              let validCpcRows = 0;

              tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;

                // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ•¸æ“šè¡Œï¼ˆç¬¬ä¸€æ¬„ä¸ç‚ºç©ºï¼‰
                const firstCell = cells[0]?.textContent.trim();
                if (!firstCell) return;

                // æ‰¾åˆ°é»æ“Šæˆæœ¬æ¬„ä½ï¼ˆCPCï¼‰
                let cpcIndex = -1;
                const headerCells = mainTable.querySelectorAll('thead th');
                headerCells.forEach((th, index) => {
                  const headerText = th.textContent.trim();
                  if (headerText.includes('é»æ“Šæˆæœ¬') || headerText.includes('CPC')) {
                    cpcIndex = index;
                  }
                });

                // å¦‚æœæ‰¾åˆ°é»æ“Šæˆæœ¬æ¬„ä½ï¼Œè¨ˆç®—è©²è¡Œçš„é»æ“Šæˆæœ¬
                if (cpcIndex >= 0 && cells[cpcIndex]) {
                  const cpcText = cells[cpcIndex].textContent.trim();
                  if (isValidValue(cpcText)) {
                    const cpc = parseFloat(cpcText.replace(/[,$]/g, ''));
                    if (!isNaN(cpc) && cpc >= 0) {
                      totalCpc += cpc;
                      validCpcRows++;
                    }
                  }
                }
              });

              const avgCpc = validCpcRows > 0 ? (totalCpc / validCpcRows) : 0;
              avgCpcEl.textContent = avgCpc > 0 ? avgCpc.toFixed(1) : '-';
            }

            if (avgMessagesEl) {
              const avgMessages = validMessagesRows > 0 ? (totalMessages / validMessagesRows) : 0;
              avgMessagesEl.textContent = avgMessages > 0 ? avgMessages.toFixed(1) : '-';
            }

            if (avgMessageCostEl) {
              const avgMessageCost = validMessageCostRows > 0 ? (totalMessageCost / validMessageCostRows) : 0;
              avgMessageCostEl.textContent = avgMessageCost > 0 ? avgMessageCost.toFixed(1) : '-';
            }
          }

          function trimEmptyEdges(matrix) {
            if (!matrix || !matrix.length) return matrix;

            // æ‰¾åˆ°æœ€å¾Œä¸€å€‹éç©ºæ¬„ä½
            let lastNonEmptyCol = -1;
            for (let c = 0; c < matrix[0].length; c++) {
              let any = false;
              for (let r = 0; r < matrix.length; r++) {
                const v = (matrix[r][c] ?? '').toString().trim();
                if (v !== '') { any = true; break; }
              }
              if (any) lastNonEmptyCol = c;
            }

            // ä¿ç•™æ‰€æœ‰æ¬„ä½ï¼Œä¸è¦æˆªæ–·ï¼ˆé™¤éçœŸçš„å®Œå…¨ç‚ºç©ºï¼‰
            // åªç§»é™¤å®Œå…¨ç©ºç™½çš„è¡Œ
            while (matrix.length && matrix[matrix.length - 1].every((v) => String(v || '').trim() === '')) {
              matrix.pop();
            }

            return matrix;
          }

          let currentSort = { column: -1, ascending: true };
          let currentData = [];

          function buildTableHtml(matrix) {
            if (!matrix || matrix.length === 0 || (matrix[0] || []).every((v) => String(v || '').trim() === '')) {
              if (tableInfoEl) tableInfoEl.textContent = '';
              return '<tbody><tr><td class="px-2 py-1.5 text-slate-500 text-xs">ç„¡è³‡æ–™</td></tr></tbody>';
            }

            // ä¸å†è™•ç†è³‡è¨Šè¡Œï¼Œå› ç‚ºå·²ç¶“åœ¨ renderTable ä¸­ç§»é™¤äº†
            let actualMatrix = matrix;

            // èª¿è©¦è³‡è¨Šï¼šé¡¯ç¤ºè³‡æ–™çµæ§‹
            console.log('è¡¨æ ¼è³‡æ–™çµæ§‹:', {
              totalRows: actualMatrix.length,
              firstRowColumns: actualMatrix[0] ? actualMatrix[0].length : 0,
              firstRowData: actualMatrix[0],
              sampleDataRow: actualMatrix[1] || 'ç„¡è³‡æ–™è¡Œ'
            });

            // æ¸…ç©ºè³‡è¨Šæ–‡å­—
            if (tableInfoEl) {
              tableInfoEl.textContent = '';
            }

            if (actualMatrix.length === 0) {
              return '<tbody><tr><td class="px-2 py-1.5 text-slate-500 text-xs">ç„¡è³‡æ–™</td></tr></tbody>';
            }

            currentData = actualMatrix;

            // æ±ºå®šä½¿ç”¨å“ªå€‹è¡¨é ­å’Œè³‡æ–™
            let header, body;

            // æª¢æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ç‚ºæ­£ç¢ºçš„è¡¨é ­
            const firstRow = actualMatrix[0];
            const isValidHeader = firstRow && (
              String(firstRow[0]).includes('æ´»å‹•åç¨±') ||
              String(firstRow[0]).trim() === 'æ´»å‹•åç¨±' ||
              String(firstRow[0]).includes('Campaign name')
            );

            let originalHeader, originalBody;
            if (isValidHeader) {
              // ç¬¬ä¸€è¡Œæ˜¯æ­£ç¢ºçš„è¡¨é ­ï¼Œä½†é‡æ–°æ’åˆ—æ¬„ä½é †åº
              const headerMapping = {};
              firstRow.forEach((cell, index) => {
                const cellStr = String(cell || '').trim();
                // çµ±ä¸€è¡¨é ­åç¨±ä¸¦è¨˜éŒ„ç´¢å¼•
                if (cellStr === 'Campaign name' || cellStr === 'æ´»å‹•åç¨±') headerMapping['æ´»å‹•åç¨±'] = index;
                if (cellStr === 'Reporting starts' || cellStr === 'å ±å‘Šèµ·å§‹') headerMapping['å ±å‘Šèµ·å§‹'] = index;
                if (cellStr === 'Reporting ends' || cellStr === 'å ±å‘ŠçµæŸ') headerMapping['å ±å‘ŠçµæŸ'] = index;
                if (cellStr === 'Amount spent' || cellStr === 'èŠ±è²»é‡‘é¡') headerMapping['èŠ±è²»é‡‘é¡'] = index;
                if (cellStr === 'Link clicks' || cellStr === 'é€£çµé»æ“Šæ¬¡æ•¸') headerMapping['é€£çµé»æ“Šæ¬¡æ•¸'] = index;
                if (cellStr === 'CPC (cost per link click)' || cellStr === 'é»æ“Šæˆæœ¬') headerMapping['é»æ“Šæˆæœ¬'] = index;
                if (cellStr === 'Messaging conversations started' || cellStr === 'ç§è¨Šæ•¸') headerMapping['ç§è¨Šæ•¸'] = index;
                if (cellStr === 'Cost per messaging conversations started' || cellStr === 'ç§è¨Šæˆæœ¬') headerMapping['ç§è¨Šæˆæœ¬'] = index;
              });

              // æŒ‰ç…§æŒ‡å®šé †åºé‡æ–°æ’åˆ—è¡¨é ­ï¼Œåœ¨èŠ±è²»é‡‘é¡å¾Œæ’å…¥ % å’Œ é‡‘é¡+% æ¬„ä½
              const orderedHeaders = ['æ´»å‹•åç¨±', 'å ±å‘Šèµ·å§‹', 'å ±å‘ŠçµæŸ', 'èŠ±è²»é‡‘é¡', '%', 'é‡‘é¡+%', 'é€£çµé»æ“Šæ¬¡æ•¸', 'é»æ“Šæˆæœ¬', 'ç§è¨Šæ•¸', 'ç§è¨Šæˆæœ¬'];
              originalHeader = orderedHeaders.filter(header => headerMapping.hasOwnProperty(header) || header === '%' || header === 'é‡‘é¡+%');

              // é‡æ–°æ’åˆ—è³‡æ–™è¡Œ
              originalBody = actualMatrix.slice(1).map((row, rowIndex) => {
                return originalHeader.map(header => {
                  if (header === '%' || header === 'é‡‘é¡+%') {
                    return ''; // æ–°æ¬„ä½é è¨­ç‚ºç©º
                  }
                  return row[headerMapping[header]] || '';
                });
              });
            } else {
              // ä½¿ç”¨æ¨™æº–è¡¨é ­ - èª¿æ•´æ¬„ä½é †åºï¼Œåœ¨èŠ±è²»é‡‘é¡å¾Œæ’å…¥ % å’Œ é‡‘é¡+% æ¬„ä½
              originalHeader = ['æ´»å‹•åç¨±', 'å ±å‘Šèµ·å§‹', 'å ±å‘ŠçµæŸ', 'èŠ±è²»é‡‘é¡', '%', 'é‡‘é¡+%', 'é€£çµé»æ“Šæ¬¡æ•¸', 'é»æ“Šæˆæœ¬', 'ç§è¨Šæ•¸', 'ç§è¨Šæˆæœ¬'];
              // æ‰€æœ‰è¡Œéƒ½æ˜¯è³‡æ–™è¡Œ
              originalBody = actualMatrix;
            }

            // å‹•æ…‹æ·»åŠ  No. æ¬„ä½
            header = ['No.', ...originalHeader];
            body = originalBody;

            // ç¢ºä¿è¡¨é ­å’Œè³‡æ–™è¡Œæ¬„ä½æ•¸é‡åŒ¹é…
            // è¡¨é ­ï¼š['No.', ...originalHeader] = 1 + originalHeader.length å€‹æ¬„ä½
            // è³‡æ–™è¡Œï¼šNo. æ¬„ä½ + originalHeader.length å€‹è³‡æ–™æ¬„ä½ = 1 + originalHeader.length å€‹æ¬„ä½

            let html = '<thead class="bg-slate-50 sticky top-0 z-20"><tr>';
            for (let i = 0; i < header.length; i++) {
              const h = header[i];
              const sortIcon = currentSort.column === i
                ? (currentSort.ascending ? 'â–²' : 'â–¼')
                : 'â‡…';

              // ç‚ºã€Œé‡‘é¡+%ã€æ¬„ä½æ·»åŠ çªå‡ºæ¨£å¼
              const isCalculatedAmount = h === 'é‡‘é¡+%';
              const headerClass = isCalculatedAmount
                ? "px-2 py-1.5 text-slate-600 text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-blue-100 select-none bg-blue-50 sticky top-0 z-20 border-b border-slate-200 border-l-2 border-blue-200"
                : "px-2 py-1.5 text-slate-600 text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-slate-100 select-none bg-slate-50 sticky top-0 z-20 border-b border-slate-200";

              html += `<th class="${headerClass}" onclick="sortTable(${i})">
        <div class="flex items-center justify-between">
          <span>${escapeHtml(h)}</span>
          <span class="ml-1 text-slate-400 text-xs">${sortIcon}</span>
        </div>
      </th>`;
            }
            html += '</tr></thead><tbody class="divide-y divide-slate-200">';

            let rowNumber = 1;
            for (const row of body) {
              if (row.every((v) => String(v || '').trim() === '')) continue;
              html += '<tr class="hover:bg-slate-50 transition-colors">';
              // ç¬¬ä¸€å€‹æ¬„ä½æ˜¯ No.ï¼Œé¡¯ç¤ºè¡Œè™Ÿ
              html += `<td class="px-2 py-1.5 text-slate-700 text-xs font-medium text-center">${rowNumber}</td>`;

              // è™•ç†æ‰€æœ‰åŸå§‹è³‡æ–™æ¬„ä½ï¼Œç¢ºä¿èˆ‡è¡¨é ­æ•¸é‡ä¸€è‡´
              for (let i = 0; i < originalHeader.length; i++) {
                const header = originalHeader[i];
                const cell = row[i] || '';

                if (header === '%') {
                  // % æ¬„ä½ï¼šè¼¸å…¥æ¡†
                  const campaignName = row[0] || '';
                  // ä½¿ç”¨æ´»å‹•åç¨±ä½œç‚ºå”¯ä¸€è­˜åˆ¥ï¼Œä¸ä¾è³´è¡Œè™Ÿ
                  const rowId = `${campaignName}`;
                  const currentSheet = getCurrentSheetName();
                  const savedPercentage = (percentageStorage[currentSheet] && percentageStorage[currentSheet][rowId]) || '';

                  // æ‰¾åˆ°èŠ±è²»é‡‘é¡æ¬„ä½çš„å€¼
                  const spendIndex = originalHeader.indexOf('èŠ±è²»é‡‘é¡');
                  const spendAmount = spendIndex >= 0 ? parseFloat(row[spendIndex]) || 0 : 0;

                  html += `<td class="px-2 py-1.5 text-slate-700 text-xs">
            <input type="number" 
                   class="w-full px-1 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" 
                   placeholder="%" 
                    value="${savedPercentage || '5'}"
                   data-row-id="${rowId}"
                   data-sheet="${currentSheet}"
                   data-row="${rowNumber}"
                   onchange="saveAndUpdatePercentage(this, ${spendAmount})"
                   min="0" 
                   max="100" 
                   step="0.1">
          </td>`;
                } else if (header === 'é‡‘é¡+%') {
                  // é‡‘é¡+% æ¬„ä½ï¼šè¨ˆç®—å¾Œçš„é‡‘é¡
                  const campaignName = row[0] || '';
                  // ä½¿ç”¨æ´»å‹•åç¨±ä½œç‚ºå”¯ä¸€è­˜åˆ¥ï¼Œä¸ä¾è³´è¡Œè™Ÿ
                  const rowId = `${campaignName}`;
                  const currentSheet = getCurrentSheetName();
                  const savedPercentage = (percentageStorage[currentSheet] && percentageStorage[currentSheet][rowId]) || 5;

                  // æ‰¾åˆ°èŠ±è²»é‡‘é¡æ¬„ä½çš„å€¼
                  const spendIndex = originalHeader.indexOf('èŠ±è²»é‡‘é¡');
                  const originalAmount = spendIndex >= 0 ? parseFloat(row[spendIndex]) || 0 : 0;
                  const calculatedAmount = Math.ceil(originalAmount * (1 + parseFloat(savedPercentage) / 100));

                  html += `<td class="px-2 py-1.5 text-slate-700 text-xs calculated-amount bg-blue-50 border-l-2 border-blue-200" data-row="${rowNumber}">
            ${originalAmount > 0 ? calculatedAmount.toLocaleString() : '-'}
          </td>`;
                } else if (header === 'æ´»å‹•åç¨±') {
                  // æ´»å‹•åç¨±æ¬„ä½ï¼šæ”¯æ´ç·¨è¼¯æš±ç¨±
                  const originalName = cell;
                  const currentSheet = getCurrentSheetName();
                  const nickname = (nicknameStorage[currentSheet] && nicknameStorage[currentSheet][originalName]) || '';
                  const displayName = nickname || originalName;
                  const hasNickname = nickname && nickname !== originalName;

                  html += `<td class="px-2 py-1.5 text-slate-700 text-xs">
            <div class="flex items-center justify-between group">
              <span class="${hasNickname ? 'font-medium' : ''}">${escapeHtml(displayName)}</span>
              <button onclick="editCampaignName(this.parentElement.parentElement, '${escapeHtml(originalName)}')" 
                      class="opacity-0 group-hover:opacity-100 transition-opacity p-1 text-slate-400 hover:text-slate-600">
                <span class="material-symbols-outlined text-sm">edit</span>
              </button>
            </div>
          </td>`;
                } else if (header === 'ç§è¨Šæˆæœ¬') {
                  // ç§è¨Šæˆæœ¬æ¬„ä½ï¼šå¥—ç”¨é¡è‰²æ¨™ç¤ºä¸¦æ–°å¢è¨­å®šæŒ‰éˆ•
                  const campaignName = row[0] || '';
                  const rowId = `${campaignName}`;
                  const colorClass = getColorClass(cell, 'messageCost', rowId);
                  const baseClass = 'px-2 py-1.5 text-slate-700 text-xs';
                  const finalClass = colorClass ? `${baseClass} ${colorClass} border rounded` : baseClass;

                  html += `<td class="${finalClass}">
            <div class="flex items-center justify-between group">
              <span>${escapeHtml(cell)}</span>
              <button onclick="openRowColorSettings('${escapeHtml(rowId)}', 'messageCost')" 
                      class="opacity-0 group-hover:opacity-100 transition-opacity p-1 text-slate-400 hover:text-slate-600" title="è¨­å®šé¡è‰²é–¾å€¼">
                <span class="material-symbols-outlined text-sm">palette</span>
              </button>
            </div>
          </td>`;
                } else if (header === 'é»æ“Šæˆæœ¬') {
                  // é»æ“Šæˆæœ¬æ¬„ä½ï¼šå¥—ç”¨é¡è‰²æ¨™ç¤ºä¸¦æ–°å¢è¨­å®šæŒ‰éˆ•
                  const campaignName = row[0] || '';
                  const rowId = `${campaignName}`;
                  const colorClass = getColorClass(cell, 'clickCost', rowId);
                  const baseClass = 'px-2 py-1.5 text-slate-700 text-xs';
                  const finalClass = colorClass ? `${baseClass} ${colorClass} border rounded` : baseClass;

                  html += `<td class="${finalClass}">
            <div class="flex items-center justify-between group">
              <span>${escapeHtml(cell)}</span>
              <button onclick="openRowColorSettings('${escapeHtml(rowId)}', 'clickCost')" 
                      class="opacity-0 group-hover:opacity-100 transition-opacity p-1 text-slate-400 hover:text-slate-600" title="è¨­å®šé¡è‰²é–¾å€¼">
                <span class="material-symbols-outlined text-sm">palette</span>
              </button>
            </div>
          </td>`;
                } else {
                  // ä¸€èˆ¬æ¬„ä½
                  html += `<td class="px-2 py-1.5 text-slate-700 text-xs">${escapeHtml(cell)}</td>`;
                }
              }

              html += '</tr>';
              rowNumber++;
            }
            html += '</tbody>';
            return html;
          }

          function isNumeric(str) {
            if (!str || str === '') return false;
            const cleaned = String(str).replace(/[,$%]/g, '');
            return !isNaN(cleaned) && !isNaN(parseFloat(cleaned));
          }

          function parseValue(str) {
            if (!str || str === '') return '';
            const cleaned = String(str).replace(/[,$%]/g, '');
            return isNumeric(str) ? parseFloat(cleaned) : str.toLowerCase();
          }

          function sortTable(columnIndex) {
            if (!currentData || currentData.length <= 1) return;

            // No. æ¬„ä½ï¼ˆç´¢å¼• 0ï¼‰ä¸åƒèˆ‡æ’åº
            if (columnIndex === 0) return;

            const header = currentData[0];
            let body = currentData.slice(1);

            // éæ¿¾æ‰ç©ºè¡Œ
            body = body.filter(row => !row.every(v => String(v || '').trim() === ''));

            // åˆ‡æ›æ’åºæ–¹å‘
            if (currentSort.column === columnIndex) {
              currentSort.ascending = !currentSort.ascending;
            } else {
              currentSort.column = columnIndex;
              currentSort.ascending = true;
            }

            // æ’åºï¼ˆèª¿æ•´ç´¢å¼•ï¼Œå› ç‚ºå¯¦éš›è³‡æ–™æ¯”é¡¯ç¤ºå°‘ä¸‰æ¬„ï¼šNo.ã€%ã€é‡‘é¡+%ï¼‰
            body.sort((a, b) => {
              let dataColumnIndex = columnIndex - 1; // æ¸›å» No. æ¬„ä½

              // å¦‚æœæ˜¯ç™¾åˆ†æ¯”æ¬„ä½ï¼ˆç´¢å¼•4ï¼‰æˆ–è¨ˆç®—é‡‘é¡æ¬„ä½ï¼ˆç´¢å¼•5ï¼‰ï¼Œä¸é€²è¡Œæ’åº
              if (columnIndex === 4 || columnIndex === 5) return 0;

              // å¦‚æœæ˜¯ç™¾åˆ†æ¯”æ¬„ä½ä¹‹å¾Œçš„æ¬„ä½ï¼Œéœ€è¦å†æ¸›å»2ï¼ˆ% å’Œ é‡‘é¡+% æ¬„ä½ï¼‰
              if (columnIndex > 5) {
                dataColumnIndex = columnIndex - 3; // æ¸›å» No.ã€%ã€é‡‘é¡+% æ¬„ä½
              }

              const aVal = parseValue(a[dataColumnIndex]);
              const bVal = parseValue(b[dataColumnIndex]);

              let result;
              if (typeof aVal === 'number' && typeof bVal === 'number') {
                result = aVal - bVal;
              } else {
                result = String(aVal).localeCompare(String(bVal));
              }

              return currentSort.ascending ? result : -result;
            });

            // è¨˜ä½ç•¶å‰é é¢æ»¾å‹•ä½ç½®
            const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

            // é‡æ–°çµ„åˆè³‡æ–™ä¸¦æ¸²æŸ“ï¼ˆä¿æŒè³‡è¨Šæ–‡å­—ï¼‰
            const sortedMatrix = [header, ...body];

            // ä¿æŒåŸæœ‰çš„è³‡è¨Šæ–‡å­—
            const currentInfoText = tableInfoEl ? tableInfoEl.textContent : '';

            mainTable.innerHTML = buildTableHtml(sortedMatrix);

            // æ¢å¾©è³‡è¨Šæ–‡å­—
            if (tableInfoEl && currentInfoText) {
              tableInfoEl.textContent = currentInfoText;
            }

            // æ›´æ–°å„€è¡¨æ¿ï¼ˆå»¶é²åŸ·è¡Œç¢ºä¿DOMå·²æ›´æ–°ï¼‰
            setTimeout(updateDashboard, 0);

            // æ¢å¾©é é¢æ»¾å‹•ä½ç½®
            setTimeout(() => {
              window.scrollTo(0, Math.max(0, currentScrollTop));
            }, 0);
          }

          // å°‡ sortTable å‡½å¼æ›åˆ°å…¨åŸŸï¼Œè®“ onclick å¯ä»¥å‘¼å«
          window.sortTable = sortTable;

          // å–å¾—ç•¶å‰å·¥ä½œè¡¨åç¨±
          function getCurrentSheetName() {
            const activeTab = document.querySelector('#sheet-tabs button[aria-selected="true"]');
            return activeTab ? activeTab.getAttribute('data-sheet') : 'default';
          }

          // å„²å­˜ç™¾åˆ†æ¯”ä¸¦æ›´æ–°è¨ˆç®—é‡‘é¡
          function saveAndUpdatePercentage(input, originalAmount) {
            const percentage = parseFloat(input.value) || 0;
            const rowId = input.getAttribute('data-row-id');
            const sheetName = input.getAttribute('data-sheet');
            const row = input.getAttribute('data-row');

            // å„²å­˜ç™¾åˆ†æ¯”åˆ°å‰ç«¯å„²å­˜
            if (!percentageStorage[sheetName]) {
              percentageStorage[sheetName] = {};
            }

            // å…è¨± 0% æˆ–ç©ºå€¼ï¼Œç©ºå€¼æ™‚ä½¿ç”¨ 5%ï¼Œç”¨æˆ¶æ˜ç¢ºè¼¸å…¥ 0 æ™‚ä¹Ÿä¿æŒ 0%
            const finalPercentage = (input.value.trim() === '' || isNaN(percentage)) ? 0 : percentage;
            percentageStorage[sheetName][rowId] = finalPercentage;

            // æ›´æ–°è¨ˆç®—é‡‘é¡é¡¯ç¤ºï¼ˆä½¿ç”¨ç„¡æ¢ä»¶é€²ä½ï¼‰
            const calculatedAmount = Math.ceil(originalAmount * (1 + finalPercentage / 100));
            const calculatedCell = document.querySelector(`td.calculated-amount[data-row="${row}"]`);

            if (calculatedCell) {
              if (originalAmount > 0) {
                calculatedCell.textContent = calculatedAmount.toLocaleString('zh-TW', {
                  minimumFractionDigits: 0,
                  maximumFractionDigits: 0
                });
              } else {
                calculatedCell.textContent = '-';
              }
            }

            // å„²å­˜åˆ° localStorage
            try {
              localStorage.setItem('adManagerPercentages', JSON.stringify(percentageStorage));
            } catch (e) {
              console.warn('ç„¡æ³•å„²å­˜ç™¾åˆ†æ¯”åˆ° localStorage:', e);
            }

            // ç«‹å³æ›´æ–°å„€è¡¨æ¿çµ±è¨ˆ
            updateDashboard();

            // æ›´æ–°åˆ†é çµ±è¨ˆæ•¸æ“šï¼ˆä½¿ç”¨å·²å¿«å–çš„è³‡æ–™ï¼‰
            setTimeout(() => {
              try {
                const wb = workbookCache;
                if (wb) {
                  const currentSheet = getCurrentSheetName();
                  // åªæ›´æ–°çµ±è¨ˆæ•¸æ“šï¼Œä¸é‡æ–°è¼‰å…¥
                  updateTabStatistics(wb, currentSheet);
                }
              } catch (e) {
                console.warn('ç„¡æ³•æ›´æ–°åˆ†é çµ±è¨ˆ:', e);
              }
            }, 100);
          }

          // å¾ localStorage è¼‰å…¥ç™¾åˆ†æ¯”è³‡æ–™
          function loadPercentageStorage() {
            try {
              const stored = localStorage.getItem('adManagerPercentages');
              if (stored) {
                percentageStorage = JSON.parse(stored);
              }
            } catch (e) {
              console.warn('ç„¡æ³•å¾ localStorage è¼‰å…¥ç™¾åˆ†æ¯”è³‡æ–™:', e);
              percentageStorage = {};
            }
          }

          // å¾ localStorage è¼‰å…¥æš±ç¨±è³‡æ–™
          function loadNicknameStorage() {
            try {
              const stored = localStorage.getItem('adManagerNicknames');
              if (stored) {
                nicknameStorage = JSON.parse(stored);
              }
            } catch (e) {
              console.warn('ç„¡æ³•å¾ localStorage è¼‰å…¥æš±ç¨±è³‡æ–™:', e);
              nicknameStorage = {};
            }
          }

          // å¾ localStorage è¼‰å…¥é¡è‰²é–¾å€¼è¨­å®š
          function loadColorThresholds() {
            try {
              const stored = localStorage.getItem('adManagerColorThresholds');
              if (stored) {
                const parsed = JSON.parse(stored);
                // åˆä½µé è¨­å€¼å’Œå„²å­˜çš„å€¼
                colorThresholds = {
                  messageCost: { ...colorThresholds.messageCost, ...parsed.messageCost },
                  clickCost: { ...colorThresholds.clickCost, ...parsed.clickCost }
                };
              }
            } catch (e) {
              console.warn('ç„¡æ³•å¾ localStorage è¼‰å…¥é¡è‰²é–¾å€¼è¨­å®š:', e);
            }
          }

          // å„²å­˜é¡è‰²é–¾å€¼è¨­å®šåˆ° localStorage
          function saveColorThresholds() {
            try {
              localStorage.setItem('adManagerColorThresholds', JSON.stringify(colorThresholds));
            } catch (e) {
              console.warn('ç„¡æ³•å„²å­˜é¡è‰²é–¾å€¼è¨­å®š:', e);
            }
          }

          // å„²å­˜æ¯åˆ—é¡è‰²é–¾å€¼è¨­å®šåˆ° localStorage
          function saveRowColorThresholds() {
            try {
              localStorage.setItem('adManagerRowColorThresholds', JSON.stringify(rowColorThresholds));
            } catch (e) {
              console.warn('ç„¡æ³•å„²å­˜æ¯åˆ—é¡è‰²é–¾å€¼è¨­å®š:', e);
            }
          }

          // å¾ localStorage è¼‰å…¥æ¯åˆ—é¡è‰²é–¾å€¼è¨­å®š
          function loadRowColorThresholds() {
            try {
              const stored = localStorage.getItem('adManagerRowColorThresholds');
              if (stored) {
                rowColorThresholds = JSON.parse(stored);
              }
            } catch (e) {
              console.warn('ç„¡æ³•è¼‰å…¥æ¯åˆ—é¡è‰²é–¾å€¼è¨­å®š:', e);
              rowColorThresholds = {};
            }
          }

          // æ ¹æ“šæ•¸å€¼åˆ¤æ–·é¡è‰²é¡åˆ¥
          function getColorClass(value, thresholdType, rowId = null) {
            if (!value || isNaN(value)) return '';

            const currentSheet = getCurrentSheetName();
            let threshold = null;

            // å„ªå…ˆä½¿ç”¨è©²åˆ—çš„è¨­å®šï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å…¨åŸŸè¨­å®š
            if (rowId && rowColorThresholds[currentSheet] && rowColorThresholds[currentSheet][rowId]) {
              threshold = rowColorThresholds[currentSheet][rowId][thresholdType];
            }

            // å¦‚æœè©²åˆ—æ²’æœ‰è¨­å®šï¼Œä½¿ç”¨å…¨åŸŸè¨­å®š
            if (!threshold) {
              threshold = colorThresholds[thresholdType];
            }

            if (!threshold || !threshold.enabled) return '';

            const numValue = parseFloat(value);
            if (numValue < threshold.green) {
              return 'bg-green-100 text-green-800 border-green-200';
            } else if (numValue > threshold.red) {
              return 'bg-red-100 text-red-800 border-red-200';
            } else {
              return 'bg-orange-100 text-orange-800 border-orange-200';
            }
          }

          // å„²å­˜æš±ç¨±åˆ° localStorage
          function saveNicknameStorage() {
            try {
              localStorage.setItem('adManagerNicknames', JSON.stringify(nicknameStorage));
            } catch (e) {
              console.warn('ç„¡æ³•å„²å­˜æš±ç¨±åˆ° localStorage:', e);
            }
          }

          // åªæ›´æ–°åˆ†é çµ±è¨ˆæ•¸æ“šï¼Œä¸é‡æ–°è¼‰å…¥
          function updateTabStatistics(wb, activeName) {
            if (!wb || !wb.SheetNames) return;

            // ç¸½è¨ˆçµ±è¨ˆ
            let totalAccountsCount = 0;
            let grandTotalSpend = 0;
            let grandTotalSpendPlus = 0;

            // ç‚ºæ¯å€‹å·¥ä½œè¡¨è¨ˆç®—çµ±è¨ˆ
            for (const name of wb.SheetNames) {
              const matrix = getSheetMatrix(wb, name);
              let sheetRows = 0;
              let sheetTotalSpend = 0;
              let sheetTotalSpendPlus = 0;

              if (matrix && matrix.length > 0) {
                // æ‰¾åˆ°è¡¨é ­è¡Œ
                let bodyStart = 0;
                let spendColumnIndex = -1;

                for (let i = 0; i < matrix.length; i++) {
                  const row = matrix[i];
                  if (row && (String(row[0]).includes('æ´»å‹•åç¨±') || String(row[0]).trim() === 'æ´»å‹•åç¨±' || String(row[0]).includes('Campaign name'))) {
                    // æ‰¾åˆ°èŠ±è²»é‡‘é¡æ¬„ä½çš„ç´¢å¼•
                    for (let j = 0; j < row.length; j++) {
                      if (String(row[j]).includes('èŠ±è²»é‡‘é¡') || String(row[j]).includes('Amount spent')) {
                        spendColumnIndex = j;
                        break;
                      }
                    }
                    bodyStart = i + 1;
                    break;
                  }
                }

                // å¦‚æœæ‰¾ä¸åˆ°èŠ±è²»æ¬„ä½ï¼Œå‡è¨­æ˜¯ç¬¬4å€‹æ¬„ä½ï¼ˆç´¢å¼•3ï¼‰
                if (spendColumnIndex === -1) {
                  spendColumnIndex = 3;
                }

                // è¨ˆç®—æœ‰æ•ˆè³‡æ–™è¡Œæ•¸å’Œé‡‘é¡çµ±è¨ˆ
                for (let i = bodyStart; i < matrix.length; i++) {
                  const row = matrix[i];
                  if (row && !row.every(v => String(v || '').trim() === '') && String(row[0] || '').trim() !== '') {
                    sheetRows++;

                    // è¨ˆç®—è©²è¡Œçš„èŠ±è²»é‡‘é¡
                    if (spendColumnIndex >= 0 && row[spendColumnIndex]) {
                      const spendText = String(row[spendColumnIndex] || '').trim();
                      const spend = parseFloat(spendText.replace(/[,$]/g, '')) || 0;
                      if (!isNaN(spend) && spend >= 0) {
                        sheetTotalSpend += spend;

                        // è¨ˆç®—è©²è¡Œçš„èŠ±è²»+%é‡‘é¡
                        const campaignName = row[0] || '';
                        const rowId = `${campaignName}`;
                        const savedPercentage = (percentageStorage[name] && percentageStorage[name][rowId] !== undefined) ? percentageStorage[name][rowId] : 5;

                        // ä½¿ç”¨å„²å­˜çš„ç™¾åˆ†æ¯”è¨ˆç®—èŠ±è²»+%ï¼ˆé è¨­5%ï¼‰
                        const spendPlusAmount = Math.ceil(spend * (1 + parseFloat(savedPercentage) / 100));
                        sheetTotalSpendPlus += spendPlusAmount;
                      }
                    }
                  }
                }
              }

              // ç´¯åŠ åˆ°ç¸½è¨ˆä¸­
              if (sheetRows > 0) {
                totalAccountsCount++;
                grandTotalSpend += sheetTotalSpend;
                grandTotalSpendPlus += sheetTotalSpendPlus;
              }

              // æ›´æ–°è©²åˆ†é çš„çµ±è¨ˆé¡¯ç¤º
              const tabButton = document.querySelector(`button[data-sheet="${name}"]`);
              if (tabButton) {
                const gridDiv = tabButton.querySelector('.grid');
                if (gridDiv) {
                  const cells = gridDiv.querySelectorAll('div');
                  if (cells.length >= 4) {
                    cells[1].textContent = sheetRows; // æ•¸é‡
                    cells[2].textContent = sheetTotalSpend.toLocaleString(); // èŠ±è²»
                    cells[3].textContent = sheetTotalSpendPlus.toLocaleString(); // èŠ±è²»+%
                  }
                }
              }
            }

            // æ›´æ–°ç¸½è¨ˆå¡ç‰‡
            if (totalAccountsEl) {
              totalAccountsEl.textContent = totalAccountsCount;
            }
            if (allTotalSpendEl) {
              allTotalSpendEl.textContent = grandTotalSpend > 0 ? grandTotalSpend.toLocaleString() : '-';
            }
            if (allTotalPercentageEl) {
              // è¨ˆç®—å·®è·ï¼šç¸½èŠ±è²»+% - ç¸½èŠ±è²»
              const difference = grandTotalSpendPlus - grandTotalSpend;
              allTotalPercentageEl.textContent = difference > 0 ? difference.toLocaleString() : '-';
            }
            if (allTotalSpendPlusEl) {
              allTotalSpendPlusEl.textContent = grandTotalSpendPlus > 0 ? grandTotalSpendPlus.toLocaleString() : '-';
            }
          }

          // ç·¨è¼¯æ´»å‹•åç¨±æš±ç¨±
          function editCampaignName(cell, originalName) {
            const currentSheet = getCurrentSheetName();
            const currentNickname = (nicknameStorage[currentSheet] && nicknameStorage[currentSheet][originalName]) || '';

            // å‰µå»ºè¼¸å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentNickname || originalName;
            input.className = 'w-full px-1 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500';
            input.placeholder = 'è¼¸å…¥æš±ç¨±';

            // å‰µå»ºæŒ‰éˆ•å®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex gap-1 mt-1';

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'å„²å­˜';
            saveBtn.className = 'px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600';

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.className = 'px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600';

            // å„²å­˜åŠŸèƒ½
            saveBtn.onclick = () => {
              const newNickname = input.value.trim();

              // å„²å­˜åˆ°å‰ç«¯å„²å­˜
              if (!nicknameStorage[currentSheet]) {
                nicknameStorage[currentSheet] = {};
              }

              if (newNickname && newNickname !== originalName) {
                nicknameStorage[currentSheet][originalName] = newNickname;
              } else {
                delete nicknameStorage[currentSheet][originalName];
              }

              // å„²å­˜åˆ° localStorage
              saveNicknameStorage();

              // æ›´æ–°é¡¯ç¤º
              updateCampaignNameDisplay(cell, originalName, newNickname);
            };

            // å–æ¶ˆåŠŸèƒ½
            cancelBtn.onclick = () => {
              updateCampaignNameDisplay(cell, originalName, currentNickname);
            };

            // æŒ‰ Enter å„²å­˜
            input.onkeypress = (e) => {
              if (e.key === 'Enter') {
                saveBtn.click();
              }
            };

            // æŒ‰ Escape å–æ¶ˆ
            input.onkeydown = (e) => {
              if (e.key === 'Escape') {
                cancelBtn.click();
              }
            };

            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);

            // æ›¿æ›å…§å®¹
            cell.innerHTML = '';
            cell.appendChild(input);
            cell.appendChild(buttonContainer);

            // èšç„¦åˆ°è¼¸å…¥æ¡†
            input.focus();
            input.select();
          }

          // æ›´æ–°æ´»å‹•åç¨±é¡¯ç¤º
          function updateCampaignNameDisplay(cell, originalName, nickname) {
            const currentSheet = getCurrentSheetName();
            const displayName = nickname || originalName;
            const hasNickname = nickname && nickname !== originalName;

            cell.innerHTML = `
      <div class="flex items-center justify-between group">
        <span class="text-slate-700 text-xs ${hasNickname ? 'font-medium' : ''}">${escapeHtml(displayName)}</span>
        <button onclick="editCampaignName(this.parentElement.parentElement, '${escapeHtml(originalName)}')" 
                class="opacity-0 group-hover:opacity-100 transition-opacity p-1 text-slate-400 hover:text-slate-600">
          <span class="material-symbols-outlined text-sm">edit</span>
        </button>
      </div>
    `;
          }

          // ä¸‹è¼‰è¡¨æ ¼è³‡æ–™
          function downloadTableData() {
            const currentSheet = getCurrentSheetName();
            const tableRows = mainTable.querySelectorAll('tbody tr');

            if (!tableRows || tableRows.length === 0) {
              alert('æ²’æœ‰è³‡æ–™å¯ä»¥ä¸‹è¼‰');
              return;
            }

            // ç²å–è¡¨é ­
            const headerCells = mainTable.querySelectorAll('thead th');
            const headers = Array.from(headerCells).map(th => th.textContent.trim().replace('â‡…', '').replace('â–²', '').replace('â–¼', '').trim());

            // æº–å‚™ CSV è³‡æ–™
            const csvData = [];
            csvData.push(headers); // æ·»åŠ è¡¨é ­

            // è™•ç†æ¯ä¸€è¡Œè³‡æ–™
            tableRows.forEach(row => {
              const cells = row.querySelectorAll('td');
              if (cells.length === 0) return;

              const rowData = [];

              // è™•ç†æ¯å€‹æ¬„ä½
              for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                const header = headers[i];

                if (header === 'æ´»å‹•åç¨±') {
                  // æ´»å‹•åç¨±ï¼šé¡¯ç¤ºæš±ç¨±æˆ–åŸå§‹åç¨±
                  const span = cell.querySelector('span');
                  const displayName = span ? span.textContent.trim() : cell.textContent.trim();
                  rowData.push(`"${displayName}"`);
                } else if (header === '%') {
                  // ç™¾åˆ†æ¯”ï¼šå¾è¼¸å…¥æ¡†ç²å–å€¼
                  const input = cell.querySelector('input');
                  const percentage = input ? input.value : '';
                  rowData.push(percentage || '');
                } else if (header === 'é‡‘é¡+%') {
                  // é‡‘é¡+%ï¼šé¡¯ç¤ºè¨ˆç®—å¾Œçš„é‡‘é¡
                  const amount = cell.textContent.trim();
                  rowData.push(amount === '-' ? '' : amount.replace(/,/g, ''));
                } else {
                  // å…¶ä»–æ¬„ä½ï¼šç›´æ¥å–æ–‡å­—å…§å®¹
                  const text = cell.textContent.trim();
                  rowData.push(`"${text}"`);
                }
              }

              csvData.push(rowData);
            });

            // è½‰æ›ç‚º CSV æ ¼å¼
            const csvContent = csvData.map(row => row.join(',')).join('\n');

            // å‰µå»ºä¸¦ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å»£å‘Šè³‡æ–™_${currentSheet}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }

          // è¨­å®šå½ˆçª—ç›¸é—œå‡½å¼
          function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
              modal.classList.remove('hidden');
              loadSheetConfig();
            }
          }

          function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
              modal.classList.add('hidden');
            }
          }

          function loadSheetConfig() {
            const configList = document.getElementById('sheetConfigList');
            if (!configList) return;

            // å¾ ADDITIONAL_SHEET_GIDS è¼‰å…¥ç¾æœ‰é…ç½®
            let html = '';
            ADDITIONAL_SHEET_GIDS.forEach((sheet, index) => {
              const uniqueId = `sheet-${index}-${Date.now()}`;
              html += `
        <div class="flex items-center gap-2 p-2 sm:p-3 rounded-lg" data-sheet-id="${uniqueId}">
          <div class="flex-1 grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">å·¥ä½œè¡¨åç¨±</label>
              <input type="text" 
                     value="${escapeHtml(sheet.name)}" 
                     data-field="name" 
                     class="w-full px-2 py-1.5 text-xs sm:text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Grid ID</label>
              <input type="text" 
                     value="${escapeHtml(sheet.gid)}" 
                     data-field="gid" 
                     class="w-full px-2 py-1.5 text-xs sm:text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            </div>
          </div>
          <button onclick="removeSheetConfig('${uniqueId}')" class="p-1.5 sm:p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors flex-shrink-0" title="åˆªé™¤">
            <span class="material-symbols-outlined text-sm sm:text-base">delete</span>
          </button>
        </div>
      `;
            });

            configList.innerHTML = html;

            // è¼‰å…¥é¡è‰²é–¾å€¼è¨­å®šåˆ°è¡¨å–®
            loadColorThresholdsToForm();
          }

          // è¼‰å…¥é¡è‰²é–¾å€¼è¨­å®šåˆ°è¡¨å–®
          function loadColorThresholdsToForm() {
            // ç§è¨Šæˆæœ¬è¨­å®š
            const messageCostEnabled = document.getElementById('enableMessageCostColor');
            const messageCostGreen = document.getElementById('messageCostGreen');
            const messageCostRed = document.getElementById('messageCostRed');

            if (messageCostEnabled) messageCostEnabled.checked = colorThresholds.messageCost.enabled;
            if (messageCostGreen) messageCostGreen.value = colorThresholds.messageCost.green;
            if (messageCostRed) messageCostRed.value = colorThresholds.messageCost.red;

            // é»æ“Šæˆæœ¬è¨­å®š
            const clickCostEnabled = document.getElementById('enableClickCostColor');
            const clickCostGreen = document.getElementById('clickCostGreen');
            const clickCostRed = document.getElementById('clickCostRed');

            if (clickCostEnabled) clickCostEnabled.checked = colorThresholds.clickCost.enabled;
            if (clickCostGreen) clickCostGreen.value = colorThresholds.clickCost.green;
            if (clickCostRed) clickCostRed.value = colorThresholds.clickCost.red;
          }

          function addNewSheet() {
            const configList = document.getElementById('sheetConfigList');
            if (!configList) return;

            const uniqueId = `new-sheet-${Date.now()}`;
            const newSheetHtml = `
      <div class="flex items-center gap-2 p-2 sm:p-3 rounded-lg bg-blue-50" data-sheet-id="${uniqueId}">
        <div class="flex-1 grid grid-cols-2 gap-2">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">å·¥ä½œè¡¨åç¨±</label>
            <input type="text" 
                   placeholder="è¼¸å…¥å·¥ä½œè¡¨åç¨±" 
                   data-field="name" 
                   class="w-full px-2 py-1.5 text-xs sm:text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Grid ID</label>
            <input type="text" 
                   placeholder="è¼¸å…¥ Grid ID" 
                   data-field="gid" 
                   class="w-full px-2 py-1.5 text-xs sm:text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
          </div>
        </div>
        <button onclick="removeSheetConfig('${uniqueId}')" class="p-1.5 sm:p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors flex-shrink-0" title="åˆªé™¤">
          <span class="material-symbols-outlined text-sm sm:text-base">delete</span>
        </button>
      </div>
    `;

            // å°‡æ–°å¢çš„å·¥ä½œè¡¨æ”¾åœ¨æœ€ä¸Šæ–¹
            configList.insertAdjacentHTML('afterbegin', newSheetHtml);
          }

          function removeSheetConfig(sheetId) {
            const configList = document.getElementById('sheetConfigList');
            if (!configList) return;

            // ä½¿ç”¨å”¯ä¸€ ID ä¾†ç²¾ç¢ºæ‰¾åˆ°è¦åˆªé™¤çš„é …ç›®
            const targetElement = configList.querySelector(`[data-sheet-id="${sheetId}"]`);
            if (targetElement) {
              targetElement.remove();
            }
          }

          function saveSheetConfig() {

            const configList = document.getElementById('sheetConfigList');
            if (!configList) return;

            const newConfig = [];
            const items = configList.children;

            for (let i = 0; i < items.length; i++) {
              const item = items[i];
              const nameInput = item.querySelector('input[data-field="name"]');
              const gidInput = item.querySelector('input[data-field="gid"]');

              if (nameInput && gidInput) {
                const name = nameInput.value.trim();
                const gid = gidInput.value.trim();

                if (name && gid) {
                  newConfig.push({ name, gid });
                }
              }
            }

            // æ›´æ–° ADDITIONAL_SHEET_GIDS
            ADDITIONAL_SHEET_GIDS.length = 0;
            ADDITIONAL_SHEET_GIDS.push(...newConfig);

            // å„²å­˜å·¥ä½œè¡¨é…ç½®åˆ° localStorage
            try {
              localStorage.setItem('adManagerSheetConfig', JSON.stringify(newConfig));
            } catch (e) {
              console.warn('ç„¡æ³•å„²å­˜å·¥ä½œè¡¨é…ç½®:', e);
            }

            // å„²å­˜é¡è‰²é–¾å€¼è¨­å®š
            saveColorThresholdsFromForm();

            // é—œé–‰å½ˆçª—
            closeSettingsModal();

            // é‡æ–°è¼‰å…¥è³‡æ–™
            if (confirm('è¨­å®šå·²å„²å­˜ï¼Œæ˜¯å¦é‡æ–°è¼‰å…¥è³‡æ–™ï¼Ÿ')) {
              location.reload();
            }
          }

          // å¾è¡¨å–®å„²å­˜é¡è‰²é–¾å€¼è¨­å®š
          function saveColorThresholdsFromForm() {
            // ç§è¨Šæˆæœ¬è¨­å®š
            const messageCostEnabled = document.getElementById('enableMessageCostColor');
            const messageCostGreen = document.getElementById('messageCostGreen');
            const messageCostRed = document.getElementById('messageCostRed');

            if (messageCostEnabled && messageCostGreen && messageCostRed) {
              colorThresholds.messageCost.enabled = messageCostEnabled.checked;
              colorThresholds.messageCost.green = parseFloat(messageCostGreen.value) || 0;
              colorThresholds.messageCost.red = parseFloat(messageCostRed.value) || 100;
            }

            // é»æ“Šæˆæœ¬è¨­å®š
            const clickCostEnabled = document.getElementById('enableClickCostColor');
            const clickCostGreen = document.getElementById('clickCostGreen');
            const clickCostRed = document.getElementById('clickCostRed');

            if (clickCostEnabled && clickCostGreen && clickCostRed) {
              colorThresholds.clickCost.enabled = clickCostEnabled.checked;
              colorThresholds.clickCost.green = parseFloat(clickCostGreen.value) || 0;
              colorThresholds.clickCost.red = parseFloat(clickCostRed.value) || 10;
            }

            // å„²å­˜åˆ° localStorage
            saveColorThresholds();
          }

          // è¼‰å…¥å„²å­˜çš„å·¥ä½œè¡¨é…ç½®
          function loadStoredSheetConfig() {
            try {
              const stored = localStorage.getItem('adManagerSheetConfig');
              if (stored) {
                const config = JSON.parse(stored);
                ADDITIONAL_SHEET_GIDS.length = 0;
                ADDITIONAL_SHEET_GIDS.push(...config);
              }
            } catch (e) {
              console.warn('ç„¡æ³•è¼‰å…¥å·¥ä½œè¡¨é…ç½®:', e);
            }
          }

          // é‡æ–°è¼‰å…¥è³‡æ–™åŠŸèƒ½
          async function refreshData() {
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshIcon = document.getElementById('refresh-icon');

            if (!refreshBtn || !refreshIcon) return;

            // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            refreshBtn.disabled = true;
            refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
            refreshIcon.classList.add('animate-spin');

            try {
              // é‡æ–°è¼‰å…¥è³‡æ–™ï¼ˆæ¯æ¬¡éƒ½å¾ Google Sheets ç²å–æœ€æ–°è³‡æ–™ï¼‰
              setStatus('æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...');
              const wb = await loadWorkbook();
              const names = wb.SheetNames || [];

              if (!names.length) {
                setStatus('æ²’æœ‰å¯ç”¨çš„å·¥ä½œè¡¨', true);
                return;
              }

              // é‡æ–°æ¸²æŸ“åˆ†é 
              const firstSheet = names[0];
              await renderTabs(names, firstSheet);

              // è¼‰å…¥ç¬¬ä¸€å€‹å·¥ä½œè¡¨è³‡æ–™
              const matrix = getSheetMatrix(wb, firstSheet);
              renderTable(matrix);
              setStatus('è³‡æ–™å·²æ›´æ–°');

              // çŸ­æš«é¡¯ç¤ºæˆåŠŸè¨Šæ¯å¾Œæ¸…é™¤
              setTimeout(() => {
                setStatus('');
              }, 2000);

            } catch (err) {
              console.error('é‡æ–°è¼‰å…¥è³‡æ–™å¤±æ•—:', err);
              setStatus(`é‡æ–°è¼‰å…¥å¤±æ•—: ${err.message}`, true);
            } finally {
              // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
              refreshBtn.disabled = false;
              refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
              refreshIcon.classList.remove('animate-spin');
            }
          }


          // æ¯åˆ—é¡è‰²è¨­å®šç›¸é—œè®Šæ•¸
          let currentRowColorSettings = {
            rowId: null,
            thresholdType: null
          };

          // é–‹å•Ÿæ¯åˆ—é¡è‰²è¨­å®šå½ˆçª—
          function openRowColorSettings(rowId, thresholdType) {
            currentRowColorSettings.rowId = rowId;
            currentRowColorSettings.thresholdType = thresholdType;

            const modal = document.getElementById('rowColorModal');
            const title = document.getElementById('rowColorModalTitle');
            const typeTitle = document.getElementById('rowColorTypeTitle');
            const enabledCheckbox = document.getElementById('rowColorEnabled');
            const greenInput = document.getElementById('rowColorGreen');
            const redInput = document.getElementById('rowColorRed');

            if (!modal || !title || !typeTitle || !enabledCheckbox || !greenInput || !redInput) return;

            // è¨­å®šæ¨™é¡Œ
            title.textContent = `ç‚ºã€Œ${rowId}ã€è¨­å®šå°ˆå±¬çš„é¡è‰²é–¾å€¼`;
            typeTitle.textContent = thresholdType === 'messageCost' ? 'ç§è¨Šæˆæœ¬æ¨™ç¤º' : 'é»æ“Šæˆæœ¬æ¨™ç¤º';

            // è¼‰å…¥ç¾æœ‰è¨­å®šæˆ–é è¨­å€¼
            const currentSheet = getCurrentSheetName();
            let currentSettings = null;

            if (rowColorThresholds[currentSheet] && rowColorThresholds[currentSheet][rowId]) {
              currentSettings = rowColorThresholds[currentSheet][rowId][thresholdType];
            }

            if (currentSettings) {
              // ä½¿ç”¨è©²åˆ—çš„è¨­å®š
              enabledCheckbox.checked = currentSettings.enabled;
              greenInput.value = currentSettings.green;
              redInput.value = currentSettings.red;
            } else {
              // ä½¿ç”¨å…¨åŸŸé è¨­è¨­å®š
              const defaultSettings = colorThresholds[thresholdType];
              enabledCheckbox.checked = defaultSettings.enabled;
              greenInput.value = defaultSettings.green;
              redInput.value = defaultSettings.red;
            }

            modal.classList.remove('hidden');
          }

          // é—œé–‰æ¯åˆ—é¡è‰²è¨­å®šå½ˆçª—
          function closeRowColorModal() {
            const modal = document.getElementById('rowColorModal');
            if (modal) {
              modal.classList.add('hidden');
            }
            currentRowColorSettings.rowId = null;
            currentRowColorSettings.thresholdType = null;
          }

          // å„²å­˜æ¯åˆ—é¡è‰²è¨­å®š
          function saveRowColorSettings() {
            const enabledCheckbox = document.getElementById('rowColorEnabled');
            const greenInput = document.getElementById('rowColorGreen');
            const redInput = document.getElementById('rowColorRed');

            if (!enabledCheckbox || !greenInput || !redInput) return;

            const { rowId, thresholdType } = currentRowColorSettings;
            if (!rowId || !thresholdType) return;

            const currentSheet = getCurrentSheetName();

            // åˆå§‹åŒ–è³‡æ–™çµæ§‹
            if (!rowColorThresholds[currentSheet]) {
              rowColorThresholds[currentSheet] = {};
            }
            if (!rowColorThresholds[currentSheet][rowId]) {
              rowColorThresholds[currentSheet][rowId] = {};
            }

            // å„²å­˜è¨­å®š
            rowColorThresholds[currentSheet][rowId][thresholdType] = {
              enabled: enabledCheckbox.checked,
              green: parseFloat(greenInput.value) || 0,
              red: parseFloat(redInput.value) || 100
            };

            // å„²å­˜åˆ° localStorage
            saveRowColorThresholds();

            // é—œé–‰å½ˆçª—
            closeRowColorModal();

            // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥å¥—ç”¨æ–°è¨­å®š
            if (originalData && originalData.length > 0) {
              mainTable.innerHTML = buildTableHtml(originalData);
              setTimeout(updateDashboard, 0);
            }
          }

          // åˆ‡æ›è¨­å®šæ¨™ç±¤é 
          function switchSettingsTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤é çš„ active æ¨£å¼
            const allTabs = document.querySelectorAll('#settingsModal button[id$="-tab"]');
            allTabs.forEach(tab => {
              tab.className = 'flex-1 sm:w-full text-left px-2 sm:px-3 py-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-50';
            });

            // ç§»é™¤æ‰€æœ‰å…§å®¹å€åŸŸçš„é¡¯ç¤º
            const allContents = document.querySelectorAll('#settingsModal div[id$="-content"]');
            allContents.forEach(content => {
              content.classList.add('hidden');
            });

            // è¨­å®šç•¶å‰æ¨™ç±¤é ç‚º active
            const currentTab = document.getElementById(`${tabName}-tab`);
            if (currentTab) {
              currentTab.className = 'flex-1 sm:w-full text-left px-2 sm:px-3 py-2 text-xs sm:text-sm font-medium rounded-md bg-blue-100 text-blue-700 border-b-2 sm:border-b-0 sm:border-r-2 border-blue-600';
            }

            // é¡¯ç¤ºå°æ‡‰çš„å…§å®¹å€åŸŸ
            const currentContent = document.getElementById(`${tabName}-content`);
            if (currentContent) {
              currentContent.classList.remove('hidden');
            }
          }

          // å°‡å‡½å¼æ›åˆ°å…¨åŸŸ
          window.saveAndUpdatePercentage = saveAndUpdatePercentage;
          window.getCurrentSheetName = getCurrentSheetName;
          window.editCampaignName = editCampaignName;
          window.downloadTableData = downloadTableData;
          window.openSettingsModal = openSettingsModal;
          window.closeSettingsModal = closeSettingsModal;
          window.addNewSheet = addNewSheet;
          window.removeSheetConfig = removeSheetConfig;
          window.saveSheetConfig = saveSheetConfig;
          window.refreshData = refreshData;
          window.openRowColorSettings = openRowColorSettings;
          window.closeRowColorModal = closeRowColorModal;
          window.saveRowColorSettings = saveRowColorSettings;
          window.switchSettingsTab = switchSettingsTab;

          // ç‰ˆæœ¬ç®¡ç†ç›¸é—œå‡½å¼
          // æ‰‹å‹•è¨­å®šçš„ç‰ˆæœ¬è™Ÿ - æ¯æ¬¡ç¨‹å¼ç¢¼æ”¹å‹•æ™‚éœ€è¦æ‰‹å‹•æ›´æ–°
          const APP_VERSION = '20250923.02';

          function updateVersionDisplay() {
            const versionEl = document.getElementById('version-display');
            if (versionEl) {
              versionEl.textContent = `v${APP_VERSION}`;
            }
          }

          // ç”Ÿæˆæ–°ç‰ˆæœ¬è™Ÿçš„è¼”åŠ©å‡½å¼ï¼ˆä¾›é–‹ç™¼è€…ä½¿ç”¨ï¼‰
          function generateNewVersion() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            return `${year}${month}${day}${hours}${minutes}${seconds}`;
          }

          // å°‡ç‰ˆæœ¬å‡½æ•¸æ›åˆ°å…¨åŸŸ
          window.updateVersionDisplay = updateVersionDisplay;
          window.generateNewVersion = generateNewVersion;


          async function loadWorkbook() {
            // é¡¯ç¤ºè¼‰å…¥å½ˆçª—
            showLoadingModal();
            updateLoadingProgress(0, 'æ­£åœ¨è¼‰å…¥ Google Sheets è³‡æ–™...');

            const HTMLSheets = {};
            const SheetNames = [];

            try {
              // ç›´æ¥è¼‰å…¥é…ç½®çš„å·¥ä½œè¡¨ï¼Œä¸è¼‰å…¥ä¸»è¦å·¥ä½œè¡¨
              if (ADDITIONAL_SHEET_GIDS.length === 0) {
                throw new Error('æ²’æœ‰é…ç½®ä»»ä½•å·¥ä½œè¡¨');
              }

              updateLoadingProgress(10, `æ­£åœ¨ä¸¦è¡Œè¼‰å…¥ ${ADDITIONAL_SHEET_GIDS.length} å€‹å·¥ä½œè¡¨...`);

              // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰å·¥ä½œè¡¨
              const loadPromises = ADDITIONAL_SHEET_GIDS.map(async (sheet, index) => {
                try {
                  const csvText = await fetchSheetCSV(sheet.gid);
                  if (csvText && !csvText.includes('<!DOCTYPE html>') && !csvText.includes('æ‰¾ä¸åˆ°ç¶²é ')) {
                    const csvData = parseCSV(csvText);
                    if (csvData.length > 1) { // è‡³å°‘è¦æœ‰è¡¨é ­å’Œä¸€è¡Œè³‡æ–™
                      return { name: sheet.name, data: csvData, success: true };
                    }
                  }
                  return { name: sheet.name, data: null, success: false };
                } catch (e) {
                  console.warn(`ç„¡æ³•è¼‰å…¥å·¥ä½œè¡¨ ${sheet.name} (gid=${sheet.gid}):`, e.message);
                  return { name: sheet.name, data: null, success: false };
                }
              });

              // ç­‰å¾…æ‰€æœ‰è¼‰å…¥å®Œæˆï¼Œä¸¦å³æ™‚æ›´æ–°é€²åº¦
              let completedCount = 0;
              const totalSheets = ADDITIONAL_SHEET_GIDS.length;

              // ä½¿ç”¨ Promise.allSettled ç­‰å¾…æ‰€æœ‰è«‹æ±‚å®Œæˆ
              const results = await Promise.allSettled(loadPromises);

              // è™•ç†çµæœ
              for (const result of results) {
                if (result.status === 'fulfilled' && result.value.success) {
                  HTMLSheets[result.value.name] = result.value.data;
                  SheetNames.push(result.value.name);
                }
                completedCount++;

                // æ›´æ–°é€²åº¦ (10-90%)
                const progress = 10 + (completedCount / totalSheets) * 80;
                updateLoadingProgress(progress, `å·²è¼‰å…¥ ${completedCount}/${totalSheets} å€‹å·¥ä½œè¡¨`);
              }

              console.log(`æˆåŠŸè¼‰å…¥ ${SheetNames.length} å€‹å·¥ä½œè¡¨`);

              // æ§‹å»ºã€Œä»¿ Workbookã€çµæ§‹ä¾›å¾ŒçºŒæµç¨‹ä½¿ç”¨
              updateLoadingProgress(95, 'æ­£åœ¨è™•ç†è³‡æ–™...');
              const wb = { __CSV__: true, SheetNames, HTMLSheets };
              workbookCache = wb;

              updateLoadingProgress(100, 'è¼‰å…¥å®Œæˆï¼');
              setTimeout(() => {
                hideLoadingModal();
              }, 500);

              return wb;

            } catch (e) {
              console.error('è¼‰å…¥å·¥ä½œè¡¨å¤±æ•—ï¼š', e);
              hideLoadingModal();
              setStatus(`ğŸš« Google Sheets é€£ç·šå¤±æ•—ï¼š${e.message}ã€‚è«‹æª¢æŸ¥ï¼š1) è©¦ç®—è¡¨æ˜¯å¦å…¬é–‹ 2) ç¶²è·¯é€£ç·šç‹€æ…‹ 3) è©¦ç®—è¡¨é€£çµæ˜¯å¦æ­£ç¢º`, true);
              throw e;
            }
          }
          function getSheetMatrix(workbook, sheetName) {
            // æ”¯æ´ CSV ä»¿ Workbookï¼ˆä¸»è¦ç”¨æ–¼ Google Sheets CSVï¼‰
            if (workbook && (workbook.__CSV__ || workbook.__HTML__)) {
              const aoa = workbook.HTMLSheets[sheetName] || [];
              return aoa;
            }

            // å¦‚æœä¸æ˜¯ CSV/HTML æ ¼å¼ä¸”æ²’æœ‰ XLSX å‡½å¼åº«ï¼Œè¿”å›ç©ºé™£åˆ—
            if (typeof XLSX === 'undefined') {
              console.warn('XLSX library not available, only CSV/HTML format supported');
              return [];
            }

            // XLSX æ ¼å¼æ”¯æ´ï¼ˆå‚™ç”¨ï¼‰
            const ws = workbook.Sheets[sheetName];
            if (!ws) {
              return [];
            }
            const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
            return aoa;
          }

          function renderTable(matrix) {
            matrix = trimEmptyEdges(matrix);

            // æ¸…ç†å’Œè™•ç†è³‡æ–™çŸ©é™£
            if (matrix && matrix.length > 0) {
              let processedMatrix = [];

              for (let i = 0; i < matrix.length; i++) {
                const row = matrix[i];

                // è·³éå„ç¨®è³‡è¨Šè¡Œå’Œç©ºè¡Œ
                const firstCell = String(row[0] || '').trim();

                // è·³éä»¥ä¸‹é¡å‹çš„è¡Œï¼š
                // 1. Facebook Ads Import è³‡è¨Šè¡Œ
                // 2. Last updated è³‡è¨Šè¡Œ  
                // 3. ç©ºè¡Œæˆ–åªæœ‰ç©ºç™½çš„è¡Œ
                if (firstCell.includes('Facebook Ads Import') ||
                  firstCell.includes('Last updated') ||
                  firstCell === '' ||
                  row.every(cell => String(cell || '').trim() === '')) {
                  continue;
                }

                // ä¿æŒåŸå§‹è³‡æ–™çµæ§‹ï¼Œç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½è¢«ä¿ç•™
                processedMatrix.push(row);
              }

              matrix = processedMatrix;
            }

            // å„²å­˜åŸå§‹è³‡æ–™
            originalData = matrix;
            // é‡ç½®æ’åºç‹€æ…‹
            currentSort = { column: -1, ascending: true };
            // é‡ç½®æœå°‹æ¡†
            if (searchInput) searchInput.value = '';
            mainTable.innerHTML = buildTableHtml(matrix);
            // æ›´æ–°å„€è¡¨æ¿ï¼ˆå»¶é²åŸ·è¡Œç¢ºä¿DOMå·²æ›´æ–°ï¼‰
            setTimeout(updateDashboard, 0);
          }


          function filterData(searchTerm) {
            if (!originalData || originalData.length <= 1) return originalData;

            if (!searchTerm || searchTerm.trim() === '') {
              return originalData;
            }

            const header = originalData[0];
            const body = originalData.slice(1);
            const searchLower = searchTerm.toLowerCase().trim();

            // å–®ä¸€å·¥ä½œè¡¨æ ¼å¼ï¼šåªæœå°‹æ´»å‹•åç¨±ï¼ˆç¬¬ä¸€æ¬„ï¼‰
            const filteredBody = body.filter(row => {
              const campaignName = String(row[0] || '').toLowerCase(); // æ´»å‹•åç¨±
              return campaignName.includes(searchLower);
            });

            return [header, ...filteredBody];
          }

          function performSearch() {
            if (!searchInput) return;

            const searchTerm = searchInput.value;
            const filteredData = filterData(searchTerm);

            // ä¿æŒåŸæœ‰çš„è³‡è¨Šæ–‡å­—
            const currentInfoText = tableInfoEl ? tableInfoEl.textContent : '';

            // é‡ç½®æ’åºç‹€æ…‹
            currentSort = { column: -1, ascending: true };

            // å»ºç«‹è¡¨æ ¼ï¼ˆæœƒè‡ªå‹•ä½¿ç”¨æ­£ç¢ºçš„è¡¨é ­ï¼‰
            mainTable.innerHTML = buildTableHtml(filteredData);

            // æ¢å¾©è³‡è¨Šæ–‡å­—
            if (tableInfoEl && currentInfoText) {
              tableInfoEl.textContent = currentInfoText;
            }

            // æ›´æ–°å„€è¡¨æ¿ï¼ˆå»¶é²åŸ·è¡Œç¢ºä¿DOMå·²æ›´æ–°ï¼‰
            setTimeout(updateDashboard, 0);
          }


          async function renderTabs(sheetNames, activeName) {
            const parts = [];
            // ä½¿ç”¨å·²å¿«å–çš„ workbookï¼Œé¿å…é‡è¤‡è¼‰å…¥
            const wb = workbookCache || await loadWorkbook();

            // ç¸½è¨ˆçµ±è¨ˆ
            let totalAccountsCount = 0;
            let grandTotalSpend = 0;
            let grandTotalSpendPlus = 0;

            // ç‚ºæ¯å€‹å·¥ä½œè¡¨è¨ˆç®—è¡Œæ•¸å’Œé‡‘é¡çµ±è¨ˆ
            for (const name of sheetNames) {
              const matrix = getSheetMatrix(wb, name);
              let sheetRows = 0;
              let sheetTotalSpend = 0;
              let sheetTotalSpendPlus = 0;

              if (matrix && matrix.length > 0) {
                // æ‰¾åˆ°è¡¨é ­è¡Œ
                let bodyStart = 0;
                let spendColumnIndex = -1;

                for (let i = 0; i < matrix.length; i++) {
                  const row = matrix[i];
                  if (row && (String(row[0]).includes('æ´»å‹•åç¨±') || String(row[0]).trim() === 'æ´»å‹•åç¨±' || String(row[0]).includes('Campaign'))) {
                    // æ‰¾åˆ°èŠ±è²»é‡‘é¡æ¬„ä½çš„ç´¢å¼•
                    for (let j = 0; j < row.length; j++) {
                      if (String(row[j]).includes('èŠ±è²»é‡‘é¡') || String(row[j]).includes('Amount spent')) {
                        spendColumnIndex = j;
                        break;
                      }
                    }
                    bodyStart = i + 1;
                    break;
                  }
                }

                // å¦‚æœæ‰¾ä¸åˆ°èŠ±è²»æ¬„ä½ï¼Œå‡è¨­æ˜¯ç¬¬4å€‹æ¬„ä½ï¼ˆç´¢å¼•3ï¼‰
                if (spendColumnIndex === -1) {
                  spendColumnIndex = 3;
                }

                // è¨ˆç®—æœ‰æ•ˆè³‡æ–™è¡Œæ•¸å’Œé‡‘é¡çµ±è¨ˆ
                for (let i = bodyStart; i < matrix.length; i++) {
                  const row = matrix[i];
                  if (row && !row.every(v => String(v || '').trim() === '') && String(row[0] || '').trim() !== '') {
                    sheetRows++;

                    // è¨ˆç®—è©²è¡Œçš„èŠ±è²»é‡‘é¡
                    if (spendColumnIndex >= 0 && row[spendColumnIndex]) {
                      const spendText = String(row[spendColumnIndex] || '').trim();
                      const spend = parseFloat(spendText.replace(/[,$]/g, '')) || 0;
                      if (!isNaN(spend) && spend >= 0) {
                        sheetTotalSpend += spend;

                        // è¨ˆç®—è©²è¡Œçš„èŠ±è²»+%é‡‘é¡
                        const campaignName = row[0] || '';
                        const rowId = `${campaignName}`;
                        const savedPercentage = (percentageStorage[name] && percentageStorage[name][rowId] !== undefined) ? percentageStorage[name][rowId] : 5;

                        // ä½¿ç”¨å„²å­˜çš„ç™¾åˆ†æ¯”è¨ˆç®—èŠ±è²»+%ï¼ˆé è¨­5%ï¼‰
                        const spendPlusAmount = Math.ceil(spend * (1 + parseFloat(savedPercentage) / 100));
                        sheetTotalSpendPlus += spendPlusAmount;
                      }
                    }
                  }
                }
              }

              // ç´¯åŠ åˆ°ç¸½è¨ˆä¸­
              if (sheetRows > 0) {
                totalAccountsCount++;
                grandTotalSpend += sheetTotalSpend;
                grandTotalSpendPlus += sheetTotalSpendPlus;
              }

              const active = String(name) === String(activeName);
              parts.push(
                `<button type="button" data-sheet="${escapeHtml(name)}" aria-selected="${active ? 'true' : 'false'}" class="text-left px-2 py-2 text-xs ${active ? 'bg-blue-50 text-blue-700 border-l-2 border-blue-600' : 'text-slate-700 hover:bg-slate-50'}">
          <div class="grid grid-cols-4 gap-2 items-center w-full">
            <div class="font-medium truncate">${escapeHtml(name)}</div>
            <div class="text-right text-slate-400">${sheetRows}</div>
            <div class="text-right text-slate-400">${sheetTotalSpend.toLocaleString()}</div>
            <div class="text-right text-slate-400">${sheetTotalSpendPlus.toLocaleString()}</div>
          </div>
        </button>`
              );
            }
            tabsContainer.innerHTML = parts.join('');
            Array.from(tabsContainer.querySelectorAll('button[data-sheet]')).forEach((btn) => {
              btn.addEventListener('click', async () => {
                const sheet = btn.getAttribute('data-sheet');
                Array.from(tabsContainer.children).forEach((el) => {
                  el.setAttribute('aria-selected', el === btn ? 'true' : 'false');
                  el.className = 'text-left px-2 py-2 text-xs ' + (el === btn ? 'bg-blue-50 text-blue-700 border-l-2 border-blue-600' : 'text-slate-700 hover:bg-slate-50');
                });
                try {
                  setStatus('åˆ‡æ›å·¥ä½œè¡¨ä¸­...');
                  // ä½¿ç”¨å·²å¿«å–çš„ workbookï¼Œé¿å…é‡è¤‡è¼‰å…¥
                  const wb = workbookCache;
                  if (!wb) {
                    setStatus('è³‡æ–™å°šæœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢', true);
                    return;
                  }

                  // è¼‰å…¥å–®ä¸€å·¥ä½œè¡¨è³‡æ–™
                  const matrix = getSheetMatrix(wb, sheet);

                  renderTable(matrix);

                  setStatus('');
                } catch (e) {
                  setStatus('è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥æ¬Šé™/é€£ç·šã€‚', true);
                }
              });
            });

            // æ›´æ–°ç¸½è¨ˆå¡ç‰‡
            if (totalAccountsEl) {
              totalAccountsEl.textContent = totalAccountsCount;
            }
            if (allTotalSpendEl) {
              allTotalSpendEl.textContent = grandTotalSpend > 0 ? grandTotalSpend.toLocaleString() : '-';
            }
            if (allTotalPercentageEl) {
              // è¨ˆç®—å·®è·ï¼šç¸½èŠ±è²»+% - ç¸½èŠ±è²»
              const difference = grandTotalSpendPlus - grandTotalSpend;
              allTotalPercentageEl.textContent = difference > 0 ? difference.toLocaleString() : '-';
            }
            if (allTotalSpendPlusEl) {
              allTotalSpendPlusEl.textContent = grandTotalSpendPlus > 0 ? grandTotalSpendPlus.toLocaleString() : '-';
            }
          }

          async function init() {

            // æ›´æ–°ç‰ˆæœ¬è™Ÿé¡¯ç¤º
            updateVersionDisplay();

            // è¼‰å…¥å„²å­˜çš„ç™¾åˆ†æ¯”è³‡æ–™
            loadPercentageStorage();

            // è¼‰å…¥å„²å­˜çš„æš±ç¨±è³‡æ–™
            loadNicknameStorage();

            // è¼‰å…¥å„²å­˜çš„å·¥ä½œè¡¨é…ç½®
            loadStoredSheetConfig();

            // è¼‰å…¥é¡è‰²é–¾å€¼è¨­å®š
            loadColorThresholds();

            // è¼‰å…¥æ¯åˆ—é¡è‰²é–¾å€¼è¨­å®š
            loadRowColorThresholds();

            try {
              setStatus('è¼‰å…¥è©¦ç®—è¡¨èˆ‡å·¥ä½œè¡¨ä¸­...');
              const wb = await loadWorkbook();
              const names = wb.SheetNames || [];
              if (!names.length) {
                setStatus('æ²’æœ‰å¯ç”¨çš„å·¥ä½œè¡¨', true);
                return;
              }

              // æ¸²æŸ“åˆ†é ä¸¦è¨­å®šç¬¬ä¸€å€‹å·¥ä½œè¡¨ç‚º active
              const firstSheet = names[0];
              await renderTabs(names, firstSheet);

              // è¼‰å…¥ç¬¬ä¸€å€‹å·¥ä½œè¡¨è³‡æ–™
              const matrix = getSheetMatrix(wb, firstSheet);
              renderTable(matrix);
              setStatus('');
            } catch (err) {
              setStatus(`ç„¡æ³•è¼‰å…¥ Google Sheets è³‡æ–™: ${err.message}`, true);
            }
          }

          function setupSearch() {
            if (searchInput) {
              searchInput.addEventListener('input', performSearch);
              searchInput.addEventListener('keyup', performSearch);
            }
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
              init();
              setupSearch();
            });
          } else {
            init();
            setupSearch();
          }
        })();
      </script>
    </div>
  </div>
</body>

</html>
</body>

</html>