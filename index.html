<html><head>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<title>LURE AD CENTER</title>
<link href="images/favicon.jpg" rel="icon" type="image/jpeg"/>
<link href="images/favicon.jpg" rel="shortcut icon" type="image/jpeg"/>
<script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-white text-slate-900">

<!-- è¼‰å…¥å½ˆçª— -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 sm:p-8 max-w-md w-full mx-4 shadow-xl">
    <div class="text-center">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">è¼‰å…¥ä¸­...</h3>
      <p id="loadingText" class="text-gray-600 mb-4 text-sm sm:text-base">æ­£åœ¨è¼‰å…¥å·¥ä½œè¡¨è³‡æ–™</p>
      <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
        <div id="loadingProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
      </div>
      <p id="loadingProgressText" class="text-sm text-gray-500">0%</p>
    </div>
  </div>
</div>

<!-- å¯†ç¢¼é©—è­‰å½ˆçª— -->
<div id="passwordModal" class="fixed inset-0 bg-white flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 sm:p-8 max-w-md w-full mx-4 shadow-xl border">
    <div class="text-center">
      <h3 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4">å¯†ç¢¼é©—è­‰</h3>
      <p class="text-gray-600 mb-4 sm:mb-6 text-sm sm:text-base">è«‹è¼¸å…¥å››ä½æ•¸å¯†ç¢¼ä»¥é€²å…¥ç³»çµ±</p>
      <div class="mb-4 sm:mb-6">
        <input type="password" id="passwordInput" maxlength="4" class="w-full px-4 py-3 text-center text-xl sm:text-2xl font-mono border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="â€¢â€¢â€¢â€¢" autocomplete="off">
      </div>
      <div class="flex gap-3">
        <button onclick="verifyPassword()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
          ç¢ºèª
        </button>
      </div>
      <p id="passwordError" class="text-red-500 text-sm mt-3 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥</p>
    </div>
  </div>
</div>


<!-- æˆæœ¬æŒ‡æ¨™è¨­å®šå½ˆçª— -->
<div id="costIndicatorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-4 sm:p-6 max-w-2xl w-full mx-2 sm:mx-4 shadow-xl max-h-[90vh] sm:max-h-[80vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-4 sm:mb-6">
      <h3 class="text-lg sm:text-xl font-semibold text-gray-900">
        æˆæœ¬æŒ‡æ¨™è¨­å®š - <span id="currentSheetName" class="text-blue-600"></span>
      </h3>
      <button onclick="closeCostIndicatorModal()" class="text-gray-400 hover:text-gray-600 p-1">
        <span class="material-symbols-outlined text-xl sm:text-2xl">close</span>
      </button>
    </div>
    
    <div class="space-y-6">
      <!-- å¹³å‡ç§è¨Šæˆæœ¬è¨­å®š -->
      <div class="border border-gray-200 rounded-lg p-4">
        <h4 class="text-base font-medium text-gray-800 mb-4">å¹³å‡ç§è¨Šæˆæœ¬æŒ‡æ¨™</h4>
        <div class="space-y-3">
          <div class="flex items-center gap-3">
            <input type="checkbox" id="enableMessageCost" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <label for="enableMessageCost" class="text-sm text-gray-700">å•Ÿç”¨ç§è¨Šæˆæœ¬é¡è‰²æŒ‡æ¨™</label>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-green-500 rounded"></div>
              <label class="text-sm text-gray-600">ç¶ è‰² (ä½æ–¼)</label>
              <input type="number" id="messageCostGreen" placeholder="0" class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" step="0.1">
            </div>
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-red-500 rounded"></div>
              <label class="text-sm text-gray-600">ç´…è‰² (é«˜æ–¼)</label>
              <input type="number" id="messageCostRed" placeholder="0" class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" step="0.1">
            </div>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <div class="w-4 h-4 bg-orange-500 rounded"></div>
            <label class="text-sm text-gray-500">æ©˜è‰² (ä»‹æ–¼ç¶ è‰²å’Œç´…è‰²ä¹‹é–“)</label>
          </div>
        </div>
      </div>
      
      <!-- å¹³å‡é»æ“Šæˆæœ¬è¨­å®š -->
      <div class="border border-gray-200 rounded-lg p-4">
        <h4 class="text-base font-medium text-gray-800 mb-4">å¹³å‡é»æ“Šæˆæœ¬æŒ‡æ¨™</h4>
        <div class="space-y-3">
          <div class="flex items-center gap-3">
            <input type="checkbox" id="enableClickCost" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <label for="enableClickCost" class="text-sm text-gray-700">å•Ÿç”¨é»æ“Šæˆæœ¬é¡è‰²æŒ‡æ¨™</label>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-green-500 rounded"></div>
              <label class="text-sm text-gray-600">ç¶ è‰² (ä½æ–¼)</label>
              <input type="number" id="clickCostGreen" placeholder="0" class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" step="0.1">
            </div>
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-red-500 rounded"></div>
              <label class="text-sm text-gray-600">ç´…è‰² (é«˜æ–¼)</label>
              <input type="number" id="clickCostRed" placeholder="0" class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" step="0.1">
            </div>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <div class="w-4 h-4 bg-orange-500 rounded"></div>
            <label class="text-sm text-gray-500">æ©˜è‰² (ä»‹æ–¼ç¶ è‰²å’Œç´…è‰²ä¹‹é–“)</label>
          </div>
        </div>
      </div>
    </div>
    
    <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 mt-6">
      <button onclick="closeCostIndicatorModal()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors order-2 sm:order-1">
        å–æ¶ˆ
      </button>
      <button onclick="saveCostIndicatorSettings()" class="px-4 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors order-1 sm:order-2">
        å„²å­˜è¨­å®š
      </button>
    </div>
  </div>
</div>

<!-- è¨­å®šå½ˆçª— -->
<div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-4 sm:p-6 max-w-4xl w-full mx-2 sm:mx-4 shadow-xl max-h-[90vh] sm:max-h-[80vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-4 sm:mb-6">
      <h3 class="text-lg sm:text-xl font-semibold text-gray-900">åˆ†é è¨­å®š</h3>
      <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 p-1">
        <span class="material-symbols-outlined text-xl sm:text-2xl">close</span>
      </button>
    </div>
    
    <div class="mb-4 sm:mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h4 class="text-base sm:text-lg font-medium text-gray-800">å·¥ä½œè¡¨é…ç½®</h4>
        <button onclick="addNewSheet()" class="flex items-center gap-2 px-3 py-2 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors self-start sm:self-auto">
          <span class="material-symbols-outlined text-sm">add</span>
          æ–°å¢å·¥ä½œè¡¨
        </button>
      </div>
      
      <div id="sheetConfigList" class="space-y-3">
        <!-- å·¥ä½œè¡¨é…ç½®é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
    
    <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200">
      <button onclick="closeSettingsModal()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors order-2 sm:order-1">
        å–æ¶ˆ
      </button>
      <button onclick="saveSheetConfig()" class="px-4 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors order-1 sm:order-2">
        å„²å­˜è¨­å®š
      </button>
    </div>
  </div>
</div>

<div class="relative flex h-auto min-h-screen w-full flex-col bg-white group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;'>
<div class="layout-container flex h-full grow flex-col">
<header class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-solid border-slate-200 px-4 sm:px-6 lg:px-10 py-3 bg-white">
<div class="flex items-center gap-2 sm:gap-4 lg:gap-8">
<div class="flex items-center gap-2 sm:gap-4 text-slate-900">
  <h2 class="text-slate-900 text-lg sm:text-xl font-bold leading-tight tracking-[-0.015em]">LURE AD CENTER</h2>
</div>
</div>
<div class="flex items-center gap-2 sm:gap-4">
<div class="text-xs text-slate-500 font-mono hidden sm:block" id="version-display">v20250915170325</div>
<button id="refresh-btn" onclick="refreshData()" class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-md transition-colors" title="é‡æ–°è¼‰å…¥è³‡æ–™">
<span id="refresh-icon" class="material-symbols-outlined text-base sm:text-lg">refresh</span>
<span class="hidden sm:inline">æ›´æ–°</span>
</button>
<button onclick="testSortFunction()" class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-md transition-colors" title="æ¸¬è©¦æ’åºåŠŸèƒ½">
<span class="material-symbols-outlined text-base sm:text-lg">bug_report</span>
<span class="hidden sm:inline">æ¸¬è©¦</span>
</button>
<button onclick="openSettingsModal()" class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-md transition-colors">
<span class="material-symbols-outlined text-base sm:text-lg">settings</span>
<span class="hidden sm:inline">è¨­å®š</span>
</button>
</div>
</header>
<main class="flex flex-1 justify-center py-8 px-4 sm:px-6 lg:px-8 pt-24">
<div class="layout-content-container flex flex-col w-full max-w-7xl">
<div class="flex flex-col gap-4">
<div class="flex flex-col lg:flex-row gap-4 lg:gap-6">
<div class="w-full lg:w-80 lg:shrink-0 space-y-4 lg:sticky lg:top-24 lg:self-start">
<!-- ç¸½è¨ˆå¡ç‰‡ -->
<div class="rounded-md border border-slate-200 bg-slate-50">
<div class="px-3 py-2 border-b border-slate-200">
<p class="text-slate-700 text-xs font-medium">ç¸½è¨ˆ</p>
</div>
<div class="px-3 py-2">
<div class="grid grid-cols-2 lg:block lg:space-y-3 gap-3 text-xs">
<div class="flex items-center lg:flex-row">
<div class="text-slate-500 w-16 lg:w-20 text-xs lg:text-xs">å¸³è™Ÿæ•¸é‡</div>
<div class="text-base lg:text-lg font-bold text-gray-800" id="total-accounts">-</div>
</div>
<div class="flex items-center lg:flex-row">
<div class="text-slate-500 w-16 lg:w-20 text-xs lg:text-xs">ç¸½èŠ±è²»</div>
<div class="text-base lg:text-lg font-bold text-gray-800" id="all-total-spend">-</div>
</div>
<div class="flex items-center lg:flex-row">
<div class="text-slate-500 w-16 lg:w-20 text-xs lg:text-xs">%</div>
<div class="text-base lg:text-lg font-bold text-gray-800" id="all-total-percentage">-</div>
</div>
<div class="flex items-center lg:flex-row">
<div class="text-slate-500 w-16 lg:w-20 text-xs lg:text-xs">ç¸½èŠ±è²»+%</div>
<div class="text-base lg:text-lg font-bold text-gray-800" id="all-total-spend-plus">-</div>
</div>
</div>
</div>
</div>

<!-- å»£å‘Šå¸³è™Ÿå¡ç‰‡ -->
<div class="rounded-md border border-slate-200 bg-white">
<div class="px-3 py-2 bg-slate-50 border-b border-slate-200">
<p class="text-slate-700 text-xs font-medium">å»£å‘Šå¸³è™Ÿ</p>
<div class="grid grid-cols-4 gap-1 sm:gap-2 mt-1 text-xs text-slate-500">
<span class="truncate">åç¨±</span>
<span class="text-right">æ•¸é‡</span>
<span class="text-right">èŠ±è²»</span>
<span class="text-right">èŠ±è²»+%</span>
</div>
</div>
<nav id="sheet-tabs" class="flex flex-col divide-y divide-slate-200 max-h-[40vh] sm:max-h-none overflow-y-auto" aria-label="Sheets"></nav>
</div>
</div>
<div class="flex-1">
<div id="status" class="mb-3 text-sm text-slate-500">è¼‰å…¥ä¸­...</div>

<!-- å„€è¡¨æ¿çµ±è¨ˆ -->
<div class="mb-6 bg-white rounded-lg border border-gray-200 p-3 sm:p-4">
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4">
    <div class="text-center">
      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="total-spend">-</div>
      <div class="text-xs sm:text-sm text-gray-500">ç¸½èŠ±è²»</div>
    </div>
    <div class="text-center">
      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="total-spend-plus">-</div>
      <div class="text-xs sm:text-sm text-gray-500">ç¸½èŠ±è²»+%</div>
    </div>
    <div class="text-center">
      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="avg-clicks">-</div>
      <div class="text-xs sm:text-sm text-gray-500">å¹³å‡é»æ“Šæ¬¡æ•¸</div>
    </div>
    <div class="text-center">
      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="avg-cpc">-</div>
      <div class="text-xs sm:text-sm text-gray-500">å¹³å‡é»æ“Šæˆæœ¬</div>
    </div>
    <div class="text-center">
      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="avg-messages">-</div>
      <div class="text-xs sm:text-sm text-gray-500">å¹³å‡ç§è¨Šæ•¸</div>
    </div>
    <div class="text-center">
      <div class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="avg-message-cost">-</div>
      <div class="text-xs sm:text-sm text-gray-500">å¹³å‡ç§è¨Šæˆæœ¬</div>
    </div>
  </div>
</div>

<div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-3">
<label class="relative flex-col min-w-0 flex-1 sm:min-w-40 sm:max-w-64">
<div class="flex w-full flex-1 items-stretch rounded-md h-8 sm:h-8">
<div class="text-slate-400 flex border-none bg-slate-100 items-center justify-center pl-2 rounded-l-md border-r-0">
<span class="material-symbols-outlined text-sm">search</span>
</div>
<input id="search-input" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-md text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 border-none bg-slate-100 h-full placeholder:text-slate-400 px-3 rounded-l-none border-l-0 pl-2 text-xs font-normal leading-normal" placeholder="æœå°‹æ´»å‹•åç¨±" value=""/>
</div>
</label>
<div class="flex items-center justify-between sm:justify-end gap-3">
<div id="table-info" class="text-xs text-slate-500 italic font-light flex-1 sm:flex-none"></div>
<button id="download-btn" onclick="downloadTableData()" class="flex items-center gap-1 px-3 py-1.5 text-xs bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors whitespace-nowrap">
<span class="material-symbols-outlined text-sm">download</span>
<span class="hidden sm:inline">ä¸‹è¼‰è³‡æ–™</span>
<span class="sm:hidden">ä¸‹è¼‰</span>
</button>
</div>
</div>
<div class="overflow-x-auto rounded-md border border-slate-200 bg-white">
<table id="main-table" class="w-full text-left min-w-[800px]"></table>
</div>
</div>
</div>
</div>
  </div>
  </main>
<script>


(function() {
  // Google Sheets åŸºç¤é€£çµå’Œå¸¸è¦‹çš„å·¥ä½œè¡¨ GID
  const SHEETS_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSImKWK9cURUKloCFw3mr759Id_QfTSHmd1_8DJrihHr8bichEC3ZeoYaHrxmLkLaPSfCkPsLnoka4c/pub?output=csv';
  
  // æ‰€æœ‰å·¥ä½œè¡¨çš„ GID é…ç½®
  const ADDITIONAL_SHEET_GIDS = [
    { name: 'å¸å¼•åŠ›', gid: '1731918377' },
    { name: 'å¯°å®‡', gid: '186693734' },
    { name: 'è—è’‚è”»', gid: '678515244' },
    { name: 'æ–°æŠ€', gid: '1515508175' },
    { name: 'ç¸½éƒ¨', gid: '2076528666' },
    { name: 'æ–°åŸå€', gid: '1314685146' },
    { name: 'ç¬¬ä¸€äº‹æ¥­éƒ¨', gid: '2003263441' },
    { name: 'ç¬¬äºŒäº‹æ¥­éƒ¨', gid: '169051770' },
    { name: 'ç¬¬ä¸‰äº‹æ¥­éƒ¨', gid: '1585941268' },
    { name: 'ç¬¬å››äº‹æ¥­éƒ¨', gid: '1841114498' },
    { name: 'å…¶ä»–å€éƒ¨', gid: '2032331650' },
    { name: 'é¡å€', gid: '605760610' },
    { name: 'å¤§é‡Œå€', gid: '321162073' },
    { name: 'é€¢ç”²å€', gid: '2039681828' },
    { name: 'åŸºéš†å€', gid: '1871669787' }
  ];

  const tabsContainer = document.getElementById('sheet-tabs');
  const statusEl = document.getElementById('status');
  const tableInfoEl = document.getElementById('table-info');
  const mainTable = document.getElementById('main-table');
  const searchInput = document.getElementById('search-input');
  
  // å„€è¡¨æ¿å…ƒç´ 
  const totalSpendEl = document.getElementById('total-spend');
  const totalSpendPlusEl = document.getElementById('total-spend-plus');
  const avgClicksEl = document.getElementById('avg-clicks');
  const avgCpcEl = document.getElementById('avg-cpc');
  const avgMessagesEl = document.getElementById('avg-messages');
  const avgMessageCostEl = document.getElementById('avg-message-cost');
  
  // ç¸½è¨ˆå¡ç‰‡å…ƒç´ 
  const totalAccountsEl = document.getElementById('total-accounts');
  const allTotalSpendEl = document.getElementById('all-total-spend');
  const allTotalPercentageEl = document.getElementById('all-total-percentage');
  const allTotalSpendPlusEl = document.getElementById('all-total-spend-plus');
  
  let workbookCache = null;
  let originalData = [];
  
  // å„²å­˜ç™¾åˆ†æ¯”æ•¸æ“šçš„ç‰©ä»¶ï¼Œçµæ§‹ï¼š{ sheetName: { rowId: percentage } }
  let percentageStorage = {};
  
  // å„²å­˜æš±ç¨±æ•¸æ“šçš„ç‰©ä»¶ï¼Œçµæ§‹ï¼š{ sheetName: { originalName: nickname } }
  let nicknameStorage = {};
  
  // å„²å­˜æˆæœ¬æŒ‡æ¨™è¨­å®šçš„ç‰©ä»¶ï¼Œçµæ§‹ï¼š{ sheetName: { messageCost: {...}, clickCost: {...} } }
  let costIndicatorSettings = {};

  function setStatus(message, isError) {
    if (!statusEl) return;
    statusEl.textContent = message || '';
    statusEl.className = 'mb-3 text-sm ' + (isError ? 'text-red-600' : 'text-slate-500');
  }

  // è¼‰å…¥é€²åº¦ç›¸é—œå‡½å¼
  function showLoadingModal() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
      modal.classList.remove('hidden');
    }
  }

  function hideLoadingModal() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
      modal.classList.add('hidden');
    }
  }

  function updateLoadingProgress(percentage, text) {
    const progressBar = document.getElementById('loadingProgress');
    const progressText = document.getElementById('loadingProgressText');
    const loadingText = document.getElementById('loadingText');
    
    if (progressBar) {
      progressBar.style.width = percentage + '%';
    }
    if (progressText) {
      progressText.textContent = Math.round(percentage) + '%';
    }
    if (loadingText && text) {
      loadingText.textContent = text;
    }
  }

  function escapeHtml(value) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return String(value == null ? '' : value).replace(/[&<>"']/g, (m) => map[m]);
  }

  function parseCSV(csvText) {
    const lines = csvText.split('\n');
    const result = [];
    
    for (let line of lines) {
      if (line.trim() === '') continue;
      
      const row = [];
      let inQuotes = false;
      let currentField = '';
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];
        
        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            // è™•ç†é›™å¼•è™Ÿè½‰ç¾©
            currentField += '"';
            i++; // è·³éä¸‹ä¸€å€‹å¼•è™Ÿ
          } else {
            // åˆ‡æ›å¼•è™Ÿç‹€æ…‹
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          // æ¬„ä½åˆ†éš”ç¬¦
          row.push(currentField.trim());
          currentField = '';
        } else {
          currentField += char;
        }
      }
      
      // æ·»åŠ æœ€å¾Œä¸€å€‹æ¬„ä½
      row.push(currentField.trim());
      result.push(row);
    }
    
    return result;
  }

  async function fetchSheetCSV(gid = null) {
    const url = gid ? `${SHEETS_BASE_URL}&gid=${gid}` : SHEETS_BASE_URL;
    try {
      const resp = await fetch(url, { mode: 'cors' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
      return await resp.text();
    } catch (e) {
      console.warn(`ç„¡æ³•è¼‰å…¥å·¥ä½œè¡¨ (gid=${gid}):`, e.message);
      return null;
    }
  }

  function isValidValue(value) {
    // æª¢æŸ¥å€¼æ˜¯å¦ç‚ºæœ‰æ•ˆçš„éç©ºæ•¸å€¼
    if (!value || value === '' || value === '-' || value === 'null' || value === 'undefined') {
      return false;
    }
    // ç§»é™¤é€—è™Ÿå’Œè²¨å¹£ç¬¦è™Ÿå¾Œæª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å­—
    const cleaned = String(value).replace(/[,$]/g, '');
    const num = parseFloat(cleaned);
    return !isNaN(num) && num >= 0; // å…è¨± 0 å€¼ï¼Œä½†ä¸å…è¨±è² æ•¸
  }

  function updateDashboard() {
    // ç›´æ¥å¾è¡¨æ ¼ DOM ä¸­è®€å–æ•¸æ“šé€²è¡Œè¨ˆç®—
    const tableRows = mainTable.querySelectorAll('tbody tr');
    
    if (!tableRows || tableRows.length === 0) {
      // é‡ç½®å„€è¡¨æ¿
      if (totalSpendEl) totalSpendEl.textContent = '-';
      if (totalSpendPlusEl) totalSpendPlusEl.textContent = '-';
      if (avgClicksEl) avgClicksEl.textContent = '-';
      if (avgCpcEl) avgCpcEl.textContent = '-';
      if (avgMessagesEl) avgMessagesEl.textContent = '-';
      if (avgMessageCostEl) avgMessageCostEl.textContent = '-';
      return;
    }

    // æ‰¾åˆ°è¡¨é ­ä¸­å„æ¬„ä½çš„ä½ç½®
    const headerCells = mainTable.querySelectorAll('thead th');
    let spendIndex = -1, clicksIndex = -1, messagesIndex = -1, messageCostIndex = -1;
    
    headerCells.forEach((th, index) => {
      const headerText = th.textContent.trim();
      if (headerText.includes('èŠ±è²»é‡‘é¡')) spendIndex = index;
      if (headerText.includes('é€£çµé»æ“Šæ¬¡æ•¸')) clicksIndex = index;
      if (headerText.includes('ç§è¨Šæ•¸') && !headerText.includes('æˆæœ¬')) messagesIndex = index;
      if (headerText.includes('ç§è¨Šæˆæœ¬')) messageCostIndex = index;
    });

    let totalSpend = 0;
    let totalSpendPlus = 0;  // ç¸½èŠ±è²»+%
    let totalClicks = 0;
    let totalMessages = 0;
    let totalMessageCost = 0;
    
    // åˆ†åˆ¥è¨ˆç®—å„æ¬„ä½çš„æœ‰æ•ˆè¡Œæ•¸
    let validSpendRows = 0;
    let validClicksRows = 0;
    let validMessagesRows = 0;
    let validMessageCostRows = 0;

    // éæ­·æ¯ä¸€è¡Œæ•¸æ“š
    tableRows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length === 0) return;
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ•¸æ“šè¡Œï¼ˆç¬¬ä¸€æ¬„ä¸ç‚ºç©ºï¼‰
      const firstCell = cells[0]?.textContent.trim();
      if (!firstCell) return;

      // è¨ˆç®—ç¸½èŠ±è²»ï¼ˆåªè¨ˆç®—æœ‰å€¼çš„è¡Œï¼‰
      if (spendIndex >= 0 && cells[spendIndex]) {
        const spendText = cells[spendIndex].textContent.trim();
        if (isValidValue(spendText)) {
          const spend = parseFloat(spendText.replace(/[,$]/g, ''));
          if (!isNaN(spend) && spend >= 0) {
            totalSpend += spend;
            validSpendRows++;
          }
        }
      }

      // ç›´æ¥å¾è¡¨æ ¼ä¸­è®€å–ã€Œé‡‘é¡+%ã€æ¬„ä½çš„å€¼é€²è¡Œåˆè¨ˆ
      const calculatedAmountCell = row.querySelector('.calculated-amount');
      if (calculatedAmountCell) {
        const calculatedText = calculatedAmountCell.textContent.trim();
        if (calculatedText && calculatedText !== '-') {
          // å¦‚æœæœ‰è¨ˆç®—å¾Œçš„é‡‘é¡ï¼Œä½¿ç”¨è©²å€¼
          const calculatedAmount = parseFloat(calculatedText.replace(/[,$]/g, '')) || 0;
          if (!isNaN(calculatedAmount) && calculatedAmount > 0) {
            totalSpendPlus += calculatedAmount;
          }
        } else {
          // å¦‚æœã€Œé‡‘é¡+%ã€é¡¯ç¤º "-"ï¼Œå‰‡ä½¿ç”¨åŸå§‹èŠ±è²»é‡‘é¡
          if (spendIndex >= 0 && cells[spendIndex]) {
            const spendText = cells[spendIndex].textContent.trim();
            if (isValidValue(spendText)) {
              const spend = parseFloat(spendText.replace(/[,$]/g, ''));
              if (!isNaN(spend) && spend >= 0) {
                totalSpendPlus += spend;
              }
            }
          }
        }
      }

      // è¨ˆç®—ç¸½é»æ“Šæ¬¡æ•¸ï¼ˆåªè¨ˆç®—æœ‰å€¼çš„è¡Œï¼‰
      if (clicksIndex >= 0 && cells[clicksIndex]) {
        const clicksText = cells[clicksIndex].textContent.trim();
        if (isValidValue(clicksText)) {
          const clicks = parseFloat(clicksText.replace(/[,$]/g, ''));
          if (!isNaN(clicks) && clicks >= 0) {
            totalClicks += clicks;
            validClicksRows++;
          }
        }
      }

      // è¨ˆç®—ç¸½ç§è¨Šæ•¸ï¼ˆåªè¨ˆç®—æœ‰å€¼çš„è¡Œï¼‰
      if (messagesIndex >= 0 && cells[messagesIndex]) {
        const messagesText = cells[messagesIndex].textContent.trim();
        if (isValidValue(messagesText)) {
          const messages = parseFloat(messagesText.replace(/[,$]/g, ''));
          if (!isNaN(messages) && messages >= 0) {
            totalMessages += messages;
            validMessagesRows++;
          }
        }
      }

      // è¨ˆç®—ç¸½ç§è¨Šæˆæœ¬ï¼ˆåªè¨ˆç®—æœ‰å€¼çš„è¡Œï¼‰
      if (messageCostIndex >= 0 && cells[messageCostIndex]) {
        const messageCostText = cells[messageCostIndex].textContent.trim();
        if (isValidValue(messageCostText)) {
          const messageCost = parseFloat(messageCostText.replace(/[,$]/g, ''));
          if (!isNaN(messageCost) && messageCost >= 0) {
            totalMessageCost += messageCost;
            validMessageCostRows++;
          }
        }
      }
    });

    // æ›´æ–°å„€è¡¨æ¿
    if (totalSpendEl) {
      totalSpendEl.textContent = totalSpend > 0 ? totalSpend.toLocaleString() : '-';
    }

    if (totalSpendPlusEl) {
      totalSpendPlusEl.textContent = totalSpendPlus > 0 ? totalSpendPlus.toLocaleString() : '-';
    }

    if (avgClicksEl) {
      const avgClicks = validClicksRows > 0 ? Math.round(totalClicks / validClicksRows) : 0;
      avgClicksEl.textContent = avgClicks > 0 ? avgClicks.toLocaleString() : '-';
    }

    if (avgCpcEl) {
      // è¨ˆç®—å¹³å‡é»æ“Šæˆæœ¬ï¼šç›´æ¥å¾æ¯è¡Œçš„é»æ“Šæˆæœ¬æ¬„ä½è¨ˆç®—å¹³å‡å€¼
      let totalCpc = 0;
      let validCpcRows = 0;
      
      tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 0) return;
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ•¸æ“šè¡Œï¼ˆç¬¬ä¸€æ¬„ä¸ç‚ºç©ºï¼‰
        const firstCell = cells[0]?.textContent.trim();
        if (!firstCell) return;
        
        // æ‰¾åˆ°é»æ“Šæˆæœ¬æ¬„ä½ï¼ˆCPCï¼‰
        let cpcIndex = -1;
        const headerCells = mainTable.querySelectorAll('thead th');
        headerCells.forEach((th, index) => {
          const headerText = th.textContent.trim();
          if (headerText.includes('é»æ“Šæˆæœ¬') || headerText.includes('CPC')) {
            cpcIndex = index;
          }
        });
        
        // å¦‚æœæ‰¾åˆ°é»æ“Šæˆæœ¬æ¬„ä½ï¼Œè¨ˆç®—è©²è¡Œçš„é»æ“Šæˆæœ¬
        if (cpcIndex >= 0 && cells[cpcIndex]) {
          const cpcText = cells[cpcIndex].textContent.trim();
          if (isValidValue(cpcText)) {
            const cpc = parseFloat(cpcText.replace(/[,$]/g, ''));
            if (!isNaN(cpc) && cpc >= 0) {
              totalCpc += cpc;
              validCpcRows++;
            }
          }
        }
      });
      
      const avgCpc = validCpcRows > 0 ? (totalCpc / validCpcRows) : 0;
      avgCpcEl.textContent = avgCpc > 0 ? avgCpc.toFixed(1) : '-';
    }

    if (avgMessagesEl) {
      const avgMessages = validMessagesRows > 0 ? (totalMessages / validMessagesRows) : 0;
      avgMessagesEl.textContent = avgMessages > 0 ? avgMessages.toFixed(1) : '-';
    }

    if (avgMessageCostEl) {
      const avgMessageCost = validMessageCostRows > 0 ? (totalMessageCost / validMessageCostRows) : 0;
      avgMessageCostEl.textContent = avgMessageCost > 0 ? avgMessageCost.toFixed(1) : '-';
    }
  }

  function trimEmptyEdges(matrix) {
    if (!matrix || !matrix.length) return matrix;
    
    // æ‰¾åˆ°æœ€å¾Œä¸€å€‹éç©ºæ¬„ä½
    let lastNonEmptyCol = -1;
    for (let c = 0; c < matrix[0].length; c++) {
      let any = false;
      for (let r = 0; r < matrix.length; r++) {
        const v = (matrix[r][c] ?? '').toString().trim();
        if (v !== '') { any = true; break; }
      }
      if (any) lastNonEmptyCol = c;
    }
    
    // ä¿ç•™æ‰€æœ‰æ¬„ä½ï¼Œä¸è¦æˆªæ–·ï¼ˆé™¤éçœŸçš„å®Œå…¨ç‚ºç©ºï¼‰
    // åªç§»é™¤å®Œå…¨ç©ºç™½çš„è¡Œ
    while (matrix.length && matrix[matrix.length - 1].every((v) => String(v || '').trim() === '')) {
      matrix.pop();
    }
    
    return matrix;
  }

  let currentSort = { column: -1, ascending: true };
  let currentData = [];

  function buildTableHtml(matrix) {
    if (!matrix || matrix.length === 0 || (matrix[0] || []).every((v) => String(v || '').trim() === '')) {
      if (tableInfoEl) tableInfoEl.textContent = '';
      return '<tbody><tr><td class="px-2 py-1.5 text-slate-500 text-xs">ç„¡è³‡æ–™</td></tr></tbody>';
    }
    
    // ä¸å†è™•ç†è³‡è¨Šè¡Œï¼Œå› ç‚ºå·²ç¶“åœ¨ renderTable ä¸­ç§»é™¤äº†
    let actualMatrix = matrix;
    
    // èª¿è©¦è³‡è¨Šï¼šé¡¯ç¤ºè³‡æ–™çµæ§‹
    // console.log('è¡¨æ ¼è³‡æ–™çµæ§‹:', {
    //   totalRows: actualMatrix.length,
    //   firstRowColumns: actualMatrix[0] ? actualMatrix[0].length : 0,
    //   firstRowData: actualMatrix[0],
    //   sampleDataRow: actualMatrix[1] || 'ç„¡è³‡æ–™è¡Œ'
    // });
    
    // æ¸…ç©ºè³‡è¨Šæ–‡å­—
    if (tableInfoEl) {
      tableInfoEl.textContent = '';
    }
    
    if (actualMatrix.length === 0) {
      return '<tbody><tr><td class="px-2 py-1.5 text-slate-500 text-xs">ç„¡è³‡æ–™</td></tr></tbody>';
    }
    
    // currentData ç¾åœ¨ç”± renderTable å‡½æ•¸ç›´æ¥è¨­ç½®ï¼Œé€™è£¡ä¸éœ€è¦é‡è¤‡è¨­ç½®
    
    // æ±ºå®šä½¿ç”¨å“ªå€‹è¡¨é ­å’Œè³‡æ–™
    let header, body;
    
    // æª¢æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ç‚ºæ­£ç¢ºçš„è¡¨é ­
    const firstRow = actualMatrix[0];
    const isValidHeader = firstRow && (
      String(firstRow[0]).includes('æ´»å‹•åç¨±') ||
      String(firstRow[0]).trim() === 'æ´»å‹•åç¨±' ||
      String(firstRow[0]).includes('Campaign name')
    );
    
    let originalHeader, originalBody;
    if (isValidHeader) {
      // ç¬¬ä¸€è¡Œæ˜¯æ­£ç¢ºçš„è¡¨é ­ï¼Œä½†é‡æ–°æ’åˆ—æ¬„ä½é †åº
      const headerMapping = {};
      firstRow.forEach((cell, index) => {
        const cellStr = String(cell || '').trim();
        // çµ±ä¸€è¡¨é ­åç¨±ä¸¦è¨˜éŒ„ç´¢å¼•
        if (cellStr === 'Campaign name' || cellStr === 'æ´»å‹•åç¨±') headerMapping['æ´»å‹•åç¨±'] = index;
        if (cellStr === 'Reporting starts' || cellStr === 'å ±å‘Šèµ·å§‹') headerMapping['å ±å‘Šèµ·å§‹'] = index;
        if (cellStr === 'Reporting ends' || cellStr === 'å ±å‘ŠçµæŸ') headerMapping['å ±å‘ŠçµæŸ'] = index;
        if (cellStr === 'Amount spent' || cellStr === 'èŠ±è²»é‡‘é¡') headerMapping['èŠ±è²»é‡‘é¡'] = index;
        if (cellStr === 'Link clicks' || cellStr === 'é€£çµé»æ“Šæ¬¡æ•¸') headerMapping['é€£çµé»æ“Šæ¬¡æ•¸'] = index;
        if (cellStr === 'CPC (cost per link click)' || cellStr === 'é»æ“Šæˆæœ¬') headerMapping['é»æ“Šæˆæœ¬'] = index;
        if (cellStr === 'Messaging conversations started' || cellStr === 'ç§è¨Šæ•¸') headerMapping['ç§è¨Šæ•¸'] = index;
        if (cellStr === 'Cost per messaging conversations started' || cellStr === 'ç§è¨Šæˆæœ¬') headerMapping['ç§è¨Šæˆæœ¬'] = index;
      });
      
      // æŒ‰ç…§æŒ‡å®šé †åºé‡æ–°æ’åˆ—è¡¨é ­ï¼Œåœ¨èŠ±è²»é‡‘é¡å¾Œæ’å…¥ % å’Œ é‡‘é¡+% æ¬„ä½
      const orderedHeaders = ['æ´»å‹•åç¨±', 'å ±å‘Šèµ·å§‹', 'å ±å‘ŠçµæŸ', 'èŠ±è²»é‡‘é¡', '%', 'é‡‘é¡+%', 'é€£çµé»æ“Šæ¬¡æ•¸', 'é»æ“Šæˆæœ¬', 'ç§è¨Šæ•¸', 'ç§è¨Šæˆæœ¬'];
      originalHeader = orderedHeaders.filter(header => headerMapping.hasOwnProperty(header) || header === '%' || header === 'é‡‘é¡+%');
      
      // é‡æ–°æ’åˆ—è³‡æ–™è¡Œ
      originalBody = actualMatrix.slice(1).map((row, rowIndex) => {
        return originalHeader.map(header => {
          if (header === '%' || header === 'é‡‘é¡+%') {
            return ''; // æ–°æ¬„ä½é è¨­ç‚ºç©º
          }
          return row[headerMapping[header]] || '';
        });
      });
    } else {
      // ä½¿ç”¨æ¨™æº–è¡¨é ­ - èª¿æ•´æ¬„ä½é †åºï¼Œåœ¨èŠ±è²»é‡‘é¡å¾Œæ’å…¥ % å’Œ é‡‘é¡+% æ¬„ä½
      originalHeader = ['æ´»å‹•åç¨±', 'å ±å‘Šèµ·å§‹', 'å ±å‘ŠçµæŸ', 'èŠ±è²»é‡‘é¡', '%', 'é‡‘é¡+%', 'é€£çµé»æ“Šæ¬¡æ•¸', 'é»æ“Šæˆæœ¬', 'ç§è¨Šæ•¸', 'ç§è¨Šæˆæœ¬'];
      // æ‰€æœ‰è¡Œéƒ½æ˜¯è³‡æ–™è¡Œ
      originalBody = actualMatrix;
    }
    
    // å‹•æ…‹æ·»åŠ  No. æ¬„ä½å’Œæ“ä½œæ¬„ä½
    header = ['No.', ...originalHeader, 'æ“ä½œ'];
    body = originalBody;
    
    // ç¢ºä¿è¡¨é ­å’Œè³‡æ–™è¡Œæ¬„ä½æ•¸é‡åŒ¹é…
    // è¡¨é ­ï¼š['No.', ...originalHeader] = 1 + originalHeader.length å€‹æ¬„ä½
    // è³‡æ–™è¡Œï¼šNo. æ¬„ä½ + originalHeader.length å€‹è³‡æ–™æ¬„ä½ = 1 + originalHeader.length å€‹æ¬„ä½
    
    let html = '<thead class="bg-slate-50 sticky top-0 z-20"><tr>';
    for (let i = 0; i < header.length; i++) {
      const h = header[i];
      
      // å®šç¾©å¯æ’åºçš„æ¬„ä½
      const sortableColumns = ['æ´»å‹•åç¨±', 'èŠ±è²»é‡‘é¡', 'é»æ“Šæˆæœ¬', 'ç§è¨Šæˆæœ¬'];
      const isSortable = sortableColumns.includes(h);
      
      const sortIcon = isSortable ? (currentSort.column === i 
        ? (currentSort.ascending ? 'â–²' : 'â–¼') 
        : 'â‡…') : '';
      
      // ç‚ºã€Œé‡‘é¡+%ã€æ¬„ä½æ·»åŠ çªå‡ºæ¨£å¼
      const isCalculatedAmount = h === 'é‡‘é¡+%';
      const headerClass = isCalculatedAmount 
        ? "px-2 py-1.5 text-slate-600 text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-blue-100 select-none bg-blue-50 sticky top-0 z-20 border-b border-slate-200 border-l-2 border-blue-200"
        : isSortable 
          ? "px-2 py-1.5 text-slate-600 text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-slate-100 select-none bg-slate-50 sticky top-0 z-20 border-b border-slate-200"
          : "px-2 py-1.5 text-slate-600 text-xs font-semibold uppercase tracking-wider select-none bg-slate-50 sticky top-0 z-20 border-b border-slate-200";
      
      const onclick = isSortable ? `onclick="sortTable(${i})"` : '';
      
      html += `<th class="${headerClass}" ${onclick}>
        <div class="flex items-center justify-between">
          <span>${escapeHtml(h)}</span>
          ${sortIcon ? `<span class="ml-1 text-slate-400 text-xs">${sortIcon}</span>` : ''}
        </div>
      </th>`;
      
      // èª¿è©¦ï¼šè¨˜éŒ„å¯æ’åºçš„æ¬„ä½
      if (isSortable) {
        console.log(`Added sortable column: ${h} at index ${i}`);
      }
    }
    html += '</tr></thead><tbody class="divide-y divide-slate-200">';
    
    let rowNumber = 1;
    for (const row of body) {
      if (row.every((v) => String(v || '').trim() === '')) continue;
      html += '<tr class="hover:bg-slate-50 transition-colors">';
      // ç¬¬ä¸€å€‹æ¬„ä½æ˜¯ No.ï¼Œé¡¯ç¤ºè¡Œè™Ÿ
      html += `<td class="px-2 py-1.5 text-slate-700 text-xs font-medium text-center">${rowNumber}</td>`;
      
      // è™•ç†æ‰€æœ‰åŸå§‹è³‡æ–™æ¬„ä½ï¼Œç¢ºä¿èˆ‡è¡¨é ­æ•¸é‡ä¸€è‡´
      for (let i = 0; i < originalHeader.length; i++) {
        const header = originalHeader[i];
        const cell = row[i] || '';
        
        if (header === '%') {
          // % æ¬„ä½ï¼šè¼¸å…¥æ¡†
          const campaignName = row[0] || '';
          // ä½¿ç”¨æ´»å‹•åç¨±ä½œç‚ºå”¯ä¸€è­˜åˆ¥ï¼Œä¸ä¾è³´è¡Œè™Ÿ
          const rowId = `${campaignName}`;
          const currentSheet = getCurrentSheetName();
          const savedPercentage = (percentageStorage[currentSheet] && percentageStorage[currentSheet][rowId]) || '';
          
          // æ‰¾åˆ°èŠ±è²»é‡‘é¡æ¬„ä½çš„å€¼
          const spendIndex = originalHeader.indexOf('èŠ±è²»é‡‘é¡');
          const spendAmount = spendIndex >= 0 ? parseFloat(row[spendIndex]) || 0 : 0;
          
          html += `<td class="px-2 py-1.5 text-slate-700 text-xs">
            <input type="number" 
                   class="w-full px-1 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" 
                   placeholder="%" 
                    value="${savedPercentage || '5'}"
                   data-row-id="${rowId}"
                   data-sheet="${currentSheet}"
                   data-row="${rowNumber}"
                   onchange="saveAndUpdatePercentage(this, ${spendAmount})"
                   min="0" 
                   max="100" 
                   step="0.1">
          </td>`;
        } else if (header === 'é‡‘é¡+%') {
          // é‡‘é¡+% æ¬„ä½ï¼šè¨ˆç®—å¾Œçš„é‡‘é¡
          const campaignName = row[0] || '';
          // ä½¿ç”¨æ´»å‹•åç¨±ä½œç‚ºå”¯ä¸€è­˜åˆ¥ï¼Œä¸ä¾è³´è¡Œè™Ÿ
          const rowId = `${campaignName}`;
          const currentSheet = getCurrentSheetName();
            const savedPercentage = (percentageStorage[currentSheet] && percentageStorage[currentSheet][rowId]) || 5;
          
          // æ‰¾åˆ°èŠ±è²»é‡‘é¡æ¬„ä½çš„å€¼
          const spendIndex = originalHeader.indexOf('èŠ±è²»é‡‘é¡');
          const originalAmount = spendIndex >= 0 ? parseFloat(row[spendIndex]) || 0 : 0;
          const calculatedAmount = Math.ceil(originalAmount * (1 + parseFloat(savedPercentage) / 100));
          
          html += `<td class="px-2 py-1.5 text-slate-700 text-xs calculated-amount bg-blue-50 border-l-2 border-blue-200" data-row="${rowNumber}">
            ${originalAmount > 0 ? calculatedAmount.toLocaleString() : '-'}
          </td>`;
        } else if (header === 'æ´»å‹•åç¨±') {
          // æ´»å‹•åç¨±æ¬„ä½ï¼šæ”¯æ´ç·¨è¼¯æš±ç¨±
          const originalName = cell;
          const currentSheet = getCurrentSheetName();
          const nickname = (nicknameStorage[currentSheet] && nicknameStorage[currentSheet][originalName]) || '';
          const displayName = nickname || originalName;
          const hasNickname = nickname && nickname !== originalName;
          
          html += `<td class="px-2 py-1.5 text-slate-700 text-xs">
            <div class="flex items-center justify-between group">
              <span class="${hasNickname ? 'font-medium' : ''}">${escapeHtml(displayName)}</span>
              <button onclick="editCampaignName(this.parentElement.parentElement, '${escapeHtml(originalName)}')" 
                      class="opacity-0 group-hover:opacity-100 transition-opacity p-1 text-slate-400 hover:text-slate-600">
                <span class="material-symbols-outlined text-sm">edit</span>
              </button>
            </div>
          </td>`;
        } else if (header === 'é»æ“Šæˆæœ¬') {
          // é»æ“Šæˆæœ¬æ¬„ä½ï¼šå¥—ç”¨é¡è‰²æŒ‡æ¨™
          const costValue = parseFloat(cell) || 0;
          const colorClass = getClickCostColorClass(costValue);
          html += `<td class="px-2 py-1.5 text-slate-700 text-xs ${colorClass}">${escapeHtml(cell)}</td>`;
        } else if (header === 'ç§è¨Šæˆæœ¬') {
          // ç§è¨Šæˆæœ¬æ¬„ä½ï¼šå¥—ç”¨é¡è‰²æŒ‡æ¨™
          const costValue = parseFloat(cell) || 0;
          const colorClass = getMessageCostColorClass(costValue);
          html += `<td class="px-2 py-1.5 text-slate-700 text-xs ${colorClass}">${escapeHtml(cell)}</td>`;
        } else {
          // ä¸€èˆ¬æ¬„ä½
          html += `<td class="px-2 py-1.5 text-slate-700 text-xs">${escapeHtml(cell)}</td>`;
        }
      }
      
      // æ–°å¢æ“ä½œæ¬„ä½ï¼ˆ...æŒ‰éˆ•ï¼‰
      html += `<td class="px-2 py-1.5 text-slate-700 text-xs text-center">
        <button onclick="openCostIndicatorModal(${rowNumber})" 
                class="p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded transition-colors" 
                title="æˆæœ¬æŒ‡æ¨™è¨­å®š">
          <span class="material-symbols-outlined text-sm">more_horiz</span>
        </button>
      </td>`;
      
      html += '</tr>';
      rowNumber++;
    }
    html += '</tbody>';
    return html;
  }

  function isNumeric(str) {
    if (!str || str === '') return false;
    const cleaned = String(str).replace(/[,$%]/g, '');
    return !isNaN(cleaned) && !isNaN(parseFloat(cleaned));
  }

  function parseValue(str) {
    if (!str || str === '') return ''; // ç©ºå€¼è¿”å›ç©ºå­—ä¸²
    const cleaned = String(str).replace(/[,$%]/g, '');
    return isNumeric(str) ? parseFloat(cleaned) : String(str).toLowerCase(); // æ•¸å€¼è¿”å›æ•¸å­—ï¼Œæ–‡å­—è¿”å›å°å¯«å­—ä¸²
  }

  function sortTable(columnIndex) {
    console.log('=== sortTable èª¿ç”¨é–‹å§‹ ===');
    console.log('é»æ“Šæ¬„ä½ index:', columnIndex);
    console.log('currentData exists:', !!currentData);
    console.log('currentData length:', currentData ? currentData.length : 0);
    
    if (!currentData || currentData.length <= 1) {
      console.log('No data to sort');
      return;
    }
    
    const header = currentData[0];
    const columnName = header[columnIndex];
    console.log('æ¬„ä½åç¨±:', columnName);
    console.log('ç›®å‰å¯æ’åºæ¬„ä½:', ['æ´»å‹•åç¨±', 'èŠ±è²»é‡‘é¡', 'é»æ“Šæˆæœ¬', 'ç§è¨Šæˆæœ¬']);
    
    // å®šç¾©å¯æ’åºçš„æ¬„ä½
    const sortableColumns = ['æ´»å‹•åç¨±', 'èŠ±è²»é‡‘é¡', 'é»æ“Šæˆæœ¬', 'ç§è¨Šæˆæœ¬'];
    if (!sortableColumns.includes(columnName)) {
      console.log('Column not sortable:', columnName);
      return;
    }
    
    console.log('Starting sort for:', columnName);
    
    // åˆ‡æ›æ’åºæ–¹å‘
    if (currentSort.column === columnIndex) {
      currentSort.ascending = !currentSort.ascending;
    } else {
      currentSort.column = columnIndex;
      currentSort.ascending = true;
    }
    
    // æ¯æ¬¡éƒ½ä½¿ç”¨åŸå§‹è³‡æ–™é€²è¡Œæ’åºï¼Œç¢ºä¿å„æ¬„ä½æ’åºç¨ç«‹
    // ä½¿ç”¨æ·±æ‹·è²ç¢ºä¿ä¸æœƒå½±éŸ¿åŸå§‹è³‡æ–™
    let body = JSON.parse(JSON.stringify(currentData.slice(1)));
    
    // è‡ªæˆ‘é©—è­‰ï¼šè¨˜éŒ„æ’åºå‰çš„è³‡æ–™ç‹€æ…‹
    // console.log(`é–‹å§‹æ’åº ${columnName}ï¼Œæ’åºå‰è³‡æ–™è¡Œæ•¸: ${body.length}`);
    
    // éæ¿¾æ‰ç©ºè¡Œ
    body = body.filter(row => !row.every(v => String(v || '').trim() === ''));
    
    // æ’åºï¼ˆèª¿æ•´ç´¢å¼•ï¼Œå› ç‚ºå¯¦éš›è³‡æ–™æ¯”é¡¯ç¤ºå°‘å››æ¬„ï¼šNo.ã€%ã€é‡‘é¡+%ã€æ“ä½œï¼‰
    body.sort((a, b) => {
      let dataColumnIndex = columnIndex - 1; // æ¸›å» No. æ¬„ä½
      
      // å¦‚æœæ˜¯ç™¾åˆ†æ¯”æ¬„ä½ä¹‹å¾Œçš„æ¬„ä½ï¼Œéœ€è¦å†æ¸›å»2ï¼ˆ% å’Œ é‡‘é¡+% æ¬„ä½ï¼‰
      if (columnIndex > 6) {
        dataColumnIndex = columnIndex - 3; // æ¸›å» No.ã€%ã€é‡‘é¡+% æ¬„ä½
      }
      
      // ç¢ºä¿ç´¢å¼•ä¸è¶…å‡ºç¯„åœ
      if (dataColumnIndex < 0 || dataColumnIndex >= a.length) {
        return 0;
      }
      
      const aVal = parseValue(a[dataColumnIndex]);
      const bVal = parseValue(b[dataColumnIndex]);
      
      // æ ¹æ“šè³‡æ–™é¡å‹é€²è¡Œä¸åŒçš„æ¯”è¼ƒ
      let result;
      if (typeof aVal === 'number' && typeof bVal === 'number') {
        // æ•¸å€¼æ¯”è¼ƒ
        result = aVal - bVal;
      } else {
        // æ–‡å­—æ¯”è¼ƒï¼ˆæ”¯æ´ä¸­æ–‡ç­†ç•«æ’åºï¼‰
        result = String(aVal).localeCompare(String(bVal), 'zh-TW', { 
          numeric: true, 
          sensitivity: 'base' 
        });
      }
      
      return currentSort.ascending ? result : -result;
    });
    
    // è‡ªæˆ‘é©—è­‰ï¼šè¨˜éŒ„æ’åºå¾Œçš„è³‡æ–™ç‹€æ…‹
    // console.log(`æ’åºå®Œæˆ ${columnName}ï¼Œæ’åºå¾Œè³‡æ–™è¡Œæ•¸: ${body.length}`);
    
    // è¨˜ä½ç•¶å‰é é¢æ»¾å‹•ä½ç½®
    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    // é‡æ–°çµ„åˆè³‡æ–™ä¸¦æ¸²æŸ“ï¼ˆä¿æŒè³‡è¨Šæ–‡å­—ï¼‰
    const sortedMatrix = [header, ...body];
    
    // ä¿æŒåŸæœ‰çš„è³‡è¨Šæ–‡å­—
    const currentInfoText = tableInfoEl ? tableInfoEl.textContent : '';
    
    // æ¸²æŸ“æ’åºå¾Œçš„è³‡æ–™
    mainTable.innerHTML = buildTableHtml(sortedMatrix);
    
    // ğŸ”¥ é—œéµä¿®æ­£ï¼šåŒæ­¥æ›´æ–° currentData
    currentData = sortedMatrix;
    console.log('currentData å·²æ›´æ–°ï¼Œæ–°é•·åº¦:', currentData.length);
    console.log('=== sortTable èª¿ç”¨å®Œæˆ ===');
    
    // æ¢å¾©è³‡è¨Šæ–‡å­—
    if (tableInfoEl && currentInfoText) {
      tableInfoEl.textContent = currentInfoText;
    }
    
    // æ›´æ–°å„€è¡¨æ¿ï¼ˆå»¶é²åŸ·è¡Œç¢ºä¿DOMå·²æ›´æ–°ï¼‰
    setTimeout(updateDashboard, 0);
    
    // æ¢å¾©é é¢æ»¾å‹•ä½ç½®
    setTimeout(() => {
      window.scrollTo(0, Math.max(0, currentScrollTop));
    }, 0);
  }

  // æ¸¬è©¦æ’åºåŠŸèƒ½
  function testSortFunction() {
    console.log('=== æ¸¬è©¦æ’åºåŠŸèƒ½ ===');
    console.log('currentData:', currentData);
    console.log('sortTable å‡½æ•¸:', typeof sortTable);
    
    if (currentData && currentData.length > 1) {
      const header = currentData[0];
      console.log('è¡¨é ­:', header);
      
      // æ¸¬è©¦é»æ“Šæ´»å‹•åç¨±æ’åº
      const nameIndex = header.indexOf('æ´»å‹•åç¨±');
      if (nameIndex >= 0) {
        console.log(`æ´»å‹•åç¨±ç´¢å¼•: ${nameIndex}`);
        console.log('å˜—è©¦èª¿ç”¨ sortTable...');
        sortTable(nameIndex);
      }
    }
    
    console.log('=== æ¸¬è©¦å®Œæˆ ===');
  }
  
  // å°‡å‡½å¼æ›åˆ°å…¨åŸŸ
  window.sortTable = sortTable;
  window.testSortFunction = testSortFunction;
  
  // å–å¾—ç•¶å‰å·¥ä½œè¡¨åç¨±
  function getCurrentSheetName() {
    const activeTab = document.querySelector('#sheet-tabs button[aria-selected="true"]');
    return activeTab ? activeTab.getAttribute('data-sheet') : 'default';
  }
  
  // å„²å­˜ç™¾åˆ†æ¯”ä¸¦æ›´æ–°è¨ˆç®—é‡‘é¡
  function saveAndUpdatePercentage(input, originalAmount) {
    const percentage = parseFloat(input.value) || 0;
    const rowId = input.getAttribute('data-row-id');
    const sheetName = input.getAttribute('data-sheet');
    const row = input.getAttribute('data-row');
    
    // å„²å­˜ç™¾åˆ†æ¯”åˆ°å‰ç«¯å„²å­˜
    if (!percentageStorage[sheetName]) {
      percentageStorage[sheetName] = {};
    }
    
    // å…è¨± 0% æˆ–ç©ºå€¼ï¼Œç©ºå€¼æ™‚ä½¿ç”¨ 5%ï¼Œç”¨æˆ¶æ˜ç¢ºè¼¸å…¥ 0 æ™‚ä¹Ÿä¿æŒ 0%
        const finalPercentage = (input.value.trim() === '' || isNaN(percentage)) ? 0 : percentage;
    percentageStorage[sheetName][rowId] = finalPercentage;
    
    // æ›´æ–°è¨ˆç®—é‡‘é¡é¡¯ç¤ºï¼ˆä½¿ç”¨ç„¡æ¢ä»¶é€²ä½ï¼‰
    const calculatedAmount = Math.ceil(originalAmount * (1 + finalPercentage / 100));
    const calculatedCell = document.querySelector(`td.calculated-amount[data-row="${row}"]`);
    
    if (calculatedCell) {
      if (originalAmount > 0) {
        calculatedCell.textContent = calculatedAmount.toLocaleString('zh-TW', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        });
      } else {
        calculatedCell.textContent = '-';
      }
    }
    
    // å„²å­˜åˆ° localStorage
    try {
      localStorage.setItem('adManagerPercentages', JSON.stringify(percentageStorage));
    } catch (e) {
      console.warn('ç„¡æ³•å„²å­˜ç™¾åˆ†æ¯”åˆ° localStorage:', e);
    }
    
    // ç«‹å³æ›´æ–°å„€è¡¨æ¿çµ±è¨ˆ
    updateDashboard();
    
    // æ›´æ–°åˆ†é çµ±è¨ˆæ•¸æ“šï¼ˆä½¿ç”¨å·²å¿«å–çš„è³‡æ–™ï¼‰
    setTimeout(() => {
      try {
        const wb = workbookCache;
        if (wb) {
          const currentSheet = getCurrentSheetName();
          // åªæ›´æ–°çµ±è¨ˆæ•¸æ“šï¼Œä¸é‡æ–°è¼‰å…¥
          updateTabStatistics(wb, currentSheet);
        }
      } catch (e) {
        console.warn('ç„¡æ³•æ›´æ–°åˆ†é çµ±è¨ˆ:', e);
      }
    }, 100);
  }
  
  // å¾ localStorage è¼‰å…¥ç™¾åˆ†æ¯”è³‡æ–™
  function loadPercentageStorage() {
    try {
      const stored = localStorage.getItem('adManagerPercentages');
      if (stored) {
        percentageStorage = JSON.parse(stored);
      }
    } catch (e) {
      console.warn('ç„¡æ³•å¾ localStorage è¼‰å…¥ç™¾åˆ†æ¯”è³‡æ–™:', e);
      percentageStorage = {};
    }
  }
  
  // å¾ localStorage è¼‰å…¥æš±ç¨±è³‡æ–™
  function loadNicknameStorage() {
    try {
      const stored = localStorage.getItem('adManagerNicknames');
      if (stored) {
        nicknameStorage = JSON.parse(stored);
      }
    } catch (e) {
      console.warn('ç„¡æ³•å¾ localStorage è¼‰å…¥æš±ç¨±è³‡æ–™:', e);
      nicknameStorage = {};
    }
  }
  
  // å„²å­˜æš±ç¨±åˆ° localStorage
  function saveNicknameStorage() {
    try {
      localStorage.setItem('adManagerNicknames', JSON.stringify(nicknameStorage));
    } catch (e) {
      console.warn('ç„¡æ³•å„²å­˜æš±ç¨±åˆ° localStorage:', e);
    }
  }
  
  // åªæ›´æ–°åˆ†é çµ±è¨ˆæ•¸æ“šï¼Œä¸é‡æ–°è¼‰å…¥
  function updateTabStatistics(wb, activeName) {
    if (!wb || !wb.SheetNames) return;
    
    // ç¸½è¨ˆçµ±è¨ˆ
    let totalAccountsCount = 0;
    let grandTotalSpend = 0;
    let grandTotalSpendPlus = 0;
    
    // ç‚ºæ¯å€‹å·¥ä½œè¡¨è¨ˆç®—çµ±è¨ˆ
    for (const name of wb.SheetNames) {
      const matrix = getSheetMatrix(wb, name);
      let sheetRows = 0;
      let sheetTotalSpend = 0;
      let sheetTotalSpendPlus = 0;
      
      if (matrix && matrix.length > 0) {
        // æ‰¾åˆ°è¡¨é ­è¡Œ
        let bodyStart = 0;
        let spendColumnIndex = -1;
        
        for (let i = 0; i < matrix.length; i++) {
          const row = matrix[i];
          if (row && (String(row[0]).includes('æ´»å‹•åç¨±') || String(row[0]).trim() === 'æ´»å‹•åç¨±' || String(row[0]).includes('Campaign name'))) {
            // æ‰¾åˆ°èŠ±è²»é‡‘é¡æ¬„ä½çš„ç´¢å¼•
            for (let j = 0; j < row.length; j++) {
              if (String(row[j]).includes('èŠ±è²»é‡‘é¡') || String(row[j]).includes('Amount spent')) {
                spendColumnIndex = j;
                break;
              }
            }
            bodyStart = i + 1;
            break;
          }
        }
        
        // å¦‚æœæ‰¾ä¸åˆ°èŠ±è²»æ¬„ä½ï¼Œå‡è¨­æ˜¯ç¬¬4å€‹æ¬„ä½ï¼ˆç´¢å¼•3ï¼‰
        if (spendColumnIndex === -1) {
          spendColumnIndex = 3;
        }
        
        // è¨ˆç®—æœ‰æ•ˆè³‡æ–™è¡Œæ•¸å’Œé‡‘é¡çµ±è¨ˆ
        for (let i = bodyStart; i < matrix.length; i++) {
          const row = matrix[i];
          if (row && !row.every(v => String(v || '').trim() === '') && String(row[0] || '').trim() !== '') {
            sheetRows++;
            
            // è¨ˆç®—è©²è¡Œçš„èŠ±è²»é‡‘é¡
            if (spendColumnIndex >= 0 && row[spendColumnIndex]) {
              const spendText = String(row[spendColumnIndex] || '').trim();
              const spend = parseFloat(spendText.replace(/[,$]/g, '')) || 0;
              if (!isNaN(spend) && spend >= 0) {
                sheetTotalSpend += spend;
                
                // è¨ˆç®—è©²è¡Œçš„èŠ±è²»+%é‡‘é¡
                const campaignName = row[0] || '';
                const rowId = `${campaignName}`;
                const savedPercentage = (percentageStorage[name] && percentageStorage[name][rowId] !== undefined) ? percentageStorage[name][rowId] : 5;
                
                // ä½¿ç”¨å„²å­˜çš„ç™¾åˆ†æ¯”è¨ˆç®—èŠ±è²»+%ï¼ˆé è¨­5%ï¼‰
                const spendPlusAmount = Math.ceil(spend * (1 + parseFloat(savedPercentage) / 100));
                sheetTotalSpendPlus += spendPlusAmount;
              }
            }
          }
        }
      }
      
      // ç´¯åŠ åˆ°ç¸½è¨ˆä¸­
      if (sheetRows > 0) {
        totalAccountsCount++;
        grandTotalSpend += sheetTotalSpend;
        grandTotalSpendPlus += sheetTotalSpendPlus;
      }
      
      // æ›´æ–°è©²åˆ†é çš„çµ±è¨ˆé¡¯ç¤º
      const tabButton = document.querySelector(`button[data-sheet="${name}"]`);
      if (tabButton) {
        const gridDiv = tabButton.querySelector('.grid');
        if (gridDiv) {
          const cells = gridDiv.querySelectorAll('div');
          if (cells.length >= 4) {
            cells[1].textContent = sheetRows; // æ•¸é‡
            cells[2].textContent = sheetTotalSpend.toLocaleString(); // èŠ±è²»
            cells[3].textContent = sheetTotalSpendPlus.toLocaleString(); // èŠ±è²»+%
          }
        }
      }
    }
    
    // æ›´æ–°ç¸½è¨ˆå¡ç‰‡
    if (totalAccountsEl) {
      totalAccountsEl.textContent = totalAccountsCount;
    }
    if (allTotalSpendEl) {
      allTotalSpendEl.textContent = grandTotalSpend > 0 ? grandTotalSpend.toLocaleString() : '-';
    }
    if (allTotalPercentageEl) {
      // è¨ˆç®—å·®è·ï¼šç¸½èŠ±è²»+% - ç¸½èŠ±è²»
      const difference = grandTotalSpendPlus - grandTotalSpend;
      allTotalPercentageEl.textContent = difference > 0 ? difference.toLocaleString() : '-';
    }
    if (allTotalSpendPlusEl) {
      allTotalSpendPlusEl.textContent = grandTotalSpendPlus > 0 ? grandTotalSpendPlus.toLocaleString() : '-';
    }
  }

  // ç·¨è¼¯æ´»å‹•åç¨±æš±ç¨±
  function editCampaignName(cell, originalName) {
    const currentSheet = getCurrentSheetName();
    const currentNickname = (nicknameStorage[currentSheet] && nicknameStorage[currentSheet][originalName]) || '';
    
    // å‰µå»ºè¼¸å…¥æ¡†
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentNickname || originalName;
    input.className = 'w-full px-1 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500';
    input.placeholder = 'è¼¸å…¥æš±ç¨±';
    
    // å‰µå»ºæŒ‰éˆ•å®¹å™¨
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'flex gap-1 mt-1';
    
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'å„²å­˜';
    saveBtn.className = 'px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'å–æ¶ˆ';
    cancelBtn.className = 'px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600';
    
    // å„²å­˜åŠŸèƒ½
    saveBtn.onclick = () => {
      const newNickname = input.value.trim();
      
      // å„²å­˜åˆ°å‰ç«¯å„²å­˜
      if (!nicknameStorage[currentSheet]) {
        nicknameStorage[currentSheet] = {};
      }
      
      if (newNickname && newNickname !== originalName) {
        nicknameStorage[currentSheet][originalName] = newNickname;
      } else {
        delete nicknameStorage[currentSheet][originalName];
      }
      
      // å„²å­˜åˆ° localStorage
      saveNicknameStorage();
      
      // æ›´æ–°é¡¯ç¤º
      updateCampaignNameDisplay(cell, originalName, newNickname);
    };
    
    // å–æ¶ˆåŠŸèƒ½
    cancelBtn.onclick = () => {
      updateCampaignNameDisplay(cell, originalName, currentNickname);
    };
    
    // æŒ‰ Enter å„²å­˜
    input.onkeypress = (e) => {
      if (e.key === 'Enter') {
        saveBtn.click();
      }
    };
    
    // æŒ‰ Escape å–æ¶ˆ
    input.onkeydown = (e) => {
      if (e.key === 'Escape') {
        cancelBtn.click();
      }
    };
    
    buttonContainer.appendChild(saveBtn);
    buttonContainer.appendChild(cancelBtn);
    
    // æ›¿æ›å…§å®¹
    cell.innerHTML = '';
    cell.appendChild(input);
    cell.appendChild(buttonContainer);
    
    // èšç„¦åˆ°è¼¸å…¥æ¡†
    input.focus();
    input.select();
  }
  
  // æ›´æ–°æ´»å‹•åç¨±é¡¯ç¤º
  function updateCampaignNameDisplay(cell, originalName, nickname) {
    const currentSheet = getCurrentSheetName();
    const displayName = nickname || originalName;
    const hasNickname = nickname && nickname !== originalName;
    
    cell.innerHTML = `
      <div class="flex items-center justify-between group">
        <span class="text-slate-700 text-xs ${hasNickname ? 'font-medium' : ''}">${escapeHtml(displayName)}</span>
        <button onclick="editCampaignName(this.parentElement.parentElement, '${escapeHtml(originalName)}')" 
                class="opacity-0 group-hover:opacity-100 transition-opacity p-1 text-slate-400 hover:text-slate-600">
          <span class="material-symbols-outlined text-sm">edit</span>
        </button>
      </div>
    `;
  }
  
  // ä¸‹è¼‰è¡¨æ ¼è³‡æ–™
  function downloadTableData() {
    const currentSheet = getCurrentSheetName();
    const tableRows = mainTable.querySelectorAll('tbody tr');
    
    if (!tableRows || tableRows.length === 0) {
      alert('æ²’æœ‰è³‡æ–™å¯ä»¥ä¸‹è¼‰');
      return;
    }
    
    // ç²å–è¡¨é ­
    const headerCells = mainTable.querySelectorAll('thead th');
    const headers = Array.from(headerCells).map(th => th.textContent.trim().replace('â‡…', '').replace('â–²', '').replace('â–¼', '').trim());
    
    // æº–å‚™ CSV è³‡æ–™
    const csvData = [];
    csvData.push(headers); // æ·»åŠ è¡¨é ­
    
    // è™•ç†æ¯ä¸€è¡Œè³‡æ–™
    tableRows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length === 0) return;
      
      const rowData = [];
      
      // è™•ç†æ¯å€‹æ¬„ä½
      for (let i = 0; i < cells.length; i++) {
        const cell = cells[i];
        const header = headers[i];
        
        if (header === 'æ´»å‹•åç¨±') {
          // æ´»å‹•åç¨±ï¼šé¡¯ç¤ºæš±ç¨±æˆ–åŸå§‹åç¨±
          const span = cell.querySelector('span');
          const displayName = span ? span.textContent.trim() : cell.textContent.trim();
          rowData.push(`"${displayName}"`);
        } else if (header === '%') {
          // ç™¾åˆ†æ¯”ï¼šå¾è¼¸å…¥æ¡†ç²å–å€¼
          const input = cell.querySelector('input');
          const percentage = input ? input.value : '';
          rowData.push(percentage || '');
        } else if (header === 'é‡‘é¡+%') {
          // é‡‘é¡+%ï¼šé¡¯ç¤ºè¨ˆç®—å¾Œçš„é‡‘é¡
          const amount = cell.textContent.trim();
          rowData.push(amount === '-' ? '' : amount.replace(/,/g, ''));
        } else {
          // å…¶ä»–æ¬„ä½ï¼šç›´æ¥å–æ–‡å­—å…§å®¹
          const text = cell.textContent.trim();
          rowData.push(`"${text}"`);
        }
      }
      
      csvData.push(rowData);
    });
    
    // è½‰æ›ç‚º CSV æ ¼å¼
    const csvContent = csvData.map(row => row.join(',')).join('\n');
    
    // å‰µå»ºä¸¦ä¸‹è¼‰æª”æ¡ˆ
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `å»£å‘Šè³‡æ–™_${currentSheet}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  
  // è¨­å®šå½ˆçª—ç›¸é—œå‡½å¼
  function openSettingsModal() {
    const modal = document.getElementById('settingsModal');
    if (modal) {
      modal.classList.remove('hidden');
      loadSheetConfig();
    }
  }
  
  function closeSettingsModal() {
    const modal = document.getElementById('settingsModal');
    if (modal) {
      modal.classList.add('hidden');
    }
  }
  
  function loadSheetConfig() {
    const configList = document.getElementById('sheetConfigList');
    if (!configList) return;
    
    // å¾ ADDITIONAL_SHEET_GIDS è¼‰å…¥ç¾æœ‰é…ç½®
    let html = '';
    ADDITIONAL_SHEET_GIDS.forEach((sheet, index) => {
      const uniqueId = `sheet-${index}-${Date.now()}`;
      html += `
        <div class="flex items-center gap-3 p-3 rounded-lg" data-sheet-id="${uniqueId}">
          <div class="flex-1 grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">å·¥ä½œè¡¨åç¨±</label>
              <input type="text" 
                     value="${escapeHtml(sheet.name)}" 
                     data-field="name" 
                     class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Grid ID</label>
              <input type="text" 
                     value="${escapeHtml(sheet.gid)}" 
                     data-field="gid" 
                     class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>
          <button onclick="removeSheetConfig('${uniqueId}')" class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors">
            <span class="material-symbols-outlined text-lg">delete</span>
          </button>
        </div>
      `;
    });
    
    configList.innerHTML = html;
  }
  
  function addNewSheet() {
    const configList = document.getElementById('sheetConfigList');
    if (!configList) return;
    
    const uniqueId = `new-sheet-${Date.now()}`;
    const newSheetHtml = `
      <div class="flex items-center gap-3 p-3 rounded-lg bg-blue-50" data-sheet-id="${uniqueId}">
        <div class="flex-1 grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å·¥ä½œè¡¨åç¨±</label>
            <input type="text" 
                   placeholder="è¼¸å…¥å·¥ä½œè¡¨åç¨±" 
                   data-field="name" 
                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Grid ID</label>
            <input type="text" 
                   placeholder="è¼¸å…¥ Grid ID" 
                   data-field="gid" 
                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <button onclick="removeSheetConfig('${uniqueId}')" class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors">
          <span class="material-symbols-outlined text-lg">delete</span>
        </button>
      </div>
    `;
    
    // å°‡æ–°å¢çš„å·¥ä½œè¡¨æ”¾åœ¨æœ€ä¸Šæ–¹
    configList.insertAdjacentHTML('afterbegin', newSheetHtml);
  }
  
  function removeSheetConfig(sheetId) {
    const configList = document.getElementById('sheetConfigList');
    if (!configList) return;
    
    // ä½¿ç”¨å”¯ä¸€ ID ä¾†ç²¾ç¢ºæ‰¾åˆ°è¦åˆªé™¤çš„é …ç›®
    const targetElement = configList.querySelector(`[data-sheet-id="${sheetId}"]`);
    if (targetElement) {
      targetElement.remove();
    }
  }
  
  function saveSheetConfig() {
    // è¦æ±‚å†æ¬¡è¼¸å…¥å¯†ç¢¼é©—è­‰
    const password = prompt('è«‹è¼¸å…¥å¯†ç¢¼ä»¥å„²å­˜è¨­å®šï¼š');
    if (password !== systemPassword) {
      alert('å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•å„²å­˜è¨­å®š');
      return;
    }
    
    const configList = document.getElementById('sheetConfigList');
    if (!configList) return;
    
    const newConfig = [];
    const items = configList.children;
    
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      const nameInput = item.querySelector('input[data-field="name"]');
      const gidInput = item.querySelector('input[data-field="gid"]');
      
      if (nameInput && gidInput) {
        const name = nameInput.value.trim();
        const gid = gidInput.value.trim();
        
        if (name && gid) {
          newConfig.push({ name, gid });
        }
      }
    }
    
    // æ›´æ–° ADDITIONAL_SHEET_GIDS
    ADDITIONAL_SHEET_GIDS.length = 0;
    ADDITIONAL_SHEET_GIDS.push(...newConfig);
    
    // å„²å­˜åˆ° localStorage
    try {
      localStorage.setItem('adManagerSheetConfig', JSON.stringify(newConfig));
    } catch (e) {
      console.warn('ç„¡æ³•å„²å­˜å·¥ä½œè¡¨é…ç½®:', e);
    }
    
    // é—œé–‰å½ˆçª—
    closeSettingsModal();
    
    // é‡æ–°è¼‰å…¥è³‡æ–™
    if (confirm('è¨­å®šå·²å„²å­˜ï¼Œæ˜¯å¦é‡æ–°è¼‰å…¥è³‡æ–™ï¼Ÿ')) {
      location.reload();
    }
  }
  
  // è¼‰å…¥å„²å­˜çš„å·¥ä½œè¡¨é…ç½®
  function loadStoredSheetConfig() {
    try {
      const stored = localStorage.getItem('adManagerSheetConfig');
      if (stored) {
        const config = JSON.parse(stored);
        ADDITIONAL_SHEET_GIDS.length = 0;
        ADDITIONAL_SHEET_GIDS.push(...config);
      }
    } catch (e) {
      console.warn('ç„¡æ³•è¼‰å…¥å·¥ä½œè¡¨é…ç½®:', e);
    }
  }
  
  // é‡æ–°è¼‰å…¥è³‡æ–™åŠŸèƒ½
  async function refreshData() {
    const refreshBtn = document.getElementById('refresh-btn');
    const refreshIcon = document.getElementById('refresh-icon');
    
    if (!refreshBtn || !refreshIcon) return;
    
    // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    refreshBtn.disabled = true;
    refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
    refreshIcon.classList.add('animate-spin');
    
    try {
      // é‡æ–°è¼‰å…¥è³‡æ–™ï¼ˆæ¯æ¬¡éƒ½å¾ Google Sheets ç²å–æœ€æ–°è³‡æ–™ï¼‰
      setStatus('æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...');
      const wb = await loadWorkbook();
      const names = wb.SheetNames || [];
      
      if (!names.length) { 
        setStatus('æ²’æœ‰å¯ç”¨çš„å·¥ä½œè¡¨', true); 
        return; 
      }
      
      // é‡æ–°æ¸²æŸ“åˆ†é 
      const firstSheet = names[0];
      await renderTabs(names, firstSheet);
      
      // è¼‰å…¥ç¬¬ä¸€å€‹å·¥ä½œè¡¨è³‡æ–™
      const matrix = getSheetMatrix(wb, firstSheet);
      renderTable(matrix);
      setStatus('è³‡æ–™å·²æ›´æ–°');
      
      // çŸ­æš«é¡¯ç¤ºæˆåŠŸè¨Šæ¯å¾Œæ¸…é™¤
      setTimeout(() => {
        setStatus('');
      }, 2000);
      
    } catch (err) {
      console.error('é‡æ–°è¼‰å…¥è³‡æ–™å¤±æ•—:', err);
      setStatus(`é‡æ–°è¼‰å…¥å¤±æ•—: ${err.message}`, true);
    } finally {
      // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
      refreshBtn.disabled = false;
      refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      refreshIcon.classList.remove('animate-spin');
    }
  }

  // æˆæœ¬æŒ‡æ¨™ç›¸é—œå‡½æ•¸
  
  // å–å¾—é»æ“Šæˆæœ¬é¡è‰²é¡åˆ¥
  function getClickCostColorClass(costValue) {
    const currentSheet = getCurrentSheetName();
    const sheetSettings = costIndicatorSettings[currentSheet];
    
    if (!sheetSettings || !sheetSettings.clickCost || !sheetSettings.clickCost.enabled) return '';
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å€¼ï¼ˆéç©ºã€éé›¶ã€éè² æ•¸ï¼‰
    if (!costValue || costValue === 0 || costValue === '' || isNaN(costValue)) {
      return '';
    }
    
    const { green, red } = sheetSettings.clickCost;
    
    if (costValue <= green) {
      return 'bg-green-100 text-green-800 font-medium';
    } else if (costValue >= red) {
      return 'bg-red-100 text-red-800 font-medium';
    } else {
      // ä»‹æ–¼ç¶ è‰²å’Œç´…è‰²ä¹‹é–“
      return 'bg-orange-100 text-orange-800 font-medium';
    }
  }
  
  // å–å¾—ç§è¨Šæˆæœ¬é¡è‰²é¡åˆ¥
  function getMessageCostColorClass(costValue) {
    const currentSheet = getCurrentSheetName();
    const sheetSettings = costIndicatorSettings[currentSheet];
    
    if (!sheetSettings || !sheetSettings.messageCost || !sheetSettings.messageCost.enabled) return '';
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å€¼ï¼ˆéç©ºã€éé›¶ã€éè² æ•¸ï¼‰
    if (!costValue || costValue === 0 || costValue === '' || isNaN(costValue)) {
      return '';
    }
    
    const { green, red } = sheetSettings.messageCost;
    
    if (costValue <= green) {
      return 'bg-green-100 text-green-800 font-medium';
    } else if (costValue >= red) {
      return 'bg-red-100 text-red-800 font-medium';
    } else {
      // ä»‹æ–¼ç¶ è‰²å’Œç´…è‰²ä¹‹é–“
      return 'bg-orange-100 text-orange-800 font-medium';
    }
  }
  
  // é–‹å•Ÿæˆæœ¬æŒ‡æ¨™è¨­å®šå½ˆçª—
  function openCostIndicatorModal(rowNumber) {
    const modal = document.getElementById('costIndicatorModal');
    const currentSheetNameEl = document.getElementById('currentSheetName');
    
    if (modal) {
      // é¡¯ç¤ºç•¶å‰å·¥ä½œè¡¨åç¨±
      const currentSheet = getCurrentSheetName();
      if (currentSheetNameEl) {
        currentSheetNameEl.textContent = currentSheet;
      }
      
      modal.classList.remove('hidden');
      loadCostIndicatorSettings();
    }
  }
  
  // é—œé–‰æˆæœ¬æŒ‡æ¨™è¨­å®šå½ˆçª—
  function closeCostIndicatorModal() {
    const modal = document.getElementById('costIndicatorModal');
    if (modal) {
      modal.classList.add('hidden');
    }
  }
  
  // è¼‰å…¥æˆæœ¬æŒ‡æ¨™è¨­å®šåˆ°è¡¨å–®
  function loadCostIndicatorSettings() {
    const currentSheet = getCurrentSheetName();
    const sheetSettings = costIndicatorSettings[currentSheet] || {
      messageCost: { enabled: false, green: 0, red: 0 },
      clickCost: { enabled: false, green: 0, red: 0 }
    };
    
    // è¼‰å…¥ç§è¨Šæˆæœ¬è¨­å®š
    document.getElementById('enableMessageCost').checked = sheetSettings.messageCost.enabled;
    document.getElementById('messageCostGreen').value = sheetSettings.messageCost.green;
    document.getElementById('messageCostRed').value = sheetSettings.messageCost.red;
    
    // è¼‰å…¥é»æ“Šæˆæœ¬è¨­å®š
    document.getElementById('enableClickCost').checked = sheetSettings.clickCost.enabled;
    document.getElementById('clickCostGreen').value = sheetSettings.clickCost.green;
    document.getElementById('clickCostRed').value = sheetSettings.clickCost.red;
  }
  
  // å„²å­˜æˆæœ¬æŒ‡æ¨™è¨­å®š
  function saveCostIndicatorSettings() {
    const currentSheet = getCurrentSheetName();
    
    // ç¢ºä¿ç•¶å‰å·¥ä½œè¡¨çš„è¨­å®šç‰©ä»¶å­˜åœ¨
    if (!costIndicatorSettings[currentSheet]) {
      costIndicatorSettings[currentSheet] = {
        messageCost: { enabled: false, green: 0, red: 0 },
        clickCost: { enabled: false, green: 0, red: 0 }
      };
    }
    
    // å„²å­˜ç§è¨Šæˆæœ¬è¨­å®š
    costIndicatorSettings[currentSheet].messageCost.enabled = document.getElementById('enableMessageCost').checked;
    costIndicatorSettings[currentSheet].messageCost.green = parseFloat(document.getElementById('messageCostGreen').value) || 0;
    costIndicatorSettings[currentSheet].messageCost.red = parseFloat(document.getElementById('messageCostRed').value) || 0;
    
    // å„²å­˜é»æ“Šæˆæœ¬è¨­å®š
    costIndicatorSettings[currentSheet].clickCost.enabled = document.getElementById('enableClickCost').checked;
    costIndicatorSettings[currentSheet].clickCost.green = parseFloat(document.getElementById('clickCostGreen').value) || 0;
    costIndicatorSettings[currentSheet].clickCost.red = parseFloat(document.getElementById('clickCostRed').value) || 0;
    
    // å„²å­˜åˆ° localStorage
    try {
      localStorage.setItem('adManagerCostIndicatorSettings', JSON.stringify(costIndicatorSettings));
    } catch (e) {
      console.warn('ç„¡æ³•å„²å­˜æˆæœ¬æŒ‡æ¨™è¨­å®š:', e);
    }
    
    // é—œé–‰å½ˆçª—
    closeCostIndicatorModal();
    
    // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥å¥—ç”¨æ–°çš„é¡è‰²è¨­å®š
    if (currentData && currentData.length > 0) {
      mainTable.innerHTML = buildTableHtml(currentData);
      setTimeout(updateDashboard, 0);
    }
  }
  
  // å¾ localStorage è¼‰å…¥æˆæœ¬æŒ‡æ¨™è¨­å®š
  function loadCostIndicatorStorage() {
    try {
      const stored = localStorage.getItem('adManagerCostIndicatorSettings');
      if (stored) {
        costIndicatorSettings = JSON.parse(stored);
      }
    } catch (e) {
      console.warn('ç„¡æ³•å¾ localStorage è¼‰å…¥æˆæœ¬æŒ‡æ¨™è¨­å®š:', e);
      costIndicatorSettings = {};
    }
  }

  // å°‡å‡½å¼æ›åˆ°å…¨åŸŸ
  window.saveAndUpdatePercentage = saveAndUpdatePercentage;
  window.getCurrentSheetName = getCurrentSheetName;
  window.editCampaignName = editCampaignName;
  window.downloadTableData = downloadTableData;
  window.openSettingsModal = openSettingsModal;
  window.closeSettingsModal = closeSettingsModal;
  window.addNewSheet = addNewSheet;
  window.removeSheetConfig = removeSheetConfig;
  window.saveSheetConfig = saveSheetConfig;
  window.refreshData = refreshData;
  window.openCostIndicatorModal = openCostIndicatorModal;
  window.closeCostIndicatorModal = closeCostIndicatorModal;
  window.saveCostIndicatorSettings = saveCostIndicatorSettings;
  window.getClickCostColorClass = getClickCostColorClass;
  window.getMessageCostColorClass = getMessageCostColorClass;

  // å¯†ç¢¼ç›¸é—œè®Šæ•¸
  let systemPassword = null;
  let isAuthenticated = false;

  // è¼‰å…¥å¯†ç¢¼è¨­å®š
  function loadPassword() {
    try {
      const saved = localStorage.getItem('systemPassword');
      if (saved) {
        systemPassword = saved;
      } else {
        // å¦‚æœæ²’æœ‰å„²å­˜çš„å¯†ç¢¼ï¼Œè¨­å®šé è¨­å¯†ç¢¼ç‚º 1982
        systemPassword = '1982';
        savePasswordToStorage('1982');
      }
    } catch (e) {
      console.warn('ç„¡æ³•è¼‰å…¥å¯†ç¢¼è¨­å®š:', e);
      // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å¯†ç¢¼
      systemPassword = '1982';
    }
  }

  // å„²å­˜å¯†ç¢¼è¨­å®š
  function savePasswordToStorage(password) {
    try {
      localStorage.setItem('systemPassword', password);
      systemPassword = password;
    } catch (e) {
      console.warn('ç„¡æ³•å„²å­˜å¯†ç¢¼è¨­å®š:', e);
    }
  }

  // é¡¯ç¤ºå¯†ç¢¼é©—è­‰å½ˆçª—
  function showPasswordModal() {
    const modal = document.getElementById('passwordModal');
    const input = document.getElementById('passwordInput');
    const error = document.getElementById('passwordError');
    
    modal.classList.remove('hidden');
    input.value = '';
    input.focus();
    error.classList.add('hidden');
    
    // å¦‚æœæ²’æœ‰è¨­å®šå¯†ç¢¼ï¼Œç›´æ¥é¡¯ç¤ºè¨­å®šå¯†ç¢¼å½ˆçª—
    if (!systemPassword) {
      showPasswordSettings();
      return;
    }
  }

  // éš±è—å¯†ç¢¼é©—è­‰å½ˆçª—
  function hidePasswordModal() {
    const modal = document.getElementById('passwordModal');
    modal.classList.add('hidden');
  }

  // é©—è­‰å¯†ç¢¼
  function verifyPassword() {
    const input = document.getElementById('passwordInput');
    const error = document.getElementById('passwordError');
    const password = input.value.trim();
    
    if (password.length !== 4) {
      error.textContent = 'è«‹è¼¸å…¥å››ä½æ•¸å¯†ç¢¼';
      error.classList.remove('hidden');
      return;
    }
    
    if (password === systemPassword) {
      isAuthenticated = true;
      hidePasswordModal();
      setStatus(`è³‡æ–™è¼‰å…¥æˆåŠŸ (${workbookCache ? workbookCache.SheetNames.length : 0} å€‹å·¥ä½œè¡¨)`);
    } else {
      error.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥';
      error.classList.remove('hidden');
      input.value = '';
      input.focus();
    }
  }


  // å¯†ç¢¼è¼¸å…¥æ¡†éµç›¤äº‹ä»¶
  function setupPasswordInputEvents() {
    const passwordInput = document.getElementById('passwordInput');
    
    if (passwordInput) {
      passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          verifyPassword();
        }
      });
    }
  }

  
  // ç‰ˆæœ¬ç®¡ç†ç›¸é—œå‡½å¼
  // æ‰‹å‹•è¨­å®šçš„ç‰ˆæœ¬è™Ÿ - æ¯æ¬¡ç¨‹å¼ç¢¼æ”¹å‹•æ™‚éœ€è¦æ‰‹å‹•æ›´æ–°
  const APP_VERSION = '20250915170325';
  
  function updateVersionDisplay() {
    const versionEl = document.getElementById('version-display');
    if (versionEl) {
      versionEl.textContent = `v${APP_VERSION}`;
    }
  }
  
  // ç”Ÿæˆæ–°ç‰ˆæœ¬è™Ÿçš„è¼”åŠ©å‡½å¼ï¼ˆä¾›é–‹ç™¼è€…ä½¿ç”¨ï¼‰
  function generateNewVersion() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    
    return `${year}${month}${day}${hours}${minutes}${seconds}`;
  }
  
  // å°‡å¯†ç¢¼ç›¸é—œå‡½æ•¸æ›åˆ°å…¨åŸŸ
  window.verifyPassword = verifyPassword;
  window.updateVersionDisplay = updateVersionDisplay;
  window.generateNewVersion = generateNewVersion;


  async function loadWorkbook() {
    // é¡¯ç¤ºè¼‰å…¥å½ˆçª—
    showLoadingModal();
    updateLoadingProgress(0, 'æ­£åœ¨è¼‰å…¥ Google Sheets è³‡æ–™...');
    
    const HTMLSheets = {};
    const SheetNames = [];
    
    try {
      // ç›´æ¥è¼‰å…¥é…ç½®çš„å·¥ä½œè¡¨ï¼Œä¸è¼‰å…¥ä¸»è¦å·¥ä½œè¡¨
      if (ADDITIONAL_SHEET_GIDS.length === 0) {
        throw new Error('æ²’æœ‰é…ç½®ä»»ä½•å·¥ä½œè¡¨');
      }
      
      updateLoadingProgress(10, `æ­£åœ¨ä¸¦è¡Œè¼‰å…¥ ${ADDITIONAL_SHEET_GIDS.length} å€‹å·¥ä½œè¡¨...`);
      
      // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰å·¥ä½œè¡¨
      const loadPromises = ADDITIONAL_SHEET_GIDS.map(async (sheet, index) => {
        try {
          const csvText = await fetchSheetCSV(sheet.gid);
          if (csvText && !csvText.includes('<!DOCTYPE html>') && !csvText.includes('æ‰¾ä¸åˆ°ç¶²é ')) {
            const csvData = parseCSV(csvText);
            if (csvData.length > 1) { // è‡³å°‘è¦æœ‰è¡¨é ­å’Œä¸€è¡Œè³‡æ–™
              return { name: sheet.name, data: csvData, success: true };
            }
          }
          return { name: sheet.name, data: null, success: false };
        } catch (e) {
          console.warn(`ç„¡æ³•è¼‰å…¥å·¥ä½œè¡¨ ${sheet.name} (gid=${sheet.gid}):`, e.message);
          return { name: sheet.name, data: null, success: false };
        }
      });
      
      // ç­‰å¾…æ‰€æœ‰è¼‰å…¥å®Œæˆï¼Œä¸¦å³æ™‚æ›´æ–°é€²åº¦
      let completedCount = 0;
      const totalSheets = ADDITIONAL_SHEET_GIDS.length;
      
      // ä½¿ç”¨ Promise.allSettled ç­‰å¾…æ‰€æœ‰è«‹æ±‚å®Œæˆ
      const results = await Promise.allSettled(loadPromises);
      
      // è™•ç†çµæœ
      for (const result of results) {
        if (result.status === 'fulfilled' && result.value.success) {
          HTMLSheets[result.value.name] = result.value.data;
          SheetNames.push(result.value.name);
        }
        completedCount++;
        
        // æ›´æ–°é€²åº¦ (10-90%)
        const progress = 10 + (completedCount / totalSheets) * 80;
        updateLoadingProgress(progress, `å·²è¼‰å…¥ ${completedCount}/${totalSheets} å€‹å·¥ä½œè¡¨`);
      }
      
      console.log(`æˆåŠŸè¼‰å…¥ ${SheetNames.length} å€‹å·¥ä½œè¡¨`);
      
      // æ§‹å»ºã€Œä»¿ Workbookã€çµæ§‹ä¾›å¾ŒçºŒæµç¨‹ä½¿ç”¨
      updateLoadingProgress(95, 'æ­£åœ¨è™•ç†è³‡æ–™...');
      const wb = { __CSV__: true, SheetNames, HTMLSheets };
      workbookCache = wb;
      
      updateLoadingProgress(100, 'è¼‰å…¥å®Œæˆï¼');
      setTimeout(() => {
        hideLoadingModal();
        showPasswordModal();
      }, 500);
      
      return wb;
      
    } catch (e) {
      console.error('è¼‰å…¥å·¥ä½œè¡¨å¤±æ•—ï¼š', e);
      hideLoadingModal();
      setStatus(`ğŸš« Google Sheets é€£ç·šå¤±æ•—ï¼š${e.message}ã€‚è«‹æª¢æŸ¥ï¼š1) è©¦ç®—è¡¨æ˜¯å¦å…¬é–‹ 2) ç¶²è·¯é€£ç·šç‹€æ…‹ 3) è©¦ç®—è¡¨é€£çµæ˜¯å¦æ­£ç¢º`, true);
      throw e;
    }
  }
  function getSheetMatrix(workbook, sheetName) {
    // æ”¯æ´ CSV ä»¿ Workbookï¼ˆä¸»è¦ç”¨æ–¼ Google Sheets CSVï¼‰
    if (workbook && (workbook.__CSV__ || workbook.__HTML__)) {
      const aoa = workbook.HTMLSheets[sheetName] || [];
      return aoa;
    }
    
    // å¦‚æœä¸æ˜¯ CSV/HTML æ ¼å¼ä¸”æ²’æœ‰ XLSX å‡½å¼åº«ï¼Œè¿”å›ç©ºé™£åˆ—
    if (typeof XLSX === 'undefined') {
      console.warn('XLSX library not available, only CSV/HTML format supported');
      return [];
    }
    
    // XLSX æ ¼å¼æ”¯æ´ï¼ˆå‚™ç”¨ï¼‰
    const ws = workbook.Sheets[sheetName];
    if (!ws) {
      return [];
    }
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
    return aoa;
  }

  function renderTable(matrix) {
    matrix = trimEmptyEdges(matrix);
    
    // æ¸…ç†å’Œè™•ç†è³‡æ–™çŸ©é™£
    if (matrix && matrix.length > 0) {
      let processedMatrix = [];
      
      for (let i = 0; i < matrix.length; i++) {
        const row = matrix[i];
        
        // è·³éå„ç¨®è³‡è¨Šè¡Œå’Œç©ºè¡Œ
        const firstCell = String(row[0] || '').trim();
        
        // è·³éä»¥ä¸‹é¡å‹çš„è¡Œï¼š
        // 1. Facebook Ads Import è³‡è¨Šè¡Œ
        // 2. Last updated è³‡è¨Šè¡Œ  
        // 3. ç©ºè¡Œæˆ–åªæœ‰ç©ºç™½çš„è¡Œ
        if (firstCell.includes('Facebook Ads Import') ||
            firstCell.includes('Last updated') ||
            firstCell === '' ||
            row.every(cell => String(cell || '').trim() === '')) {
          continue;
        }
        
        // ä¿æŒåŸå§‹è³‡æ–™çµæ§‹ï¼Œç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½è¢«ä¿ç•™
        processedMatrix.push(row);
      }
      
      matrix = processedMatrix;
    }
    
    // å„²å­˜åŸå§‹è³‡æ–™
    originalData = matrix;
    currentData = matrix; // ç¢ºä¿ currentData æ­£ç¢ºè¨­ç½®
    // é‡ç½®æ’åºç‹€æ…‹
    currentSort = { column: -1, ascending: true };
    // é‡ç½®æœå°‹æ¡†
    if (searchInput) searchInput.value = '';
    mainTable.innerHTML = buildTableHtml(matrix);
    // æ›´æ–°å„€è¡¨æ¿ï¼ˆå»¶é²åŸ·è¡Œç¢ºä¿DOMå·²æ›´æ–°ï¼‰
    setTimeout(updateDashboard, 0);
  }


  function filterData(searchTerm) {
    if (!originalData || originalData.length <= 1) return originalData;
    
    if (!searchTerm || searchTerm.trim() === '') {
      return originalData;
    }
    
    const header = originalData[0];
    const body = originalData.slice(1);
    const searchLower = searchTerm.toLowerCase().trim();
    
    // å–®ä¸€å·¥ä½œè¡¨æ ¼å¼ï¼šåªæœå°‹æ´»å‹•åç¨±ï¼ˆç¬¬ä¸€æ¬„ï¼‰
    const filteredBody = body.filter(row => {
      const campaignName = String(row[0] || '').toLowerCase(); // æ´»å‹•åç¨±
      return campaignName.includes(searchLower);
    });
    
    return [header, ...filteredBody];
  }

  function performSearch() {
    if (!searchInput) return;
    
    const searchTerm = searchInput.value;
    const filteredData = filterData(searchTerm);
    
    // ä¿æŒåŸæœ‰çš„è³‡è¨Šæ–‡å­—
    const currentInfoText = tableInfoEl ? tableInfoEl.textContent : '';
    
    // é‡ç½®æ’åºç‹€æ…‹
    currentSort = { column: -1, ascending: true };
    
    // å»ºç«‹è¡¨æ ¼ï¼ˆæœƒè‡ªå‹•ä½¿ç”¨æ­£ç¢ºçš„è¡¨é ­ï¼‰
    mainTable.innerHTML = buildTableHtml(filteredData);
    
    // æ¢å¾©è³‡è¨Šæ–‡å­—
    if (tableInfoEl && currentInfoText) {
      tableInfoEl.textContent = currentInfoText;
    }
    
    // æ›´æ–°å„€è¡¨æ¿ï¼ˆå»¶é²åŸ·è¡Œç¢ºä¿DOMå·²æ›´æ–°ï¼‰
    setTimeout(updateDashboard, 0);
  }


  async function renderTabs(sheetNames, activeName) {
    const parts = [];
    // ä½¿ç”¨å·²å¿«å–çš„ workbookï¼Œé¿å…é‡è¤‡è¼‰å…¥
    const wb = workbookCache || await loadWorkbook();
    
    // ç¸½è¨ˆçµ±è¨ˆ
    let totalAccountsCount = 0;
    let grandTotalSpend = 0;
    let grandTotalSpendPlus = 0;
    
    // ç‚ºæ¯å€‹å·¥ä½œè¡¨è¨ˆç®—è¡Œæ•¸å’Œé‡‘é¡çµ±è¨ˆ
    for (const name of sheetNames) {
      const matrix = getSheetMatrix(wb, name);
      let sheetRows = 0;
      let sheetTotalSpend = 0;
      let sheetTotalSpendPlus = 0;
      
      if (matrix && matrix.length > 0) {
        // æ‰¾åˆ°è¡¨é ­è¡Œ
        let bodyStart = 0;
        let spendColumnIndex = -1;
        
        for (let i = 0; i < matrix.length; i++) {
          const row = matrix[i];
          if (row && (String(row[0]).includes('æ´»å‹•åç¨±') || String(row[0]).trim() === 'æ´»å‹•åç¨±' || String(row[0]).includes('Campaign'))) {
            // æ‰¾åˆ°èŠ±è²»é‡‘é¡æ¬„ä½çš„ç´¢å¼•
            for (let j = 0; j < row.length; j++) {
              if (String(row[j]).includes('èŠ±è²»é‡‘é¡') || String(row[j]).includes('Amount spent')) {
                spendColumnIndex = j;
                break;
              }
            }
            bodyStart = i + 1;
            break;
          }
        }
        
        // å¦‚æœæ‰¾ä¸åˆ°èŠ±è²»æ¬„ä½ï¼Œå‡è¨­æ˜¯ç¬¬4å€‹æ¬„ä½ï¼ˆç´¢å¼•3ï¼‰
        if (spendColumnIndex === -1) {
          spendColumnIndex = 3;
        }
        
        // è¨ˆç®—æœ‰æ•ˆè³‡æ–™è¡Œæ•¸å’Œé‡‘é¡çµ±è¨ˆ
        for (let i = bodyStart; i < matrix.length; i++) {
          const row = matrix[i];
          if (row && !row.every(v => String(v || '').trim() === '') && String(row[0] || '').trim() !== '') {
            sheetRows++;
            
            // è¨ˆç®—è©²è¡Œçš„èŠ±è²»é‡‘é¡
            if (spendColumnIndex >= 0 && row[spendColumnIndex]) {
              const spendText = String(row[spendColumnIndex] || '').trim();
              const spend = parseFloat(spendText.replace(/[,$]/g, '')) || 0;
              if (!isNaN(spend) && spend >= 0) {
                sheetTotalSpend += spend;
                
                // è¨ˆç®—è©²è¡Œçš„èŠ±è²»+%é‡‘é¡
                const campaignName = row[0] || '';
                const rowId = `${campaignName}`;
                const savedPercentage = (percentageStorage[name] && percentageStorage[name][rowId] !== undefined) ? percentageStorage[name][rowId] : 5;
                
                // ä½¿ç”¨å„²å­˜çš„ç™¾åˆ†æ¯”è¨ˆç®—èŠ±è²»+%ï¼ˆé è¨­5%ï¼‰
                const spendPlusAmount = Math.ceil(spend * (1 + parseFloat(savedPercentage) / 100));
                sheetTotalSpendPlus += spendPlusAmount;
              }
            }
          }
        }
      }
      
      // ç´¯åŠ åˆ°ç¸½è¨ˆä¸­
      if (sheetRows > 0) {
        totalAccountsCount++;
        grandTotalSpend += sheetTotalSpend;
        grandTotalSpendPlus += sheetTotalSpendPlus;
      }
      
      const active = String(name) === String(activeName);
      parts.push(
        `<button type="button" data-sheet="${escapeHtml(name)}" aria-selected="${active ? 'true' : 'false'}" class="text-left px-2 py-2 text-xs ${active ? 'bg-blue-50 text-blue-700 border-l-2 border-blue-600' : 'text-slate-700 hover:bg-slate-50'}">
          <div class="grid grid-cols-4 gap-2 items-center w-full">
            <div class="font-medium truncate">${escapeHtml(name)}</div>
            <div class="text-right text-slate-400">${sheetRows}</div>
            <div class="text-right text-slate-400">${sheetTotalSpend.toLocaleString()}</div>
            <div class="text-right text-slate-400">${sheetTotalSpendPlus.toLocaleString()}</div>
          </div>
        </button>`
      );
    }
    tabsContainer.innerHTML = parts.join('');
    Array.from(tabsContainer.querySelectorAll('button[data-sheet]')).forEach((btn) => {
      btn.addEventListener('click', async () => {
        const sheet = btn.getAttribute('data-sheet');
        Array.from(tabsContainer.children).forEach((el) => {
          el.setAttribute('aria-selected', el === btn ? 'true' : 'false');
          el.className = 'text-left px-2 py-2 text-xs ' + (el === btn ? 'bg-blue-50 text-blue-700 border-l-2 border-blue-600' : 'text-slate-700 hover:bg-slate-50');
        });
        try {
          setStatus('åˆ‡æ›å·¥ä½œè¡¨ä¸­...');
          // ä½¿ç”¨å·²å¿«å–çš„ workbookï¼Œé¿å…é‡è¤‡è¼‰å…¥
          const wb = workbookCache;
          if (!wb) {
            setStatus('è³‡æ–™å°šæœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢', true);
            return;
          }
          
          // è¼‰å…¥å–®ä¸€å·¥ä½œè¡¨è³‡æ–™
          const matrix = getSheetMatrix(wb, sheet);
          
          renderTable(matrix);
          
          setStatus('');
        } catch (e) {
          setStatus('è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥æ¬Šé™/é€£ç·šã€‚', true);
        }
      });
    });
    
    // æ›´æ–°ç¸½è¨ˆå¡ç‰‡
    if (totalAccountsEl) {
      totalAccountsEl.textContent = totalAccountsCount;
    }
    if (allTotalSpendEl) {
      allTotalSpendEl.textContent = grandTotalSpend > 0 ? grandTotalSpend.toLocaleString() : '-';
    }
    if (allTotalPercentageEl) {
      // è¨ˆç®—å·®è·ï¼šç¸½èŠ±è²»+% - ç¸½èŠ±è²»
      const difference = grandTotalSpendPlus - grandTotalSpend;
      allTotalPercentageEl.textContent = difference > 0 ? difference.toLocaleString() : '-';
    }
    if (allTotalSpendPlusEl) {
      allTotalSpendPlusEl.textContent = grandTotalSpendPlus > 0 ? grandTotalSpendPlus.toLocaleString() : '-';
    }
  }

  async function init() {
    
    // æ›´æ–°ç‰ˆæœ¬è™Ÿé¡¯ç¤º
    updateVersionDisplay();
    
    // è¼‰å…¥å„²å­˜çš„ç™¾åˆ†æ¯”è³‡æ–™
    loadPercentageStorage();
    
    // è¼‰å…¥å„²å­˜çš„æš±ç¨±è³‡æ–™
    loadNicknameStorage();
    
    // è¼‰å…¥å„²å­˜çš„å·¥ä½œè¡¨é…ç½®
    loadStoredSheetConfig();
    
    // è¼‰å…¥æˆæœ¬æŒ‡æ¨™è¨­å®š
    loadCostIndicatorStorage();
    
    // è¼‰å…¥å¯†ç¢¼è¨­å®š
    loadPassword();
    
    // è¨­ç½®å¯†ç¢¼è¼¸å…¥æ¡†äº‹ä»¶
    setupPasswordInputEvents();
    
    try {
      setStatus('è¼‰å…¥è©¦ç®—è¡¨èˆ‡å·¥ä½œè¡¨ä¸­...');
      const wb = await loadWorkbook();
      const names = wb.SheetNames || [];
      if (!names.length) { 
        setStatus('æ²’æœ‰å¯ç”¨çš„å·¥ä½œè¡¨', true); 
        return; 
      }
      
      // æ¸²æŸ“åˆ†é ä¸¦è¨­å®šç¬¬ä¸€å€‹å·¥ä½œè¡¨ç‚º active
      const firstSheet = names[0];
      await renderTabs(names, firstSheet);
      
      // è¼‰å…¥ç¬¬ä¸€å€‹å·¥ä½œè¡¨è³‡æ–™
      const matrix = getSheetMatrix(wb, firstSheet);
      renderTable(matrix);
      setStatus('');
    } catch (err) {
      setStatus(`ç„¡æ³•è¼‰å…¥ Google Sheets è³‡æ–™: ${err.message}`, true);
    }
  }

  function setupSearch() {
    if (searchInput) {
      searchInput.addEventListener('input', performSearch);
      searchInput.addEventListener('keyup', performSearch);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      init();
      setupSearch();
    });
  } else {
    init();
    setupSearch();
  }
})();
</script>
</div>
</div>
</body></html>
</body></html>